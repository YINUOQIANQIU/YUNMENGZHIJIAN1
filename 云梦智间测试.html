<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç»´èƒ½åŠ›è¯„ä¼°æµ‹è¯• - äº‘æ¢¦æ™ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="js/assessment-utils.js"></script>
    <script src="js/ai-learning-analysis.js"></script>
    <!-- æ·»åŠ æ–°çš„åˆ†ææµç¨‹JS -->
    <script src="js/test-analysis-flow.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        .exam-type-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .exam-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .exam-type-card.selected {
            border-width: 3px;
            transform: scale(1.02);
        }
        .test-container {
            transition: all 0.3s ease;
        }
        .question-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
        }
        .option-card {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .option-card:hover {
            border-color: #2962FF;
            transform: translateY(-2px);
        }
        .option-card.selected {
            border-color: #2962FF;
            background-color: #2962FF;
            color: white;
        }
        .dimension-progress.active {
            background-color: #2962FF;
            color: white;
        }
        .test-timer.warning {
            background-color: #EF4444;
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* è°ƒè¯•æ ·å¼ */
        .debug-border {
            border: 2px solid red !important;
        }
        .question-loaded {
            border-left: 4px solid #10B981 !important;
        }
        .option-selected {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        /* åŠ è½½çŠ¶æ€ */
        .loading-question {
            opacity: 0.6;
            pointer-events: none;
        }
        .loading-question::after {
            content: 'åŠ è½½ä¸­...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6B7280;
            font-size: 1.2rem;
        }
        /* æ·»åŠ æ–°çš„åŠ¨ç”»æ ·å¼ */
        @keyframes bounce-in {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-bounce-in {
            animation: bounce-in 0.6s ease-out;
        }

        /* AIåˆ†æçŠ¶æ€æ ·å¼ */
        .ai-status-processing {
            border-left: 4px solid #3B82F6;
        }

        .ai-status-success {
            border-left: 4px solid #10B981;
        }

        .ai-status-error {
            border-left: 4px solid #EF4444;
        }

        /* è„‰å†²åŠ¨ç”» */
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ä¿®æ”¹åçš„å¯¼èˆªæ  - ä¸é¦–é¡µä¿æŒä¸€è‡´ -->
    <nav class="flex items-center justify-between px-6 lg:px-12 h-16 bg-white/90 backdrop-blur-md fixed top-0 left-0 right-0 z-50 border-b border-blue-50">
        <div class="flex items-center gap-8 lg:gap-16">
            <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="flex items-center gap-3">
                <span class="text-2xl font-bold tracking-tight" style="color: #2962FF;">äº‘æ¢¦æ™ºé—´</span>
            </a>
            <div class="hidden lg:flex items-center gap-8">
                <a href="äº‘æ¢¦æ™ºé—´è®¡åˆ’.html" class="text-gray-700 hover:text-primary transition-colors font-medium">å¤‡è€ƒè§„åˆ’</a>
                <a href="äº‘æ¢¦æ™ºé—´æ•™å­¦.html" class="text-gray-700 hover:text-primary transition-colors font-medium">åœ¨çº¿æ•™å­¦</a>
                <a href="äº‘æ¢¦æ™ºé—´çœŸé¢˜è€ƒè¯•.html" class="text-gray-700 hover:text-primary transition-colors font-medium">çœŸé¢˜è€ƒè¯•</a>
                <a href="äº‘æ¢¦æ™ºé—´ç¤¾åŒº.html" class="text-gray-700 hover:text-primary transition-colors font-medium">å­¦ä¹ ç¤¾åŒº</a>
            </div>
        </div>
        
        <!-- å³ä¾§åŒºåŸŸ - åŒ…å«è®¡æ—¶å™¨å’Œè®¤è¯åŒºåŸŸ -->
        <div class="flex items-center gap-4 lg:gap-6">
            <!-- æµ‹è¯•è®¡æ—¶å™¨ -->
            <div class="test-timer bg-red-50 text-red-600 px-3 py-1 rounded-lg font-mono text-lg hidden" id="test-timer">
                30:00
            </div>
            
            <!-- åŠ¨æ€è®¤è¯åŒºåŸŸ -->
            <div id="auth-section">
                <!-- åŠ¨æ€è®¤è¯åŒºåŸŸ -->
            </div>
            
            <!-- AIèŠå¤©å…¥å£ -->
            <a href="äº‘æ¢¦æ™ºé—´AIèŠå¤©.html" class="flex items-center px-4 lg:px-6 py-2 bg-primary text-white rounded-button hover:bg-secondary transition-colors">
                <span class="whitespace-nowrap font-medium text-sm lg:text-base">å…è´¹è¯•ç”¨</span>
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ - æ·»åŠ é¡¶éƒ¨å†…è¾¹è·ä»¥é¿å¼€å›ºå®šå¯¼èˆªæ  -->
    <div class="max-w-6xl mx-auto pt-16 pb-8 px-4 sm:px-6 lg:px-8">
        <!-- æµ‹è¯•é€‰æ‹©é˜¶æ®µ -->
        <div id="test-selection" class="test-container">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">è‹±è¯­èƒ½åŠ›å¤šç»´è¯„ä¼°</h1>
                <p class="text-gray-600 text-xl">åŸºäºCEFRæ ‡å‡†å’Œå››å…­çº§è€ƒè¯•å¤§çº²çš„å…¨é¢èƒ½åŠ›è¯Šæ–­</p>
            </div>
            
            <!-- ç”¨æˆ·çŠ¶æ€æç¤º -->
            <div id="user-status-alert" class="hidden mb-8 p-6 bg-blue-50 border border-blue-200 rounded-xl">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-500 text-xl mr-4 mt-1"></i>
                    <div class="flex-1">
                        <p class="font-semibold text-blue-800 text-lg" id="status-message"></p>
                        <p class="text-blue-600 mt-2" id="status-detail"></p>
                    </div>
                </div>
            </div>
            
            <!-- è€ƒè¯•ç±»å‹é€‰æ‹© -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <!-- å››çº§è€ƒè¯•æ¨¡å— -->
                <div class="exam-type-card bg-white border-2 border-blue-300 rounded-2xl p-8 transition-all duration-300"
                     onclick="selectExamType('CET4')">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-2xl text-blue-900">å¤§å­¦è‹±è¯­å››çº§è¯„ä¼°</h3>
                            <p class="text-blue-700 mt-2">é€‚åˆå‡†å¤‡å››çº§è€ƒè¯•æˆ–è¾¾åˆ°ä¸­çº§è‹±è¯­æ°´å¹³çš„å­¦ä¹ è€…</p>
                        </div>
                        <span class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-semibold">B1æ°´å¹³</span>
                    </div>
                    
                    <div class="space-y-3 text-blue-600 mb-6">
                        <div class="flex justify-between items-center py-2 border-b border-blue-100">
                            <span class="font-medium">æµ‹è¯•æ—¶é•¿</span>
                            <span class="font-semibold">30åˆ†é’Ÿ</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-blue-100">
                            <span class="font-medium">é¢˜ç›®æ•°é‡</span>
                            <span class="font-semibold">20é¢˜</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-blue-100">
                            <span class="font-medium">èƒ½åŠ›ç»´åº¦</span>
                            <span class="font-semibold">4ä¸ªç»´åº¦</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="font-medium">æµ‹è¯•å†…å®¹</span>
                            <span class="font-semibold">è¯æ±‡/è¯­æ³•/é˜…è¯»/ç¿»è¯‘</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button onclick="startTest('CET4')" class="w-full py-4 bg-blue-600 text-white rounded-xl font-semibold text-lg hover:bg-blue-700 transition-colors">
                            å¼€å§‹å››çº§èƒ½åŠ›è¯„ä¼°
                        </button>
                    </div>
                </div>

                <!-- å…­çº§è€ƒè¯•æ¨¡å— -->
                <div class="exam-type-card bg-white border-2 border-purple-300 rounded-2xl p-8 transition-all duration-300"
                     onclick="selectExamType('CET6')">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-2xl text-purple-900">å¤§å­¦è‹±è¯­å…­çº§è¯„ä¼°</h3>
                            <p class="text-purple-700 mt-2">é€‚åˆå‡†å¤‡å…­çº§è€ƒè¯•æˆ–è¾¾åˆ°ä¸­é«˜çº§è‹±è¯­æ°´å¹³çš„å­¦ä¹ è€…</p>
                        </div>
                        <span class="bg-purple-100 text-purple-800 px-4 py-2 rounded-full text-sm font-semibold">B2æ°´å¹³</span>
                    </div>
                    
                    <div class="space-y-3 text-purple-600 mb-6">
                        <div class="flex justify-between items-center py-2 border-b border-purple-100">
                            <span class="font-medium">æµ‹è¯•æ—¶é•¿</span>
                            <span class="font-semibold">35åˆ†é’Ÿ</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-purple-100">
                            <span class="font-medium">é¢˜ç›®æ•°é‡</span>
                            <span class="font-semibold">20é¢˜</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-purple-100">
                            <span class="font-medium">èƒ½åŠ›ç»´åº¦</span>
                            <span class="font-semibold">4ä¸ªç»´åº¦</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="font-medium">æµ‹è¯•å†…å®¹</span>
                            <span class="font-semibold">è¯æ±‡/è¯­æ³•/é˜…è¯»/ç¿»è¯‘</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button onclick="startTest('CET6')" class="w-full py-4 bg-purple-600 text-white rounded-xl font-semibold text-lg hover:bg-purple-700 transition-colors">
                            å¼€å§‹å…­çº§èƒ½åŠ›è¯„ä¼°
                        </button>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•è¯´æ˜ -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-8 text-white mb-8">
                <h4 class="font-bold text-2xl mb-6 flex items-center">
                    <i class="fas fa-info-circle mr-3"></i>
                    æµ‹è¯•è¯´æ˜
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-4 text-green-300 text-xl"></i>
                        <span>åŸºäºCEFRæ ‡å‡†å’Œå››å…­çº§è€ƒè¯•å¤§çº²çš„ç§‘å­¦è¯„ä¼°</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-4 text-green-300 text-xl"></i>
                        <span>æ¶µç›–4ä¸ªå…³é”®èƒ½åŠ›ç»´åº¦çš„å…¨é¢è¯Šæ–­</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-4 text-green-300 text-xl"></i>
                        <span>æ™ºæ™®AIç”Ÿæˆä¸ªæ€§åŒ–ä¸‰ç»´èƒ½åŠ›å›¾è°±</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-4 text-green-300 text-xl"></i>
                        <span>åŸºäºé—å¿˜æ›²çº¿çš„æ™ºèƒ½å¤ä¹ è®¡åˆ’</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•è¿›è¡Œä¸­é˜¶æ®µ -->
        <div id="test-in-progress" class="test-container hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- å·¦ä¾§è¿›åº¦é¢æ¿ -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                        <h3 class="font-bold text-gray-900 text-lg mb-6">æµ‹è¯•è¿›åº¦</h3>
                        
                        <!-- ç»´åº¦è¿›åº¦ -->
                        <div class="space-y-3 mb-6" id="dimension-progress">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- æ€»ä½“è¿›åº¦ -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex justify-between text-sm text-blue-800 font-medium mb-2">
                                <span>æ€»ä½“è¿›åº¦</span>
                                <span id="completed-count">0/4</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-3">
                                <div id="overall-progress" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- å½“å‰ç»´åº¦ä¿¡æ¯ -->
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-semibold text-gray-900 mb-2" id="current-dimension-name">è¯æ±‡èƒ½åŠ›</h4>
                            <p class="text-sm text-gray-600" id="current-dimension-desc">æµ‹è¯•æ‚¨çš„è¯æ±‡æŒæ¡ç¨‹åº¦</p>
                            <div class="flex items-center justify-between mt-3 text-sm">
                                <span>æœ¬éƒ¨åˆ†è¿›åº¦</span>
                                <span class="font-semibold" id="dimension-question-progress">1/5</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§é¢˜ç›®åŒºåŸŸ -->
                <div class="lg:col-span-3">
                    <div class="question-card rounded-xl shadow-lg p-8">
                        <!-- é¢˜ç›®å¤´éƒ¨ -->
                        <div class="flex justify-between items-start mb-8 pb-6 border-b border-gray-200">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900" id="question-title">é¢˜ç›®</h2>
                                <p class="text-gray-600 mt-2" id="question-description">è¯·ä»”ç»†é˜…è¯»é¢˜ç›®å¹¶é€‰æ‹©ç­”æ¡ˆ</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500 mb-1">å‰©ä½™æ—¶é—´</div>
                                <div class="text-xl font-bold text-red-600" id="time-remaining">30:00</div>
                            </div>
                        </div>

                        <!-- é¢˜ç›®å†…å®¹ -->
                        <div id="question-content" class="mb-8">
                            <!-- åŠ¨æ€åŠ è½½é¢˜ç›® -->
                        </div>

                        <!-- å¯¼èˆªæŒ‰é’® -->
                        <div class="flex justify-between pt-6 border-t border-gray-200">
                            <button onclick="previousQuestion()" class="px-8 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 flex items-center font-medium transition-colors" id="prev-btn">
                                <i class="fas fa-arrow-left mr-3"></i>
                                ä¸Šä¸€é¢˜
                            </button>
                            <button onclick="nextQuestion()" class="px-8 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 flex items-center font-medium transition-colors" id="next-btn">
                                ä¸‹ä¸€é¢˜
                                <i class="fas fa-arrow-right ml-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•å®Œæˆé˜¶æ®µ -->
        <div id="test-completed" class="test-container hidden">
            <div class="bg-white rounded-2xl shadow-xl p-12 text-center max-w-3xl mx-auto">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-4xl mx-auto mb-8">
                    <i class="fas fa-check"></i>
                </div>
                
                <!-- åŠ¨æ€åˆ†æçŠ¶æ€æ˜¾ç¤º -->
                <div id="analysis-status">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">æµ‹è¯•å®Œæˆ!</h2>
                    <p class="text-gray-600 text-lg mb-8">æ­£åœ¨ä½¿ç”¨æ™ºæ™®AIåˆ†ææ‚¨çš„æµ‹è¯•ç»“æœï¼Œç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„...</p>
                </div>
                
                <!-- AIåˆ†æè¿›åº¦ -->
                <div class="flex justify-center mb-8">
                    <div id="analysis-progress" class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div>
                </div>

                <!-- AIåˆ†æçŠ¶æ€è¯¦æƒ… -->
                <div id="analysis-details" class="space-y-4 mb-8 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-brain text-blue-600 mr-2"></i>
                                <span class="font-semibold">èƒ½åŠ›å›¾è°±</span>
                            </div>
                            <div id="ability-map-status" class="text-blue-700">ç”Ÿæˆä¸­...</div>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-exclamation-triangle text-orange-600 mr-2"></i>
                                <span class="font-semibold">è–„å¼±ç‚¹åˆ†æ</span>
                            </div>
                            <div id="weakpoints-status" class="text-orange-700">åˆ†æä¸­...</div>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-chart-line text-green-600 mr-2"></i>
                                <span class="font-semibold">å­¦ä¹ è·¯å¾„</span>
                            </div>
                            <div id="learning-path-status" class="text-green-700">è§„åˆ’ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- æˆåŠŸæç¤º -->
                <div id="success-message" class="hidden">
                    <div class="bg-gradient-to-r from-green-600 to-green-500 rounded-xl p-6 text-white mb-6">
                        <div class="flex items-center justify-center mb-4">
                            <i class="fas fa-check-circle text-3xl mr-3"></i>
                            <h3 class="text-2xl font-bold">åˆ†ææˆåŠŸ!</h3>
                        </div>
                        <p class="text-lg">æ™ºæ™®AIå·²å®Œæˆæ·±åº¦åˆ†æï¼Œç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ æ–¹æ¡ˆ</p>
                    </div>
                </div>

                <div class="flex gap-4 justify-center">
                    <button onclick="viewDetailedAnalysis()" class="px-8 py-4 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-semibold text-lg">
                        æŸ¥çœ‹è¯¦ç»†åˆ†ææŠ¥å‘Š
                    </button>
                    <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="px-8 py-4 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-semibold text-lg">
                        è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JSæ–‡ä»¶ -->
    <script src="äº‘æ¢¦æ™ºé—´ç»Ÿä¸€è®¤è¯.js"></script>
    <script src="äº‘æ¢¦æ™ºé—´UIç®¡ç†å™¨.js"></script>
    
    <!-- ç›´æ¥åœ¨HTMLä¸­åµŒå…¥é¢˜ç›®æ•°æ® -->
    <script>
        // æœ¬åœ°é¢˜ç›®æ•°æ® - ç›´æ¥ä»database.jsä¸­æå–çš„80é“é¢˜ç›®
        window.localQuestions = {
            CET4: {
                vocabulary: [
                    {
                        question: "The company is looking for ______ employees who can adapt to changing situations.",
                        options: ['A) flexible', 'B) rigid', 'C) stubborn', 'D) traditional'],
                        correctAnswer: 'A',
                        explanation: 'flexibleæ„ä¸º"çµæ´»çš„"ï¼Œç¬¦åˆè¯­å¢ƒã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Choose the word closest in meaning: The project was abandoned due to lack of funding.",
                        options: ['A) given up', 'B) expanded', 'C) completed', 'D) delayed'],
                        correctAnswer: 'A',
                        explanation: 'abandonedæ„ä¸º"æ”¾å¼ƒï¼ŒæŠ›å¼ƒ"ï¼Œä¸given upæ„æ€ç›¸è¿‘ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Her ______ to learn English impressed everyone.",
                        options: ['A) determination', 'B) determined', 'C) determine', 'D) determining'],
                        correctAnswer: 'A',
                        explanation: 'determinationæ˜¯åè¯ï¼Œæ„ä¸º"å†³å¿ƒ"ï¼Œåœ¨å¥ä¸­ä½œä¸»è¯­ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Select the correct phrasal verb: We need to ______ a solution to this problem as soon as possible.",
                        options: ['A) work out', 'B) work on', 'C) work up', 'D) work over'],
                        correctAnswer: 'A',
                        explanation: 'work outæ„ä¸º"æƒ³å‡ºï¼Œåˆ¶å®šå‡º"ï¼Œç¬¦åˆè¯­å¢ƒã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The research provided ______ evidence for the theory.",
                        options: ['A) compelling', 'B) weak', 'C) doubtful', 'D) questionable'],
                        correctAnswer: 'A',
                        explanation: 'compellingæ„ä¸º"ä»¤äººä¿¡æœçš„"ï¼Œç¬¦åˆè¯­å¢ƒã€‚',
                        type: 'single_choice'
                    }
                ],
                grammar: [
                    {
                        question: "Choose the correct tense: By the time you arrive, I ______ the report.",
                        options: ['A) will have finished', 'B) will finish', 'C) finish', 'D) am finishing'],
                        correctAnswer: 'A',
                        explanation: 'å°†æ¥å®Œæˆæ—¶è¡¨ç¤ºåœ¨å°†æ¥æŸä¸ªæ—¶é—´ä¹‹å‰å·²ç»å®Œæˆçš„åŠ¨ä½œã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Select the correct subjunctive mood: If I ______ you, I would accept the job offer.",
                        options: ['A) were', 'B) am', 'C) will be', 'D) have been'],
                        correctAnswer: 'A',
                        explanation: 'è™šæ‹Ÿè¯­æ°”ä¸­ï¼ŒbeåŠ¨è¯çš„è¿‡å»å¼ç”¨wereï¼Œä¸ç®¡ä¸»è¯­æ˜¯ä»€ä¹ˆã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Choose the correct passive voice: The new policy ______ by the government last month.",
                        options: ['A) was implemented', 'B) implemented', 'C) has implemented', 'D) is implementing'],
                        correctAnswer: 'A',
                        explanation: 'è¢«åŠ¨è¯­æ€è¡¨ç¤ºåŠ¨ä½œçš„æ‰§è¡Œè€…æ˜¯æ”¿åºœï¼Œä¸”æ—¶é—´æ˜¯ä¸Šä¸ªæœˆã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Select the correct conditional: If she ______ harder, she would have passed the exam.",
                        options: ['A) had studied', 'B) studied', 'C) would study', 'D) studies'],
                        correctAnswer: 'A',
                        explanation: 'ä¸è¿‡å»äº‹å®ç›¸åçš„è™šæ‹Ÿè¯­æ°”ï¼Œç”¨è¿‡å»å®Œæˆæ—¶ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Choose the correct relative clause: This is the book ______ I was talking about.",
                        options: ['A) that', 'B) who', 'C) when', 'D) where'],
                        correctAnswer: 'A',
                        explanation: 'thatå¼•å¯¼å®šè¯­ä»å¥ï¼Œä¿®é¥°ç‰©bookã€‚',
                        type: 'single_choice'
                    }
                ],
                reading: [
                    {
                        question: "Climate change is one of the most pressing issues of our time. Rising global temperatures are causing sea levels to rise, extreme weather events to become more frequent, and ecosystems to be disrupted. Scientists warn that without immediate action, the consequences could be catastrophic.\n\nWhat is the main idea of the passage?",
                        options: ['A) Climate change requires immediate action', 'B) Scientists are uncertain about climate change', 'C) Only governments can solve climate change', 'D) Climate change is not a serious problem'],
                        correctAnswer: 'A',
                        explanation: 'æ–‡ç« å¼ºè°ƒäº†æ°”å€™å˜åŒ–éœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The invention of the printing press in the 15th century revolutionized the spread of information. Before this, books were copied by hand, making them expensive and rare. The printing press allowed for mass production of books.\n\nWhat was a major effect of the printing press?",
                        options: ['A) It made books more accessible', 'B) It decreased the importance of writing', 'C) It made books more expensive', 'D) It reduced the spread of new ideas'],
                        correctAnswer: 'A',
                        explanation: 'å°åˆ·æœºä½¿ä¹¦ç±èƒ½å¤Ÿå¤§è§„æ¨¡ç”Ÿäº§ï¼Œä»è€Œè®©æ›´å¤šäººèƒ½å¤Ÿæ¥è§¦åˆ°ä¹¦ç±ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Regular exercise has numerous benefits for both physical and mental health. It can help control weight, reduce the risk of heart disease, and improve mood. Experts recommend at least 30 minutes of moderate exercise most days of the week.\n\nAccording to the passage, what is NOT mentioned as a benefit of exercise?",
                        options: ['A) Weight control', 'B) Reduced risk of heart disease', 'C) Improved mood', 'D) Better sleep quality'],
                        correctAnswer: 'D',
                        explanation: 'æ–‡ç« æåˆ°äº†æ§åˆ¶ä½“é‡ã€é™ä½å¿ƒè„ç—…é£é™©å’Œæ”¹å–„æƒ…ç»ªï¼Œä½†æ²¡æœ‰æåˆ°æ”¹å–„ç¡çœ è´¨é‡ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The Great Wall of China, one of the greatest wonders of the world, was built over 2,000 years ago. It stretches for thousands of miles across northern China. Originally constructed to protect against invasions, it now serves as a major tourist attraction.\n\nWhat was the original purpose of the Great Wall?",
                        options: ['A) Tourist attraction', 'B) Religious ceremonies', 'C) Protection against invasions', 'D) Trade route'],
                        correctAnswer: 'C',
                        explanation: 'æ–‡ç« æ˜ç¡®æåˆ°é•¿åŸæœ€åˆæ˜¯ä¸ºäº†é˜²å¾¡å…¥ä¾µè€Œå»ºé€ çš„ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Artificial intelligence is transforming many industries, from healthcare to finance. While it offers many benefits, such as increased efficiency and accuracy, it also raises concerns about job displacement and privacy issues.\n\nWhat is the author's attitude toward artificial intelligence?",
                        options: ['A) Completely positive', 'B) Completely negative', 'C) Balanced, mentioning both benefits and concerns', 'D) Indifferent'],
                        correctAnswer: 'C',
                        explanation: 'ä½œè€…æ—¢æåˆ°äº†äººå·¥æ™ºèƒ½çš„å¥½å¤„ï¼Œä¹Ÿæåˆ°äº†æ‹…å¿§ï¼Œæ€åº¦æ˜¯å¹³è¡¡çš„ã€‚',
                        type: 'single_choice'
                    }
                ],
                translation: [
                    {
                        question: "Translate to English: ä¸­å›½æœ‰ç€æ‚ ä¹…çš„å†å²å’Œä¸°å¯Œçš„æ–‡åŒ–ã€‚",
                        correctAnswer: "China has a long history and rich culture.",
                        explanation: 'ç¿»è¯‘æ—¶æ³¨æ„"æ‚ ä¹…çš„å†å²"å’Œ"ä¸°å¯Œçš„æ–‡åŒ–"çš„å‡†ç¡®è¡¨è¾¾ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: éšç€ç§‘æŠ€çš„å‘å±•ï¼Œäººä»¬çš„ç”Ÿæ´»å˜å¾—è¶Šæ¥è¶Šä¾¿åˆ©ã€‚",
                        correctAnswer: "With the development of technology, people's lives are becoming more and more convenient.",
                        explanation: 'æ³¨æ„"éšç€...çš„å‘å±•"å’Œ"è¶Šæ¥è¶Š..."çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: è¶Šæ¥è¶Šå¤šçš„äººå¼€å§‹å…³æ³¨ç¯å¢ƒä¿æŠ¤ã€‚",
                        correctAnswer: "More and more people are beginning to pay attention to environmental protection.",
                        explanation: 'æ³¨æ„"è¶Šæ¥è¶Šå¤š"å’Œ"å…³æ³¨"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: è¯»ä¹¦å¯¹äºä¸ªäººçš„æˆé•¿éå¸¸é‡è¦ã€‚",
                        correctAnswer: "Reading is very important for personal growth.",
                        explanation: 'æ³¨æ„"å¯¹äº...é‡è¦"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: æˆ‘ä»¬åº”è¯¥å…»æˆå¥åº·çš„ç”Ÿæ´»ä¹ æƒ¯ã€‚",
                        correctAnswer: "We should develop healthy living habits.",
                        explanation: 'æ³¨æ„"å…»æˆä¹ æƒ¯"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    }
                ]
            },
            CET6: {
                vocabulary: [
                    {
                        question: "The research findings were ______, challenging long-held assumptions.",
                        options: ['A) paradigm-shifting', 'B) commonplace', 'C) conventional', 'D) traditional'],
                        correctAnswer: 'A',
                        explanation: 'paradigm-shiftingæ„ä¸º"èŒƒå¼è½¬å˜çš„"ï¼Œç¬¦åˆæŒ‘æˆ˜é•¿æœŸå‡è®¾çš„è¯­å¢ƒã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Choose the synonym: The government implemented austerity measures to mitigate the crisis.",
                        options: ['A) alleviate', 'B) aggravate', 'C) ignore', 'D) analyze'],
                        correctAnswer: 'A',
                        explanation: 'mitigateæ„ä¸º"å‡è½»ï¼Œç¼“å’Œ"ï¼Œä¸alleviateæ„æ€ç›¸è¿‘ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The company's ______ approach to innovation has kept it ahead of competitors.",
                        options: ['A) proactive', 'B) reactive', 'C) passive', 'D) inactive'],
                        correctAnswer: 'A',
                        explanation: 'proactiveæ„ä¸º"ç§¯æä¸»åŠ¨çš„"ï¼Œç¬¦åˆè¯­å¢ƒã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Select the correct word: The agreement is ______ upon approval from both parties.",
                        options: ['A) contingent', 'B) definite', 'C) absolute', 'D) unconditional'],
                        correctAnswer: 'A',
                        explanation: 'contingentæ„ä¸º"ä¾æ¡ä»¶è€Œå®šçš„"ï¼Œç¬¦åˆè¯­å¢ƒã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The professor's ______ analysis revealed subtle patterns in the data.",
                        options: ['A) nuanced', 'B) superficial', 'C) cursory', 'D) simplistic'],
                        correctAnswer: 'A',
                        explanation: 'nuancedæ„ä¸º"ç»†è‡´å…¥å¾®çš„"ï¼Œç¬¦åˆè¯­å¢ƒã€‚',
                        type: 'single_choice'
                    }
                ],
                grammar: [
                    {
                        question: "Select the correct inversion: Not until she finished the project ______ how difficult it had been.",
                        options: ['A) did she realize', 'B) she realized', 'C) she had realized', 'D) had she realized'],
                        correctAnswer: 'A',
                        explanation: 'not untilä½äºå¥é¦–æ—¶ï¼Œä¸»å¥è¦éƒ¨åˆ†å€’è£…ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Choose the correct emphatic structure: It was his dedication to the work ______ impressed the committee.",
                        options: ['A) that', 'B) which', 'C) what', 'D) who'],
                        correctAnswer: 'A',
                        explanation: 'å¼ºè°ƒå¥å‹it is/was...that...',
                        type: 'single_choice'
                    },
                    {
                        question: "Select the correct participle: ______ by the complexity of the problem, the team sought expert advice.",
                        options: ['A) Daunted', 'B) Daunting', 'C) Having daunted', 'D) Being daunted'],
                        correctAnswer: 'A',
                        explanation: 'è¿‡å»åˆ†è¯dauntedè¡¨ç¤ºè¢«åŠ¨ï¼Œæ„ä¸º"è¢«å“å€’çš„"ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Choose the correct subjunctive: I recommend that he ______ the opportunity.",
                        options: ['A) take', 'B) takes', 'C) took', 'D) would take'],
                        correctAnswer: 'A',
                        explanation: 'recommendåçš„å®¾è¯­ä»å¥è¦ç”¨è™šæ‹Ÿè¯­æ°”ï¼ŒåŠ¨è¯ç”¨åŸå½¢ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Select the correct conditional: Had I known about the meeting, I ______ attended.",
                        options: ['A) would have', 'B) will have', 'C) had', 'D) have'],
                        correctAnswer: 'A',
                        explanation: 'ä¸è¿‡å»äº‹å®ç›¸åçš„è™šæ‹Ÿè¯­æ°”ï¼Œæ¡ä»¶å¥ç”¨è¿‡å»å®Œæˆæ—¶ï¼Œä¸»å¥ç”¨would have doneã€‚',
                        type: 'single_choice'
                    }
                ],
                reading: [
                    {
                        question: "The concept of cognitive dissonance, proposed by Leon Festinger, refers to the mental discomfort experienced when holding two or more contradictory beliefs, ideas, or values. This discomfort often leads people to change their attitudes or behaviors to reduce the inconsistency.\n\nWhat is cognitive dissonance according to the passage?",
                        options: ['A) A state of mental comfort', 'B) Mental discomfort from contradictory beliefs', 'C) A method for solving problems', 'D) A type of memory disorder'],
                        correctAnswer: 'B',
                        explanation: 'æ–‡ç« æ˜ç¡®æåˆ°è®¤çŸ¥å¤±è°ƒæ˜¯æŒ‡æŒæœ‰çŸ›ç›¾ä¿¡å¿µæ—¶äº§ç”Ÿçš„å¿ƒç†ä¸é€‚ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Quantum computing represents a paradigm shift in computational technology. Unlike classical computers that use bits, quantum computers use quantum bits or qubits, which can exist in multiple states simultaneously. This allows them to solve certain complex problems much faster than traditional computers.\n\nWhat is the main advantage of quantum computers mentioned in the passage?",
                        options: ['A) Lower cost', 'B) Smaller size', 'C) Faster problem-solving for certain tasks', 'D) Easier programming'],
                        correctAnswer: 'C',
                        explanation: 'æ–‡ç« æåˆ°é‡å­è®¡ç®—æœºå¯ä»¥æ¯”ä¼ ç»Ÿè®¡ç®—æœºæ›´å¿«åœ°è§£å†³æŸäº›å¤æ‚é—®é¢˜ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The Anthropocene is a proposed geological epoch dating from the commencement of significant human impact on Earth's geology and ecosystems. This includes changes such as global warming, ocean acidification, and mass species extinction. The term highlights the profound influence humans have on the planet.\n\nWhat does the term 'Anthropocene' refer to?",
                        options: ['A) A period before human existence', 'B) The current age of significant human impact on Earth', 'C) A future geological epoch', 'D) The age of dinosaurs'],
                        correctAnswer: 'B',
                        explanation: 'æ–‡ç« æ˜ç¡®æåˆ°AnthropoceneæŒ‡çš„æ˜¯äººç±»å¯¹åœ°çƒäº§ç”Ÿæ˜¾è‘—å½±å“çš„åœ°è´¨æ—¶ä»£ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "Epigenetics is the study of heritable changes in gene expression that do not involve changes to the underlying DNA sequence. These changes can be influenced by various factors including environment, lifestyle, and psychological stress. Epigenetic modifications can affect how genes are read and expressed.\n\nWhat is the main focus of epigenetics?",
                        options: ['A) Changes in DNA sequence', 'B) Heritable changes in gene expression without DNA sequence changes', 'C) The study of genetic diseases', 'D) Environmental factors only'],
                        correctAnswer: 'B',
                        explanation: 'æ–‡ç« æ˜ç¡®æåˆ°è¡¨è§‚é—ä¼ å­¦ç ”ç©¶ä¸æ¶‰åŠDNAåºåˆ—å˜åŒ–çš„å¯é—ä¼ åŸºå› è¡¨è¾¾å˜åŒ–ã€‚',
                        type: 'single_choice'
                    },
                    {
                        question: "The Dunning-Kruger effect is a cognitive bias wherein people with low ability at a task overestimate their ability. This occurs because the skills needed to produce the right answer are exactly the skills needed to recognize what a right answer is. Conversely, highly skilled individuals may underestimate their relative competence.\n\nWhat is the Dunning-Kruger effect?",
                        options: ['A) Highly skilled people overestimating their ability', 'B) Low-ability individuals overestimating their ability', 'C) Everyone accurately assessing their ability', 'D) The tendency to avoid difficult tasks'],
                        correctAnswer: 'B',
                        explanation: 'æ–‡ç« æ˜ç¡®æåˆ°é‚“å®-å…‹é²æ ¼æ•ˆåº”æ˜¯æŒ‡èƒ½åŠ›ä¸è¶³çš„äººé«˜ä¼°è‡ªå·±èƒ½åŠ›çš„è®¤çŸ¥åå·®ã€‚',
                        type: 'single_choice'
                    }
                ],
                translation: [
                    {
                        question: "Translate to English: äººå·¥æ™ºèƒ½æ­£åœ¨é‡å¡‘å„è¡Œå„ä¸šï¼Œä»åŒ»ç–—ä¿å¥åˆ°é‡‘èæœåŠ¡ã€‚",
                        correctAnswer: "Artificial intelligence is reshaping various industries, from healthcare to financial services.",
                        explanation: 'æ³¨æ„"é‡å¡‘"å’Œ"å„è¡Œå„ä¸š"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: å¯æŒç»­å‘å±•è¦æ±‚æˆ‘ä»¬åœ¨ç»æµã€ç¤¾ä¼šå’Œç¯å¢ƒä¹‹é—´å–å¾—å¹³è¡¡ã€‚",
                        correctAnswer: "Sustainable development requires us to achieve a balance among economy, society and environment.",
                        explanation: 'æ³¨æ„"å¯æŒç»­å‘å±•"å’Œ"å–å¾—å¹³è¡¡"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: å…¨çƒåŒ–çš„æ·±å…¥å‘å±•ä½¿å„å›½ä¹‹é—´çš„ç›¸äº’ä¾å­˜ç¨‹åº¦ä¸æ–­åŠ æ·±ã€‚",
                        correctAnswer: "The deepening development of globalization has continuously increased the interdependence among countries.",
                        explanation: 'æ³¨æ„"æ·±å…¥å‘å±•"å’Œ"ç›¸äº’ä¾å­˜"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: ç§‘æŠ€åˆ›æ–°æ˜¯æ¨åŠ¨ç»æµç¤¾ä¼šå‘å±•çš„æ ¸å¿ƒåŠ¨åŠ›ã€‚",
                        correctAnswer: "Technological innovation is the core driving force for economic and social development.",
                        explanation: 'æ³¨æ„"æ ¸å¿ƒåŠ¨åŠ›"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    },
                    {
                        question: "Translate to English: åº”å¯¹æ°”å€™å˜åŒ–éœ€è¦å›½é™…ç¤¾ä¼šçš„å…±åŒåŠªåŠ›ã€‚",
                        correctAnswer: "Addressing climate change requires the joint efforts of the international community.",
                        explanation: 'æ³¨æ„"åº”å¯¹"å’Œ"å…±åŒåŠªåŠ›"çš„ç¿»è¯‘ã€‚',
                        type: 'translation'
                    }
                ]
            }
        };
    </script>
    
    <script>
        // åˆ†æçŠ¶æ€ç®¡ç†å™¨
        const analysisState = {
            updateStatus: function(stage, message) {
                console.log(`ğŸ”„ AIåˆ†æçŠ¶æ€: ${stage} - ${message}`);
                
                const statusElement = document.getElementById('analysis-status');
                const detailsElement = document.getElementById('analysis-details');
                const successElement = document.getElementById('success-message');
                const progressElement = document.getElementById('analysis-progress');
                
                if (!statusElement) return;
                
                switch(stage) {
                    case 'start':
                        statusElement.innerHTML = `
                            <h2 class="text-3xl font-bold text-gray-900 mb-4">AIåˆ†æå¯åŠ¨</h2>
                            <p class="text-gray-600 text-lg mb-8">${message}</p>
                        `;
                        if (detailsElement) detailsElement.classList.remove('hidden');
                        break;
                        
                    case 'processing':
                        statusElement.innerHTML = `
                            <h2 class="text-3xl font-bold text-gray-900 mb-4">AIåˆ†æè¿›è¡Œä¸­</h2>
                            <p class="text-gray-600 text-lg mb-8">${message}</p>
                        `;
                        // æ›´æ–°å…·ä½“çŠ¶æ€
                        if (message.includes('èƒ½åŠ›å›¾è°±')) {
                            document.getElementById('ability-map-status').textContent = 'ç”Ÿæˆä¸­...';
                        } else if (message.includes('è–„å¼±ç‚¹')) {
                            document.getElementById('ability-map-status').textContent = 'å·²å®Œæˆ';
                            document.getElementById('weakpoints-status').textContent = 'åˆ†æä¸­...';
                        } else if (message.includes('å­¦ä¹ è·¯å¾„')) {
                            document.getElementById('weakpoints-status').textContent = 'å·²å®Œæˆ';
                            document.getElementById('learning-path-status').textContent = 'è§„åˆ’ä¸­...';
                        }
                        break;
                        
                    case 'success':
                        statusElement.classList.add('hidden');
                        if (successElement) successElement.classList.remove('hidden');
                        if (progressElement) progressElement.classList.add('hidden');
                        if (detailsElement) {
                            document.getElementById('ability-map-status').textContent = 'å·²å®Œæˆ';
                            document.getElementById('weakpoints-status').textContent = 'å·²å®Œæˆ'; 
                            document.getElementById('learning-path-status').textContent = 'å·²å®Œæˆ';
                        }
                        
                        // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
                        this.showSuccessAnimation();
                        break;
                        
                    case 'error':
                        statusElement.innerHTML = `
                            <h2 class="text-3xl font-bold text-red-600 mb-4">åˆ†æé‡åˆ°é—®é¢˜</h2>
                            <p class="text-gray-600 text-lg mb-8">${message}</p>
                        `;
                        if (progressElement) {
                            progressElement.className = 'rounded-full h-16 w-16 border-2 border-red-600 flex items-center justify-center';
                            progressElement.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>';
                        }
                        break;
                }
            },
            
            showSuccessAnimation: function() {
                const successIcon = document.createElement('div');
                successIcon.className = 'fixed inset-0 flex items-center justify-center z-50 pointer-events-none';
                successIcon.innerHTML = `
                    <div class="animate-bounce-in">
                        <div class="w-32 h-32 bg-green-500 rounded-full flex items-center justify-center shadow-2xl">
                            <i class="fas fa-check text-white text-4xl"></i>
                        </div>
                    </div>
                `;
                document.body.appendChild(successIcon);
                
                setTimeout(() => {
                    successIcon.remove();
                }, 2000);
            }
        };

        // ä¿®å¤åçš„æµ‹è¯•çŠ¶æ€ç®¡ç†
        const testState = {
            currentExamType: null,
            currentDimensionIndex: 0,
            currentQuestionIndex: 0,
            answers: {},
            startTime: null,
            timerInterval: null,
            timeRemaining: 0,
            userId: null,
            questions: {},
            dimensions: ['vocabulary', 'grammar', 'reading', 'translation'],
            config: null,
            
            get currentDimension() {
                return this.dimensions[this.currentDimensionIndex];
            },
            
            get currentQuestions() {
                return this.questions[this.currentDimension] || [];
            },
            
            get currentQuestion() {
                return this.currentQuestions[this.currentQuestionIndex];
            },
            
            initializeConfig(examType) {
                this.config = {
                    CET4: {
                        totalTime: 1800,
                        dimensions: {
                            vocabulary: { count: 5, time: 300 },
                            grammar: { count: 5, time: 300 },
                            reading: { count: 5, time: 600 },
                            translation: { count: 5, time: 600 }
                        }
                    },
                    CET6: {
                        totalTime: 2100,
                        dimensions: {
                            vocabulary: { count: 5, time: 300 },
                            grammar: { count: 5, time: 300 },
                            reading: { count: 5, time: 600 },
                            translation: { count: 5, time: 900 }
                        }
                    }
                }[examType];
            }
        };

        // ç»´åº¦æ˜¾ç¤ºé…ç½®
        const dimensionConfig = {
            vocabulary: {
                name: 'è¯æ±‡èƒ½åŠ›',
                description: 'æµ‹è¯•æ‚¨çš„è¯æ±‡æŒæ¡ç¨‹åº¦å’Œåº”ç”¨èƒ½åŠ›',
                icon: 'fas fa-book'
            },
            grammar: {
                name: 'è¯­æ³•èƒ½åŠ›', 
                description: 'è¯„ä¼°æ‚¨çš„è¯­æ³•çŸ¥è¯†å’Œå¥å­æ„é€ èƒ½åŠ›',
                icon: 'fas fa-language'
            },
            reading: {
                name: 'é˜…è¯»ç†è§£',
                description: 'è€ƒå¯Ÿæ‚¨çš„é˜…è¯»ç†è§£å’Œä¿¡æ¯æå–èƒ½åŠ›',
                icon: 'fas fa-book-reader'
            },
            translation: {
                name: 'ç¿»è¯‘èƒ½åŠ›',
                description: 'è¯„ä¼°æ‚¨çš„ç¿»è¯‘å‡†ç¡®æ€§å’Œè¯­è¨€è½¬æ¢èƒ½åŠ›',
                icon: 'fas fa-exchange-alt'
            }
        };

        // è°ƒè¯•å·¥å…·
        window.debugTestState = function() {
            console.group('ğŸ” æµ‹è¯•çŠ¶æ€è°ƒè¯•ä¿¡æ¯');
            console.log('å½“å‰è€ƒè¯•ç±»å‹:', testState.currentExamType);
            console.log('å½“å‰ç»´åº¦:', testState.currentDimension);
            console.log('å½“å‰é¢˜ç›®ç´¢å¼•:', testState.currentQuestionIndex);
            console.log('é¢˜ç›®æ•°æ®:', testState.questions);
            console.log('å½“å‰é¢˜ç›®:', testState.currentQuestion);
            console.log('ç­”æ¡ˆæ•°æ®:', testState.answers);
            console.groupEnd();
        };

        // åœ¨æ§åˆ¶å°æ‰§è¡Œ debugTestState() æ¥æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ä¿¡æ¯
        console.log('ğŸ› è°ƒè¯•å·¥å…·å·²åŠ è½½: åœ¨æ§åˆ¶å°æ‰§è¡Œ debugTestState() æŸ¥çœ‹æµ‹è¯•çŠ¶æ€');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            checkAuthStatus();
            checkUnfinishedTest();
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        function checkAuthStatus() {
            const authManager = window.unifiedAuthManager || window.authManager;
            const user = authManager?.getCurrentUser();
            
            if (!user) {
                showAuthRequiredAlert();
                return false;
            }
            testState.userId = user.id;
            console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.name);
            return true;
        }

        // æ˜¾ç¤ºè®¤è¯è¦æ±‚æç¤º
        function showAuthRequiredAlert() {
            const alertBox = document.getElementById('user-status-alert');
            const message = document.getElementById('status-message');
            const detail = document.getElementById('status-detail');
            
            if (alertBox && message && detail) {
                alertBox.classList.remove('hidden');
                message.textContent = 'è¯·å…ˆç™»å½•åè¿›è¡Œèƒ½åŠ›è¯„ä¼°æµ‹è¯•';
                detail.textContent = 'ç™»å½•åå³å¯å¼€å§‹å…¨é¢çš„è‹±è¯­èƒ½åŠ›è¯Šæ–­ï¼Œè·å–ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®';
            }
        }

        // æ£€æŸ¥æœªå®Œæˆçš„æµ‹è¯•
        function checkUnfinishedTest() {
            const lastTest = localStorage.getItem('last_assessment_data');
            if (lastTest) {
                try {
                    const testData = JSON.parse(lastTest);
                    const testDate = new Date(testData.timestamp);
                    const today = new Date();
                    
                    if (testDate.toDateString() === today.toDateString()) {
                        showRecentTestAlert(testData);
                    }
                } catch (e) {
                    console.warn('è§£æå†å²æµ‹è¯•æ•°æ®å¤±è´¥');
                }
            }
        }

        // æ˜¾ç¤ºæœ€è¿‘æµ‹è¯•æç¤º
        function showRecentTestAlert(testData) {
            const alertBox = document.getElementById('user-status-alert');
            const message = document.getElementById('status-message');
            const detail = document.getElementById('status-detail');
            
            if (alertBox && message && detail) {
                alertBox.classList.remove('hidden');
                alertBox.className = 'mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-xl';
                
                message.textContent = `æ‚¨ä»Šå¤©å·²ç»å®Œæˆè¿‡${testData.examType === 'CET4' ? 'å››çº§' : 'å…­çº§'}èƒ½åŠ›è¯„ä¼°`;
                detail.textContent = `å¾—åˆ†: ${testData.overallScore} - é‡æ–°æµ‹è¯•å°†è¦†ç›–ä¹‹å‰çš„è¯„ä¼°ç»“æœ`;
                
                const icon = alertBox.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-exclamation-triangle text-yellow-500 text-xl mr-4 mt-1';
                }
            }
        }

        // é€‰æ‹©è€ƒè¯•ç±»å‹
        function selectExamType(type) {
            console.log('ğŸ¯ é€‰æ‹©è€ƒè¯•ç±»å‹:', type);
            
            if (!checkAuthStatus()) {
                window.location.href = 'äº‘æ¢¦æ™ºé—´ç™»å½•.html?redirect=äº‘æ¢¦æ™ºé—´æµ‹è¯•.html';
                return;
            }
            
            testState.currentExamType = type;
            
            // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.exam-type-card').forEach(card => {
                card.classList.remove('selected', 'border-blue-500', 'border-purple-500', 'shadow-lg');
            });
            
            const selectedCard = event.currentTarget;
            selectedCard.classList.add('selected', 'shadow-lg');
            selectedCard.classList.add(type === 'CET4' ? 'border-blue-500' : 'border-purple-500');
            
            // å¯ç”¨å¼€å§‹æŒ‰é’®
            document.querySelectorAll('button[onclick*="startTest"]').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            });
        }

        // å¼€å§‹æµ‹è¯•
        async function startTest(examType) {
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•:', examType);
            
            if (!checkAuthStatus()) {
                window.location.href = 'äº‘æ¢¦æ™ºé—´ç™»å½•.html?redirect=äº‘æ¢¦æ™ºé—´æµ‹è¯•.html';
                return;
            }
            
            if (!examType) {
                if (window.uiManager) {
                    window.uiManager.showMessage('è¯·é€‰æ‹©è€ƒè¯•ç±»å‹', 'error');
                }
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (window.uiManager) {
                window.uiManager.showLearningProgress('æ­£åœ¨å‡†å¤‡æµ‹è¯•é¢˜ç›®...');
            }

            try {
                // åˆå§‹åŒ–æµ‹è¯•çŠ¶æ€
                testState.currentExamType = examType;
                testState.initializeConfig(examType);
                testState.startTime = new Date();
                testState.timeRemaining = testState.config.totalTime;
                testState.answers = {};
                testState.currentDimensionIndex = 0;
                testState.currentQuestionIndex = 0;
                testState.questions = {};
                
                // ç›´æ¥ä»æœ¬åœ°åŠ è½½é¢˜ç›®
                loadLocalQuestions(examType);
                
                // åˆ‡æ¢åˆ°æµ‹è¯•ç•Œé¢
                showTestInProgress();
                
                // å¼€å§‹è®¡æ—¶å™¨
                startTimer();
                
                // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º
                initializeProgressDisplay();
                
                // åŠ è½½ç¬¬ä¸€ä¸ªé¢˜ç›®
                loadCurrentQuestion();
                
                console.log('âœ… æµ‹è¯•åˆå§‹åŒ–å®Œæˆï¼Œé¢˜ç›®æ•°é‡:', 
                    Object.keys(testState.questions).reduce((sum, dim) => sum + testState.questions[dim].length, 0));
                
            } catch (error) {
                console.error('å¼€å§‹æµ‹è¯•å¤±è´¥:', error);
                if (window.uiManager) {
                    window.uiManager.showMessage('æµ‹è¯•å‡†å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } finally {
                if (window.uiManager) {
                    window.uiManager.hideLearningProgress();
                }
            }
        }

        // ä»æœ¬åœ°åŠ è½½é¢˜ç›® - ä¿®å¤ç‰ˆæœ¬
        function loadLocalQuestions(examType) {
            console.log('ğŸ“š åŠ è½½æœ¬åœ°é¢˜ç›®:', examType);
            
            if (!window.localQuestions || !window.localQuestions[examType]) {
                console.error('âŒ æœ¬åœ°é¢˜ç›®æ•°æ®ä¸å­˜åœ¨');
                if (window.uiManager) {
                    window.uiManager.showMessage('é¢˜ç›®æ•°æ®åŠ è½½å¤±è´¥', 'error');
                }
                return;
            }
            
            // æ·±æ‹·è´é¢˜ç›®æ•°æ®
            testState.questions = JSON.parse(JSON.stringify(window.localQuestions[examType]));
            
            // åˆå§‹åŒ–ç­”æ¡ˆå­˜å‚¨ç»“æ„
            testState.dimensions.forEach(dimension => {
                if (testState.questions[dimension]) {
                    testState.answers[dimension] = new Array(testState.questions[dimension].length).fill(undefined);
                }
            });
            
            console.log(`âœ… å·²åŠ è½½ ${examType} é¢˜ç›®æ•°æ®:`, 
                Object.keys(testState.questions).map(dim => `${dim}: ${testState.questions[dim].length}é¢˜`).join(', '));
        }

        // æ˜¾ç¤ºæµ‹è¯•è¿›è¡Œä¸­ç•Œé¢
        function showTestInProgress() {
            document.getElementById('test-selection').classList.add('hidden');
            document.getElementById('test-in-progress').classList.remove('hidden');
            document.getElementById('test-timer').classList.remove('hidden');
            
            console.log('ğŸ”„ åˆ‡æ¢åˆ°æµ‹è¯•è¿›è¡Œä¸­ç•Œé¢');
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            updateTimerDisplay();
            
            testState.timerInterval = setInterval(() => {
                testState.timeRemaining--;
                updateTimerDisplay();
                
                if (testState.timeRemaining <= 0) {
                    completeTest();
                }
                
                // æœ€å5åˆ†é’Ÿè­¦å‘Š
                if (testState.timeRemaining === 300) {
                    showTimeWarning('è¿˜å‰©5åˆ†é’Ÿï¼Œè¯·åˆç†å®‰æ’æ—¶é—´ï¼');
                }
            }, 1000);
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            const minutes = Math.floor(testState.timeRemaining / 60);
            const seconds = testState.timeRemaining % 60;
            const timerElement = document.getElementById('test-timer');
            const timeRemainingElement = document.getElementById('time-remaining');
            
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timerElement) timerElement.textContent = timeString;
            if (timeRemainingElement) timeRemainingElement.textContent = timeString;
            
            // æ—¶é—´ç´§å¼ æ—¶æ”¹å˜æ ·å¼
            if (testState.timeRemaining < 300) {
                if (timerElement) timerElement.classList.add('warning');
            }
        }

        // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º
        function initializeProgressDisplay() {
            const container = document.getElementById('dimension-progress');
            if (!container) {
                console.error('âŒ è¿›åº¦æ˜¾ç¤ºå®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            let html = '';
            
            testState.dimensions.forEach((dimension, index) => {
                const config = dimensionConfig[dimension];
                const isActive = index === testState.currentDimensionIndex;
                const dimensionAnswers = testState.answers[dimension] || [];
                const isCompleted = dimensionAnswers.length > 0 && dimensionAnswers.every(answer => answer !== undefined);
                
                html += `
                    <div class="dimension-progress p-4 rounded-lg cursor-pointer transition-all duration-300 ${
                        isActive ? 'active bg-blue-600 text-white' : 'bg-gray-100'
                    } ${isCompleted ? 'border-2 border-green-500' : ''}" 
                         onclick="navigateToDimension(${index})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="${config.icon} mr-3 ${isActive ? 'text-white' : 'text-gray-600'}"></i>
                                <span class="font-medium">${config.name}</span>
                            </div>
                            ${isCompleted ? '<i class="fas fa-check text-green-500"></i>' : ''}
                        </div>
                        <div class="text-sm mt-2 ${isActive ? 'text-blue-100' : 'text-gray-500'}">
                            ${testState.config.dimensions[dimension].count}é¢˜ Â· ${Math.floor(testState.config.dimensions[dimension].time / 60)}åˆ†é’Ÿ
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateOverallProgress();
        }

        // åŠ è½½å½“å‰é¢˜ç›® - ä¿®å¤ç‰ˆæœ¬
        function loadCurrentQuestion() {
            console.log('ğŸ“ åŠ è½½é¢˜ç›®:', {
                dimension: testState.currentDimension,
                index: testState.currentQuestionIndex,
                total: testState.currentQuestions.length
            });

            const question = testState.currentQuestion;
            if (!question) {
                console.warn('âš ï¸ å½“å‰é¢˜ç›®ä¸å­˜åœ¨ï¼Œå°è¯•ä¸‹ä¸€é¢˜');
                nextQuestion();
                return;
            }

            // æ›´æ–°ç»´åº¦ä¿¡æ¯
            const currentDimensionConfig = dimensionConfig[testState.currentDimension];
            document.getElementById('current-dimension-name').textContent = currentDimensionConfig.name;
            document.getElementById('current-dimension-desc').textContent = currentDimensionConfig.description;
            
            // æ›´æ–°é¢˜ç›®è¿›åº¦
            updateDimensionProgress();

            // æ¸²æŸ“é¢˜ç›®
            renderQuestion(question);
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            updateNavigationButtons();
            
            console.log('âœ… é¢˜ç›®åŠ è½½å®Œæˆ:', question.question.substring(0, 50) + '...');
        }

        // æ¸²æŸ“é¢˜ç›® - ä¿®å¤ç‰ˆæœ¬
        function renderQuestion(question) {
            const container = document.getElementById('question-content');
            const title = document.getElementById('question-title');
            
            if (!container || !title) {
                console.error('âŒ é¢˜ç›®å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            title.textContent = `${dimensionConfig[testState.currentDimension].name} - ç¬¬${testState.currentQuestionIndex + 1}é¢˜`;
            
            if (question.type === 'translation') {
                renderTranslationQuestion(question, container);
            } else {
                renderMultipleChoiceQuestion(question, container);
            }
        }

        // æ¸²æŸ“é€‰æ‹©é¢˜ - ä¿®å¤ç‰ˆæœ¬
        function renderMultipleChoiceQuestion(question, container) {
            const currentAnswer = testState.answers[testState.currentDimension] && 
                            testState.answers[testState.currentDimension][testState.currentQuestionIndex];
            
            let html = `
                <div class="question-content">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6 leading-relaxed">${question.question}</h3>
                    <div class="space-y-4" id="options-container">
            `;

            question.options.forEach((option, index) => {
                const isSelected = currentAnswer === index;
                const optionLetter = String.fromCharCode(65 + index);
                
                html += `
                    <div class="option-card p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 ${
                        isSelected ? 'selected border-blue-600 bg-blue-600 text-white' : 'border-gray-300 hover:border-blue-400'
                    }" onclick="selectAnswer(${index})">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full border-2 flex items-center justify-center mr-4 font-semibold ${
                                isSelected ? 'bg-white border-white text-blue-600' : 'border-gray-300 text-gray-600'
                            }">
                                ${optionLetter}
                            </div>
                            <span class="flex-1 text-lg">${option}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ¸²æŸ“ç¿»è¯‘é¢˜ - ä¿®å¤ç‰ˆæœ¬
        function renderTranslationQuestion(question, container) {
            const currentAnswer = testState.answers[testState.currentDimension] && 
                            testState.answers[testState.currentDimension][testState.currentQuestionIndex];
            
            container.innerHTML = `
                <div class="question-content">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 leading-relaxed">${question.question}</h3>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-6">
                        <h4 class="font-semibold text-yellow-800 text-lg mb-3 flex items-center">
                            <i class="fas fa-language mr-2"></i>
                            ç¿»è¯‘è¦æ±‚
                        </h4>
                        <p class="text-yellow-700">è¯·å°†ä¸­æ–‡å¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼Œæ³¨æ„è¯­æ³•å‡†ç¡®æ€§å’Œè¡¨è¾¾è‡ªç„¶åº¦ã€‚</p>
                    </div>

                    <div class="mb-6">
                        <textarea class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors" 
                                  placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„ç¿»è¯‘..." 
                                  rows="4"
                                  oninput="updateTranslationAnswer(this)">${currentAnswer || ''}</textarea>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">
                            <strong>æç¤º:</strong> æ³¨æ„æ—¶æ€ã€è¯­æ€ã€è¯æ±‡é€‰æ‹©å’Œå¥å­ç»“æ„çš„å‡†ç¡®æ€§ã€‚
                        </p>
                    </div>
                </div>
            `;
        }

        // é€‰æ‹©ç­”æ¡ˆ - ä¿®å¤ç‰ˆæœ¬
        function selectAnswer(answerIndex) {
            console.log('âœ… é€‰æ‹©ç­”æ¡ˆ:', {
                dimension: testState.currentDimension,
                questionIndex: testState.currentQuestionIndex,
                answerIndex: answerIndex
            });
            
            const dimension = testState.currentDimension;
            if (!testState.answers[dimension]) {
                testState.answers[dimension] = [];
            }
            testState.answers[dimension][testState.currentQuestionIndex] = answerIndex;
            
            updateNavigationButtons();
            
            // é‡æ–°æ¸²æŸ“é€‰é¡¹ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            if (testState.currentQuestion && testState.currentQuestion.type !== 'translation') {
                loadCurrentQuestion();
            }
        }

        // æ›´æ–°ç¿»è¯‘ç­”æ¡ˆ
        function updateTranslationAnswer(textarea) {
            selectAnswer(textarea.value);
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            const questions = testState.currentQuestions;
            console.log('â¡ï¸ ä¸‹ä¸€é¢˜:', {
                currentIndex: testState.currentQuestionIndex,
                total: questions.length
            });
            
            if (testState.currentQuestionIndex < questions.length - 1) {
                testState.currentQuestionIndex++;
                loadCurrentQuestion();
            } else {
                nextDimension();
            }
        }

        // ä¸Šä¸€é¢˜
        function previousQuestion() {
            console.log('â¬…ï¸ ä¸Šä¸€é¢˜:', {
                currentIndex: testState.currentQuestionIndex
            });
            
            if (testState.currentQuestionIndex > 0) {
                testState.currentQuestionIndex--;
                loadCurrentQuestion();
            }
        }

        // ä¸‹ä¸€ä¸ªç»´åº¦
        function nextDimension() {
            console.log('ğŸ”„ ä¸‹ä¸€ä¸ªç»´åº¦:', {
                currentDimensionIndex: testState.currentDimensionIndex,
                totalDimensions: testState.dimensions.length
            });
            
            if (testState.currentDimensionIndex < testState.dimensions.length - 1) {
                testState.currentDimensionIndex++;
                testState.currentQuestionIndex = 0;
                initializeProgressDisplay();
                loadCurrentQuestion();
            } else {
                completeTest();
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šç»´åº¦
        function navigateToDimension(index) {
            console.log('ğŸ“ è·³è½¬åˆ°ç»´åº¦:', index);
            
            testState.currentDimensionIndex = index;
            testState.currentQuestionIndex = 0;
            initializeProgressDisplay();
            loadCurrentQuestion();
        }

        // æ›´æ–°ç»´åº¦è¿›åº¦
        function updateDimensionProgress() {
            const questions = testState.currentQuestions;
            const currentProgress = testState.currentQuestionIndex + 1;
            const totalQuestions = questions.length;
            
            const progressElement = document.getElementById('dimension-question-progress');
            if (progressElement) {
                progressElement.textContent = `${currentProgress}/${totalQuestions}`;
            }
        }

        // æ›´æ–°æ€»ä½“è¿›åº¦
        function updateOverallProgress() {
            let completedDimensions = 0;
            testState.dimensions.forEach(dimension => {
                const dimensionAnswers = testState.answers[dimension] || [];
                const dimensionConfig = testState.config.dimensions[dimension];
                const isCompleted = dimensionAnswers.length >= dimensionConfig.count && 
                              dimensionAnswers.every(answer => answer !== undefined);
                
                if (isCompleted) {
                    completedDimensions++;
                }
            });
            
            const totalDimensions = testState.dimensions.length;
            const progressPercent = (completedDimensions / totalDimensions) * 100;
            
            const completedCountElement = document.getElementById('completed-count');
            const overallProgressElement = document.getElementById('overall-progress');
            
            if (completedCountElement) {
                completedCountElement.textContent = `${completedDimensions}/${totalDimensions}`;
            }
            
            if (overallProgressElement) {
                overallProgressElement.style.width = progressPercent + '%';
            }
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (!prevBtn || !nextBtn) return;
            
            // ä¸Šä¸€é¢˜æŒ‰é’®çŠ¶æ€
            prevBtn.disabled = testState.currentQuestionIndex === 0;
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // ä¸‹ä¸€é¢˜æŒ‰é’®çŠ¶æ€
            const dimension = testState.currentDimension;
            const hasAnswer = testState.answers[dimension] && 
                            testState.answers[dimension][testState.currentQuestionIndex] !== undefined;
            
            // å¯¹äºç¿»è¯‘é¢˜ï¼Œæ€»æ˜¯å¯ä»¥è¿›å…¥ä¸‹ä¸€é¢˜
            const currentQuestion = testState.currentQuestion;
            const isTranslation = currentQuestion && currentQuestion.type === 'translation';
            
            nextBtn.disabled = !hasAnswer && !isTranslation;
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // æ˜¾ç¤ºæ—¶é—´è­¦å‘Š
        function showTimeWarning(message) {
            if (window.uiManager) {
                window.uiManager.showLearningNotification(message, 'warning', 5000);
            }
        }

        // å®Œæˆæµ‹è¯• - ä¿®æ”¹åçš„ç‰ˆæœ¬ï¼Œç¡®ä¿æ­£ç¡®çš„æ‰§è¡Œé¡ºåº
        async function completeTest() {
            console.log('ğŸ‰ å®Œæˆæµ‹è¯• - å¼€å§‹æ•°æ®ä¿å­˜æµç¨‹');
            
            // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦å­˜åœ¨
            const token = getAuthToken();
            if (!token) {
                console.error('âŒ è®¤è¯ä»¤ç‰Œç¼ºå¤±ï¼Œæ— æ³•ä¿å­˜å­¦ä¹ è®°å½•');
                if (window.uiManager) {
                    window.uiManager.showMessage('è®¤è¯ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                }
                
                // ç›´æ¥è·³è½¬åˆ°åˆ†æé¡µé¢ï¼Œä¸ä¿å­˜å­¦ä¹ è®°å½•
                setTimeout(() => {
                    enhancedDataTransfer(testState.config.totalTime - testState.timeRemaining);
                }, 1000);
                return;
            }
            
            // åœæ­¢è®¡æ—¶å™¨
            if (testState.timerInterval) {
                clearInterval(testState.timerInterval);
            }
            
            // è®¡ç®—ç”¨æ—¶
            const timeSpent = testState.config.totalTime - testState.timeRemaining;
            
            // åˆ‡æ¢åˆ°å®Œæˆç•Œé¢
            document.getElementById('test-in-progress').classList.add('hidden');
            document.getElementById('test-completed').classList.remove('hidden');

            try {
                // 1. é¦–å…ˆä¿å­˜å­¦ä¹ æ´»åŠ¨å’Œç­¾åˆ°è®°å½•
                console.log('ğŸ”„ æ­¥éª¤1: ä¿å­˜å­¦ä¹ æ´»åŠ¨å’Œç­¾åˆ°è®°å½•');
                await saveLearningActivityAndCheckin(timeSpent);
                
                // 2. ç”Ÿæˆå®Œæ•´åˆ†ææ•°æ®
                console.log('ğŸ”„ æ­¥éª¤2: ç”Ÿæˆåˆ†ææ•°æ®');
                const completeAnalysisData = await generateCompleteAnalysisData(testState.answers, timeSpent);
                
                // 3. ä½¿ç”¨å¢å¼ºçš„æ•°æ®ä¼ é€’æ–¹æ¡ˆ
                console.log('ğŸ”„ æ­¥éª¤3: æ•°æ®ä¼ é€’');
                await enhancedDataTransfer(timeSpent);
                
                console.log('âœ… æ‰€æœ‰æ•°æ®ä¿å­˜å®Œæˆ');
                
            } catch (error) {
                console.error('ğŸ’¥ æµ‹è¯•å®Œæˆå¤„ç†å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
                if (window.uiManager) {
                    window.uiManager.showMessage('éƒ¨åˆ†æ•°æ®ä¿å­˜å¤±è´¥ï¼Œä½†åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ', 'warning');
                }
                
                // å³ä½¿ä¿å­˜å¤±è´¥ï¼Œä¹Ÿè¦ç»§ç»­æ•°æ®ä¼ é€’
                fallbackDataTransfer();
            }
        }

        // æ”¹è¿›çš„è®¤è¯tokenè·å–å‡½æ•°
        function getAuthToken() {
            // å°è¯•å¤šç§æ–¹å¼è·å–token
            let token = '';
            
            // 1. é¦–å…ˆå°è¯•ä»ç»Ÿä¸€è®¤è¯ç®¡ç†å™¨è·å–
            const authManager = window.unifiedAuthManager || window.authManager;
            if (authManager) {
                if (typeof authManager.getToken === 'function') {
                    token = authManager.getToken();
                }
                // å¦‚æœgetTokenä¸å­˜åœ¨ï¼Œå°è¯•ç›´æ¥è®¿é—®tokenå±æ€§
                else if (authManager.token) {
                    token = authManager.token;
                }
            }
            
            // 2. å¦‚æœè®¤è¯ç®¡ç†å™¨æ²¡æœ‰ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–
            if (!token) {
                // å°è¯•æ‰€æœ‰å¯èƒ½çš„å­˜å‚¨é”®
                const possibleKeys = [
                    'auth_token', 'token', 'user_token', 'access_token',
                    'authToken', 'userToken', 'accessToken'
                ];
                
                for (const key of possibleKeys) {
                    token = localStorage.getItem(key) || sessionStorage.getItem(key);
                    if (token) break;
                }
            }
            
            // 3. å¦‚æœè¿˜æ²¡æœ‰ï¼Œå°è¯•ä»å½“å‰ç”¨æˆ·ä¿¡æ¯è·å–
            if (!token && authManager && authManager.getCurrentUser) {
                const user = authManager.getCurrentUser();
                if (user && user.token) {
                    token = user.token;
                }
            }
            
            // 4. æœ€åå°è¯•ä»URLå‚æ•°è·å–ï¼ˆå¦‚æœæœ‰ï¼‰
            if (!token) {
                const urlParams = new URLSearchParams(window.location.search);
                token = urlParams.get('token') || urlParams.get('auth_token');
            }
            
            if (!token) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°è®¤è¯tokenï¼Œç”¨æˆ·å¯èƒ½æœªç™»å½•');
                console.log('ğŸ” è°ƒè¯•è®¤è¯çŠ¶æ€:', {
                    unifiedAuthManager: !!window.unifiedAuthManager,
                    authManager: !!window.authManager,
                    localStorageKeys: Object.keys(localStorage).filter(key => 
                        key.toLowerCase().includes('token') || key.toLowerCase().includes('auth')
                    )
                });
            } else {
                console.log('âœ… Tokenè·å–æˆåŠŸï¼Œé•¿åº¦:', token.length);
            }
            
            return token;
        }

        // ä¿®æ”¹ä¿å­˜å‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®ä¿å­˜åˆ°ä¸¤ä¸ªè¡¨
        async function saveLearningActivityAndCheckin(timeSpent) {
            try {
                console.log('ğŸ“Š å¼€å§‹ä¿å­˜å­¦ä¹ æ´»åŠ¨å’Œç­¾åˆ°è®°å½•...');
                
                // è®¡ç®—åˆ†æ•°
                const scoreResult = calculateScoreFromAnswers(testState.answers, testState.questions);
                
                // 1. ä¿å­˜å­¦ä¹ æ´»åŠ¨è®°å½•åˆ° learning_activities è¡¨
                console.log('ğŸ’¾ ä¿å­˜å­¦ä¹ æ´»åŠ¨è®°å½•åˆ° learning_activities è¡¨...');
                const activityResult = await saveLearningActivity({
                    activity_type: 'assessment_test',
                    activity_data: {
                        exam_type: testState.currentExamType,
                        overall_score: scoreResult.overallPercentage,
                        total_questions: scoreResult.totalQuestions,
                        correct_answers: scoreResult.totalCorrect,
                        dimensions: scoreResult.dimensionScores,
                        time_spent: timeSpent,
                        test_date: new Date().toISOString(),
                        user_id: testState.userId
                    },
                    duration: Math.floor(timeSpent / 60),
                    time_spent: timeSpent,
                    score: scoreResult.overallPercentage,
                    total_questions: scoreResult.totalQuestions,
                    correct_answers: scoreResult.totalCorrect,
                    study_words_count: 0,
                    mastered_words_count: 0,
                    streak_bonus: 0,
                    date: new Date().toISOString().split('T')[0]
                });
                
                console.log('âœ… å­¦ä¹ æ´»åŠ¨ä¿å­˜ç»“æœ:', activityResult);
                
                // 2. æ›´æ–°ç­¾åˆ°è®°å½•åˆ° user_checkins è¡¨
                console.log('ğŸ“… æ›´æ–°ç­¾åˆ°è®°å½•åˆ° user_checkins è¡¨...');
                const checkinResult = await updateUserCheckin();
                console.log('âœ… ç­¾åˆ°è®°å½•æ›´æ–°ç»“æœ:', checkinResult);
                
                console.log('ğŸ¯ å­¦ä¹ æ´»åŠ¨å’Œç­¾åˆ°è®°å½•ä¿å­˜æˆåŠŸ');
                return { activityResult, checkinResult };
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å­¦ä¹ æ´»åŠ¨å’Œç­¾åˆ°è®°å½•å¤±è´¥:', error);
                throw error;
            }
        }

        // æ”¹è¿›çš„ä¿å­˜å­¦ä¹ æ´»åŠ¨å‡½æ•°ï¼Œå®Œå…¨åŒ¹é…æ•°æ®åº“ç»“æ„
        async function saveLearningActivity(activityData) {
            const maxRetries = 2;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ğŸ“ å°è¯•ä¿å­˜å­¦ä¹ æ´»åŠ¨ (ç¬¬${attempt}æ¬¡)`, activityData);
                    
                    const token = getAuthToken();
                    if (!token) {
                        console.warn('âš ï¸ è·³è¿‡å­¦ä¹ æ´»åŠ¨ä¿å­˜ï¼šæ— è®¤è¯ä»¤ç‰Œ');
                        return { success: false, message: 'æ— è®¤è¯ä»¤ç‰Œ' };
                    }
                    
                    // æ„å»ºå®Œå…¨åŒ¹é…æ•°æ®åº“å­—æ®µçš„æ•°æ®
                    const requestData = {
                        activity_type: activityData.activity_type,
                        activity_data: typeof activityData.activity_data === 'string' 
                            ? activityData.activity_data 
                            : JSON.stringify(activityData.activity_data || {}),
                        duration: parseInt(activityData.duration) || 0,
                        time_spent: parseInt(activityData.time_spent) || 0,
                        score: parseFloat(activityData.score) || 0,
                        total_questions: parseInt(activityData.total_questions) || 0,
                        correct_answers: parseInt(activityData.correct_answers) || 0,
                        study_words_count: parseInt(activityData.study_words_count) || 0,
                        mastered_words_count: parseInt(activityData.mastered_words_count) || 0,
                        streak_bonus: parseInt(activityData.streak_bonus) || 0,
                        date: activityData.date || new Date().toISOString().split('T')[0]
                    };

                    console.log('ğŸ“¤ å‘é€çš„å­¦ä¹ æ´»åŠ¨æ•°æ®:', requestData);

                    const response = await fetch('/api/learning/activities', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('ğŸ“¡ å­¦ä¹ æ´»åŠ¨APIå“åº”çŠ¶æ€:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`âŒ å­¦ä¹ æ´»åŠ¨APIé”™è¯¯å“åº” (ç¬¬${attempt}æ¬¡):`, errorText);
                        
                        if (response.status === 401) {
                            console.warn('ğŸ” è®¤è¯å¤±è´¥ï¼Œè·³è¿‡å­¦ä¹ æ´»åŠ¨ä¿å­˜');
                            return { success: false, message: 'è®¤è¯å¤±è´¥' };
                        }
                        
                        if (attempt === maxRetries) {
                            throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                        continue;
                    }

                    const result = await response.json();
                    console.log('âœ… å­¦ä¹ æ´»åŠ¨è®°å½•ä¿å­˜æˆåŠŸ:', result);
                    return result;
                    
                } catch (error) {
                    console.error(`ğŸ’¥ ä¿å­˜å­¦ä¹ æ´»åŠ¨è®°å½•å¤±è´¥ (ç¬¬${attempt}æ¬¡):`, error);
                    
                    if (attempt === maxRetries) {
                        return { success: false, message: error.message };
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
            
            return { success: false, message: 'ä¿å­˜å¤±è´¥' };
        }

        // æ”¹è¿›çš„æ›´æ–°ç­¾åˆ°å‡½æ•°
        async function updateUserCheckin() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                console.log('ğŸ“… å‡†å¤‡æ›´æ–°ç­¾åˆ°è®°å½•ï¼Œæ—¥æœŸ:', today);
                
                const token = getAuthToken();
                if (!token) {
                    console.warn('âš ï¸ è·³è¿‡ç­¾åˆ°æ›´æ–°ï¼šæ— è®¤è¯ä»¤ç‰Œ');
                    return { success: false, message: 'æ— è®¤è¯ä»¤ç‰Œ' };
                }
                
                const response = await fetch('/api/user/checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        checkin_date: today
                    })
                });

                console.log('ğŸ“¡ ç­¾åˆ°APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ ç­¾åˆ°APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                }

                const result = await response.json();
                console.log('âœ… ç­¾åˆ°è®°å½•æ›´æ–°æˆåŠŸ:', result);
                return result;
                
            } catch (error) {
                console.error('æ›´æ–°ç­¾åˆ°è®°å½•å¤±è´¥:', error);
                throw error;
            }
        }

        // æ–°å¢ï¼šå¢å¼ºæ•°æ®ä¼ é€’å‡½æ•°
        async function enhancedDataTransfer(timeSpent) {
            console.log('ğŸš€ ä½¿ç”¨å¢å¼ºæ•°æ®ä¼ é€’æ–¹æ¡ˆ...');
            
            // æ˜¾ç¤ºåˆ†æçŠ¶æ€
            analysisState.updateStatus('start', 'æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...');
            
            // 1. ç”Ÿæˆå®Œæ•´çš„åˆ†ææ•°æ®
            const completeAnalysisData = await generateCompleteAnalysisData(testState.answers, timeSpent);
            console.log('âœ… å®Œæ•´åˆ†ææ•°æ®ç”Ÿæˆå®Œæˆ', completeAnalysisData);
            
            // 2. å¤šé‡å­˜å‚¨ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
            const storageKeys = [
                'current_ai_analysis',
                'FORCE_ANALYSIS_DATA', 
                'last_ai_analysis',
                'analysis_report_data'
            ];
            
            storageKeys.forEach(key => {
                localStorage.setItem(key, JSON.stringify(completeAnalysisData));
            });
            
            // 3. ä¿å­˜åˆ°sessionStorage
            sessionStorage.setItem('temp_analysis_data', JSON.stringify(completeAnalysisData));
            sessionStorage.setItem('backup_analysis_data', JSON.stringify(completeAnalysisData));
            
            // 4. ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Š
            const analysisReport = generateDetailedAnalysisReport(completeAnalysisData);
            localStorage.setItem('analysis_report', JSON.stringify(analysisReport));
            
            // 5. ä½¿ç”¨URLå‚æ•°ä¼ é€’å…³é”®ä¿¡æ¯
            const urlParams = new URLSearchParams({
                analysis_id: Date.now().toString(),
                exam_type: testState.currentExamType,
                overall_score: completeAnalysisData.assessment.overallScore,
                timestamp: new Date().getTime().toString(),
                fresh: 'true',
                enhanced: 'true'
            });
            
            // 6. æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            analysisState.updateStatus('success', 'åˆ†æå®Œæˆï¼å³å°†è·³è½¬...');
            
            // 7. ç¡®ä¿æ•°æ®ä¿å­˜å®Œæˆåå†è·³è½¬
            setTimeout(() => {
                const analysisUrl = `äº‘æ¢¦æ™ºé—´å­¦ä¹ åˆ†æ.html?${urlParams.toString()}`;
                console.log('ğŸ”— è·³è½¬åˆ°åˆ†æé¡µé¢:', analysisUrl);
                window.location.href = analysisUrl;
            }, 1500);
        }

        // æ–°å¢ï¼šå¤‡ç”¨æ•°æ®ä¼ é€’æ–¹æ¡ˆ
        function fallbackDataTransfer() {
            console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æ•°æ®ä¼ é€’æ–¹æ¡ˆ');
            
            const basicData = generateBasicAnalysisData();
            
            // å¤šé‡å­˜å‚¨
            localStorage.setItem('current_ai_analysis', JSON.stringify(basicData));
            localStorage.setItem('FORCE_ANALYSIS_DATA', JSON.stringify(basicData));
            sessionStorage.setItem('temp_analysis_data', JSON.stringify(basicData));
            
            analysisState.updateStatus('success', 'ä½¿ç”¨åŸºç¡€åˆ†ææ•°æ®...');
            
            setTimeout(() => {
                window.location.href = 'äº‘æ¢¦æ™ºé—´å­¦ä¹ åˆ†æ.html?fallback=true';
            }, 1500);
        }

        // ====================================================================
        // æ•°æ®ç”Ÿæˆå‡½æ•°
        // ====================================================================

        // ç”Ÿæˆå®Œæ•´çš„åˆ†ææ•°æ®
        async function generateCompleteAnalysisData(answers, timeSpent) {
            // è®¡ç®—åˆ†æ•°
            const scoreResult = calculateScoreFromAnswers(answers, testState.questions);
            
            // ç”Ÿæˆèƒ½åŠ›å›¾è°±æ•°æ®
            const abilityMap = generateAbilityMapData(scoreResult.dimensionScores);
            
            // ç”Ÿæˆè–„å¼±ç‚¹åˆ†æ
            const weakPoints = generateWeakPointsAnalysis(scoreResult.dimensionScores);
            
            // ç”Ÿæˆå­¦ä¹ è·¯å¾„
            const learningPath = generateLearningPath(weakPoints, scoreResult.overallPercentage);
            
            // ç”Ÿæˆè¯¦ç»†å­¦ä¹ è®¡åˆ’
            const detailedLearningPlan = generateDetailedLearningPlan(weakPoints, scoreResult.overallPercentage);
            
            // ç”ŸæˆæŠ—é—å¿˜å¤ä¹ è®¡åˆ’
            const reviewPlan = generateAntiForgettingReviewPlan(weakPoints, scoreResult.dimensionScores);
            
            return {
                metadata: {
                    timestamp: new Date().toISOString(),
                    examType: testState.currentExamType,
                    generatedBy: 'enhanced_system_v2',
                    dataVersion: '3.0',
                    userId: testState.userId,
                    timeSpent: timeSpent
                },
                
                assessment: {
                    overallScore: scoreResult.overallPercentage,
                    overallPercentage: scoreResult.overallPercentage,
                    level: getCEFRLevel(scoreResult.overallPercentage),
                    dimensionScores: scoreResult.dimensionScores,
                    examType: testState.currentExamType,
                    testDate: new Date().toISOString(),
                    timeSpent: timeSpent
                },
                
                abilityAnalysis: {
                    overallScore: scoreResult.overallPercentage,
                    level: getCEFRLevel(scoreResult.overallPercentage),
                    abilityMap: abilityMap,
                    weakPoints: weakPoints
                },
                
                abilityMap: abilityMap,
                weakPoints: weakPoints,
                learningPath: {
                    ...learningPath,
                    weeklyPlans: detailedLearningPlan.weeklyPlans
                },
                detailedLearningPlan: detailedLearningPlan,
                reviewPlan: reviewPlan,
                
                recommendations: [
                    {
                        message: generateRecommendationMessage(scoreResult.overallPercentage, weakPoints),
                        actions: generateRecommendedActions(weakPoints),
                        priority: 'high'
                    }
                ]
            };
        }

        // ç”Ÿæˆèƒ½åŠ›å›¾è°±æ•°æ®
        function generateAbilityMapData(dimensionScores) {
            const dimensions = ['vocabulary', 'grammar', 'reading', 'translation'];
            const dataPoints = dimensions.map(dimension => {
                const score = dimensionScores[dimension]?.percentage || 70;
                return {
                    dimension: dimension,
                    displayName: dimensionConfig[dimension].name,
                    score: score,
                    weight: 0.25
                };
            });
            
            return { dataPoints };
        }

        // ç”Ÿæˆè–„å¼±ç‚¹åˆ†æ
        function generateWeakPointsAnalysis(dimensionScores) {
            const weakPoints = [];
            Object.entries(dimensionScores).forEach(([dimension, scoreInfo]) => {
                if (scoreInfo.percentage < 70) {
                    weakPoints.push({
                        dimension: dimension,
                        displayName: dimensionConfig[dimension].name,
                        score: scoreInfo.percentage,
                        priority: scoreInfo.percentage < 60 ? 'high' : 'medium',
                        knowledgeGaps: generateKnowledgeGaps(dimension),
                        recommendedActions: generateDimensionActions(dimension)
                    });
                }
            });
            
            return weakPoints;
        }

        // ç”Ÿæˆå­¦ä¹ è·¯å¾„
        function generateLearningPath(weakPoints, overallScore) {
            const focusAreas = weakPoints.length > 0 ? 
                weakPoints.map(wp => wp.displayName) : ['ç»¼åˆèƒ½åŠ›æå‡'];
            
            return {
                duration: "4å‘¨",
                focusAreas: focusAreas,
                expectedImprovement: "+15-20åˆ†"
            };
        }

        // ç”Ÿæˆè¯¦ç»†å­¦ä¹ è®¡åˆ’
        function generateDetailedLearningPlan(weakPoints, overallScore) {
            const weeklyPlans = [];
            const focusAreas = weakPoints.length > 0 ? 
                weakPoints.map(wp => wp.displayName) : ['ç»¼åˆèƒ½åŠ›æå‡'];
            
            for (let week = 1; week <= 4; week++) {
                const dailyTasks = [];
                for (let day = 1; day <= 7; day++) {
                    const tasks = [];
                    
                    // æ ¹æ®å‘¨æ•°è°ƒæ•´ä»»åŠ¡éš¾åº¦
                    if (week <= 2) {
                        // åŸºç¡€å·©å›ºå‘¨
                        tasks.push(
                            { type: 'grammar', duration: 30, content: 'åŸºç¡€è¯­æ³•ç»ƒä¹ ' },
                            { type: 'vocabulary', duration: 25, content: 'æ ¸å¿ƒè¯æ±‡è®°å¿†' },
                            { type: 'reading', duration: 20, content: 'çŸ­æ–‡é˜…è¯»ç†è§£' }
                        );
                    } else {
                        // èƒ½åŠ›æå‡å‘¨
                        tasks.push(
                            { type: 'grammar', duration: 35, content: 'é«˜çº§è¯­æ³•åº”ç”¨' },
                            { type: 'vocabulary', duration: 30, content: 'é«˜çº§è¯æ±‡æ‹“å±•' },
                            { type: 'reading', duration: 25, content: 'é•¿ç¯‡æ–‡ç« åˆ†æ' },
                            { type: 'translation', duration: 20, content: 'ä¸­è‹±äº’è¯‘ç»ƒä¹ ' }
                        );
                    }
                    
                    dailyTasks.push({
                        day: day,
                        tasks: tasks,
                        completed: false
                    });
                }
                
                weeklyPlans.push({
                    week: week,
                    focus: week <= 2 ? 'åŸºç¡€å·©å›º' : 'èƒ½åŠ›æå‡',
                    focusAreas: focusAreas,
                    dailyTasks: dailyTasks,
                    weeklyGoals: [
                        `æŒæ¡${week * 3}ä¸ªæ–°çŸ¥è¯†ç‚¹`,
                        `å®Œæˆ${week * 5}ä¸ªç»ƒä¹ ä»»åŠ¡`,
                        `æå‡${week * 5}åˆ†èƒ½åŠ›å¾—åˆ†`
                    ],
                    progress: 0
                });
            }
            
            return {
                duration: "4å‘¨",
                totalTasks: 28,
                completedTasks: 0,
                weeklyPlans: weeklyPlans,
                focusAreas: focusAreas
            };
        }

        // ç”ŸæˆæŠ—é—å¿˜å¤ä¹ è®¡åˆ’
        function generateAntiForgettingReviewPlan(weakPoints, dimensionScores) {
            const reviewSchedule = [];
            const today = new Date();
            
            // é—å¿˜æ›²çº¿å¤ä¹ é—´éš”ï¼š1å¤©ã€2å¤©ã€4å¤©ã€7å¤©ã€15å¤©
            const intervals = [1, 2, 4, 7, 15];
            
            weakPoints.forEach((weakPoint, index) => {
                intervals.forEach(interval => {
                    const reviewDate = new Date(today);
                    reviewDate.setDate(today.getDate() + interval);
                    
                    reviewSchedule.push({
                        id: `review-${index}-${interval}`,
                        knowledgePoint: weakPoint.displayName,
                        dimension: weakPoint.dimension,
                        dueDate: reviewDate.toISOString(),
                        status: 'pending',
                        priority: weakPoint.priority,
                        reviewType: getReviewType(interval),
                        estimatedTime: getReviewTime(weakPoint.priority),
                        materials: generateReviewMaterials(weakPoint.dimension)
                    });
                });
            });
            
            // å¦‚æœæ²¡æœ‰è–„å¼±ç‚¹ï¼Œç”Ÿæˆé€šç”¨å¤ä¹ è®¡åˆ’
            if (reviewSchedule.length === 0) {
                intervals.forEach(interval => {
                    const reviewDate = new Date(today);
                    reviewDate.setDate(today.getDate() + interval);
                    
                    reviewSchedule.push({
                        id: `general-${interval}`,
                        knowledgePoint: 'ç»¼åˆèƒ½åŠ›å¤ä¹ ',
                        dimension: 'general',
                        dueDate: reviewDate.toISOString(),
                        status: 'pending',
                        priority: 'medium',
                        reviewType: getReviewType(interval),
                        estimatedTime: 30,
                        materials: ['ç»¼åˆç»ƒä¹ é¢˜', 'æ¨¡æ‹Ÿæµ‹è¯•', 'é”™é¢˜å›é¡¾']
                    });
                });
            }
            
            return {
                totalReviews: reviewSchedule.length,
                completedReviews: 0,
                nextReview: reviewSchedule[0]?.dueDate || today.toISOString(),
                schedule: reviewSchedule
            };
        }

        // è¾…åŠ©å‡½æ•°
        function getReviewType(interval) {
            const types = {
                1: 'çŸ­æœŸè®°å¿†å·©å›º',
                2: 'ä¸­æœŸè®°å¿†å¼ºåŒ–', 
                4: 'é•¿æœŸè®°å¿†å»ºç«‹',
                7: 'æ·±åº¦è®°å¿†å·©å›º',
                15: 'æ°¸ä¹…è®°å¿†å¼ºåŒ–'
            };
            return types[interval] || 'å¸¸è§„å¤ä¹ ';
        }

        function getReviewTime(priority) {
            const times = {
                high: 45,
                medium: 30,
                low: 20
            };
            return times[priority] || 25;
        }

        function generateReviewMaterials(dimension) {
            const materials = {
                vocabulary: ['è¯æ±‡å¡ç‰‡', 'åŒä¹‰è¯ç»ƒä¹ ', 'è¯æ ¹è¯ç¼€è®°å¿†'],
                grammar: ['è¯­æ³•ä¸“é¡¹ç»ƒä¹ ', 'å¥å­æ”¹é”™', 'è¯­æ³•å¡«ç©º'],
                reading: ['é˜…è¯»ç†è§£ç»ƒä¹ ', 'é€Ÿè¯»è®­ç»ƒ', 'ä¸»æ—¨æ¦‚æ‹¬'],
                translation: ['ç¿»è¯‘ç»ƒä¹ ', 'åœ°é“è¡¨è¾¾ç§¯ç´¯', 'æ–‡åŒ–èƒŒæ™¯å­¦ä¹ '],
                general: ['ç»¼åˆç»ƒä¹ é¢˜', 'æ¨¡æ‹Ÿæµ‹è¯•', 'é”™é¢˜å›é¡¾']
            };
            return materials[dimension] || materials.general;
        }

        // ç”ŸæˆçŸ¥è¯†ç¼ºå£
        function generateKnowledgeGaps(dimension) {
            const gaps = {
                vocabulary: ['é«˜çº§è¯æ±‡', 'å›ºå®šæ­é…', 'è¯ä¹‰è¾¨æ'],
                grammar: ['å¤æ‚å¥å‹', 'æ—¶æ€è¯­æ€', 'è™šæ‹Ÿè¯­æ°”'],
                reading: ['é•¿éš¾å¥åˆ†æ', 'æ¨ç†åˆ¤æ–­', 'ä¸»æ—¨æ¦‚æ‹¬'],
                translation: ['åœ°é“è¡¨è¾¾', 'æ–‡åŒ–å·®å¼‚', 'å¥å¼è½¬æ¢']
            };
            return gaps[dimension] || ['åŸºç¡€çŸ¥è¯†ç‚¹'];
        }

        // ç”Ÿæˆç»´åº¦è¡ŒåŠ¨å»ºè®®
        function generateDimensionActions(dimension) {
            const actions = {
                vocabulary: ['æ¯æ—¥è¯æ±‡è®°å¿†', 'é˜…è¯»æ‰©å±•', 'è¯æ±‡åº”ç”¨ç»ƒä¹ '],
                grammar: ['è¯­æ³•ä¸“é¡¹è®­ç»ƒ', 'å¥å­æ”¹é”™', 'è¯­æ³•å¡«ç©º'],
                reading: ['ç²¾è¯»è®­ç»ƒ', 'é€Ÿè¯»ç»ƒä¹ ', 'é˜…è¯»ç†è§£æŠ€å·§'],
                translation: ['ä¸­è‹±äº’è¯‘ç»ƒä¹ ', 'åœ°é“è¡¨è¾¾ç§¯ç´¯', 'æ–‡åŒ–èƒŒæ™¯å­¦ä¹ ']
            };
            return actions[dimension] || ['ä¸“é¡¹ç»ƒä¹ ', 'æ¨¡æ‹Ÿæµ‹è¯•'];
        }

        // ç”Ÿæˆæ¨èæ¶ˆæ¯
        function generateRecommendationMessage(overallScore, weakPoints) {
            if (overallScore >= 85) {
                return 'æ‚¨çš„è‹±è¯­èƒ½åŠ›ä¼˜ç§€ï¼Œå»ºè®®ç»§ç»­ä¿æŒå¹¶æ‹“å±•é«˜çº§åº”ç”¨èƒ½åŠ›';
            } else if (overallScore >= 70) {
                return 'æ‚¨çš„è‹±è¯­èƒ½åŠ›è‰¯å¥½ï¼Œå»ºè®®é’ˆå¯¹è–„å¼±ç¯èŠ‚è¿›è¡Œä¸“é¡¹æå‡';
            } else {
                return 'æ‚¨çš„è‹±è¯­èƒ½åŠ›éœ€è¦ç³»ç»Ÿæå‡ï¼Œå»ºè®®ä»åŸºç¡€å¼€å§‹é€æ­¥åŠ å¼º';
            }
        }

        // ç”Ÿæˆæ¨èè¡ŒåŠ¨
        function generateRecommendedActions(weakPoints) {
            const actions = ['æ¯æ—¥åšæŒå­¦ä¹ ', 'å®šæœŸæ¨¡æ‹Ÿæµ‹è¯•'];
            if (weakPoints.length > 0) {
                actions.push('è–„å¼±ç¯èŠ‚ä¸“é¡¹è®­ç»ƒ');
            }
            return actions;
        }

        // ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Š
        function generateDetailedAnalysisReport(analysisData) {
            return {
                summary: `æ‚¨çš„${analysisData.assessment.examType === 'CET4' ? 'å››çº§' : 'å…­çº§'}è¯„ä¼°å¾—åˆ†: ${analysisData.assessment.overallScore}åˆ†`,
                strengths: analysisData.weakPoints.length === 0 ? ['å„é¡¹èƒ½åŠ›å‡è¡¡å‘å±•'] : 
                    Object.entries(analysisData.assessment.dimensionScores)
                        .filter(([_, score]) => score.percentage >= 80)
                        .map(([dim]) => dimensionConfig[dim].name),
                improvementAreas: analysisData.weakPoints.map(wp => wp.displayName),
                studyPlan: analysisData.learningPath
            };
        }

        // è®¡ç®—åˆ†æ•°
        function calculateScoreFromAnswers(answers, questions) {
            let totalCorrect = 0;
            let totalQuestions = 0;
            const dimensionScores = {};

            Object.keys(questions).forEach(dimension => {
                const dimensionQuestions = questions[dimension];
                const dimensionAnswers = answers[dimension] || [];
                
                let correctCount = 0;
                dimensionQuestions.forEach((question, index) => {
                    if (index < dimensionAnswers.length) {
                        const userAnswer = dimensionAnswers[index];
                        const isCorrect = checkAnswer(userAnswer, question.correctAnswer);
                        if (isCorrect) correctCount++;
                        totalQuestions++;
                    }
                });
                
                const percentage = dimensionQuestions.length > 0 ? 
                    Math.round((correctCount / dimensionQuestions.length) * 100) : 70;
                
                dimensionScores[dimension] = {
                    percentage: percentage,
                    correct: correctCount,
                    total: dimensionQuestions.length,
                    score: percentage
                };
                
                totalCorrect += correctCount;
            });

            const overallPercentage = totalQuestions > 0 ? 
                Math.round((totalCorrect / totalQuestions) * 100) : 70;

            return {
                overallPercentage: overallPercentage,
                dimensionScores: dimensionScores,
                totalCorrect: totalCorrect,
                totalQuestions: totalQuestions
            };
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(userAnswer, correctAnswer) {
            // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ¯”è¾ƒé€‰é¡¹ç´¢å¼•
            if (typeof userAnswer === 'number') {
                const optionLetters = ['A', 'B', 'C', 'D'];
                const userAnswerLetter = optionLetters[userAnswer];
                return userAnswerLetter === correctAnswer;
            }
            // å¯¹äºç¿»è¯‘é¢˜ï¼Œç®€å•æ¯”è¾ƒï¼ˆå®é™…åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„ç®—æ³•ï¼‰
            else if (typeof userAnswer === 'string') {
                return userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
            }
            return false;
        }

        // è·å–CEFRç­‰çº§
        function getCEFRLevel(score) {
            if (score >= 90) return 'C2';
            if (score >= 80) return 'C1';
            if (score >= 70) return 'B2';
            if (score >= 60) return 'B1';
            if (score >= 50) return 'A2';
            return 'A1';
        }

        // åŸºç¡€åˆ†ææ•°æ®ï¼ˆé™çº§ç”¨ï¼‰
        function generateBasicAnalysisData() {
            return {
                metadata: {
                    timestamp: new Date().toISOString(),
                    examType: 'CET4',
                    generatedBy: 'basic_fallback',
                    dataVersion: '1.0'
                },
                assessment: {
                    overallScore: 75,
                    level: 'B1',
                    examType: 'CET4',
                    testDate: new Date().toISOString()
                },
                abilityAnalysis: {
                    overallScore: 75,
                    level: 'B1',
                    abilityMap: {
                        dataPoints: [
                            { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: 75, weight: 0.25 },
                            { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: 68, weight: 0.25 },
                            { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: 82, weight: 0.25 },
                            { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: 71, weight: 0.25 }
                        ]
                    },
                    weakPoints: [
                        {
                            dimension: 'grammar',
                            displayName: 'è¯­æ³•èƒ½åŠ›',
                            score: 68,
                            priority: 'medium',
                            knowledgeGaps: ['æ—¶æ€è¯­æ€', 'ä»å¥ç»“æ„'],
                            recommendedActions: ['è¯­æ³•ä¸“é¡¹ç»ƒä¹ ', 'å¥å­æ”¹é”™è®­ç»ƒ']
                        }
                    ]
                }
            };
        }

        // æŸ¥çœ‹è¯¦ç»†åˆ†æ
        function viewDetailedAnalysis() {
            window.location.href = 'äº‘æ¢¦æ™ºé—´å­¦ä¹ åˆ†æ.html';
        }
    </script>
</body>
</html>