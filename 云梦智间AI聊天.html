<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘æ¢¦æ™ºé—´ AI - ä½ çš„æ™ºèƒ½å­¦ä¹ ä¼™ä¼´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2962FF',
                        secondary: '#1A237E',
                        aiBg: '#F8FAFF',
                        userBg: '#2962FF',
                        accent: '#FF6D00',
                        lightBg: '#F5F7FF'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '2px',
                        DEFAULT: '4px',
                        'md': '8px',
                        'lg': '12px',
                        'xl': '16px',
                        '2xl': '20px',
                        '3xl': '24px',
                        'full': '9999px'
                    },
                    fontFamily: {
                        'sans': ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif'],
                        'content': ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif']
                    },
                    boxShadow: {
                        'message': '0 2px 8px rgba(0, 0, 0, 0.08)',
                        'input': '0 4px 12px rgba(41, 98, 255, 0.1)',
                        'card': '0 4px 12px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #F5F7FF;
        }
        
        /* ä¿®æ”¹ç”¨æˆ·æ¶ˆæ¯æ ·å¼ - æ›´æŸ”å’Œçš„è“è‰²ï¼Œç™½è‰²æ–‡å­— */
        .message-user {
            background: linear-gradient(135deg, #4A7BFF 0%, #3A6BEF 100%);
            color: white;
            border-radius: 16px 0 16px 16px;
            position: relative;
            box-shadow: 0 4px 12px rgba(74, 123, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-user::after {
            content: "";
            position: absolute;
            right: -8px;
            top: 0;
            width: 8px;
            height: 16px;
            background: linear-gradient(135deg, #4A7BFF 0%, #3A6BEF 100%);
            clip-path: polygon(0 0, 0 100%, 100% 0);
        }

        /* AIæ¶ˆæ¯æ ·å¼å¾®è°ƒ */
        .message-assistant {
            background: #F8FAFF;
            border-radius: 0 16px 16px 16px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .message-assistant::before {
            content: "";
            position: absolute;
            left: -8px;
            top: 0;
            width: 8px;
            height: 16px;
            background: #F8FAFF;
            clip-path: polygon(0 0, 100% 0, 100% 100%);
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #2962FF;
            border-radius: 50%;
            margin-right: 4px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 3px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(136, 136, 136, 0.3);
            border-radius: 3px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: rgba(85, 85, 85, 0.5);
        }
        
        .input-box {
            transition: all 0.2s ease;
            min-height: 48px;
            max-height: 200px;
        }
        
        /* å¢å¼ºè¾“å…¥åŒºåŸŸæ ·å¼ */
        .input-box:focus {
            box-shadow: 0 0 0 2px rgba(74, 123, 255, 0.2);
            border-color: #4A7BFF;
        }
        
        /* å‘é€æŒ‰é’®æ ·å¼å¢å¼º */
        .send-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(74, 123, 255, 0.3);
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 123, 255, 0.4);
        }

        .send-btn:active {
            transform: translateY(0);
        }
        
        .tooltip {
            opacity: 0;
            transition: all 0.2s ease;
            pointer-events: none;
        }
        
        .tooltip-parent:hover .tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        .sidebar {
            transition: all 0.3s ease;
            transform: translateX(-100%);
        }
        
        .sidebar-open {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay-open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .welcome-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 16px;
            box-sizing: border-box;
        }
        
        /* è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 16px 0;
        }
        
        .input-wrapper {
            padding: 0 16px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* èŠå¤©å†…å®¹åŒºåŸŸ */
        .chat-content-container {
            position: fixed;
            top: 72px; /* é¡¶éƒ¨å¯¼èˆªæ é«˜åº¦ */
            bottom: 150px; /* è¾“å…¥æ¡†åŒºåŸŸé«˜åº¦ */
            left: 0;
            right: 0;
            overflow-y: auto;
            padding: 16px;
        }
        
        .chat-content {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 20px;
        }
        
        /* AIå›å¤æ ·å¼ä¼˜åŒ– */
        .ai-response {
            line-height: 1.6;
            font-size: 15px;
            color: #333;
        }
        
        .ai-response h2, .ai-response h3 {
            margin: 1.2em 0 0.8em;
            font-weight: 600;
            color: #222;
        }
        
        .ai-response p {
            margin-bottom: 1em;
        }
        
        .ai-response ul, .ai-response ol {
            margin: 0.8em 0;
            padding-left: 1.5em;
        }
        
        .ai-response li {
            margin-bottom: 0.5em;
        }
        
        .ai-response blockquote {
            border-left: 3px solid #2962FF;
            padding: 0.5em 1em;
            margin: 1em 0;
            background-color: rgba(41, 98, 255, 0.05);
            color: #555;
        }
        
        .ai-response pre {
            background-color: #f6f8fa;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .ai-response code {
            font-family: 'Courier New', monospace;
            background-color: rgba(175, 184, 193, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 85%;
        }
        
        .ai-response .citation {
            font-size: 0.9em;
            color: #666;
            margin-top: 1em;
        }
        
        .ai-response a {
            color: #2962FF;
            text-decoration: underline;
        }
        
        .ai-response .emoji {
            font-size: 1.2em;
            margin-right: 0.3em;
            vertical-align: middle;
        }
        
        .ai-response .highlight {
            background-color: rgba(255, 215, 0, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }
        
        .ai-response .tip-box {
            background-color: rgba(41, 98, 255, 0.05);
            border-left: 3px solid #2962FF;
            padding: 1em;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        
        .ai-response .example-box {
            background-color: rgba(0, 128, 0, 0.05);
            border-left: 3px solid #008000;
            padding: 1em;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        
        .ai-response .warning-box {
            background-color: rgba(255, 0, 0, 0.05);
            border-left: 3px solid #FF0000;
            padding: 1em;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        
        /* æ¶ˆæ¯æ ·å¼è°ƒæ•´ - å¤´åƒå’Œæ¶ˆæ¯æ¡†åˆ†å¼€ */
        .message-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .message-container.user {
            justify-content: flex-end;
        }
        
        .message-container.assistant {
            justify-content: flex-start;
        }
        
        .avatar-container {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
        }
        
        .user-avatar, .ai-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .message-content {
            max-width: 70%;
            min-width: 200px;
        }
        
        /* ç”¨æˆ·æ¶ˆæ¯æ–‡å­—é¢œè‰²æ”¹ä¸ºç™½è‰² */
        .message-user .user-message-text {
            color: white;
        }
        
        .message-user .message-time,
        .message-user .message-actions {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* è¯­éŸ³ç›¸å…³æ ·å¼ */
        .speech-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .assistant-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* å¢å¼ºè¯­éŸ³æŒ‰é’®æ ·å¼ */
        .speak-btn {
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speak-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .speak-btn:active {
            transform: scale(0.95);
        }

        .speak-btn i {
            font-size: 12px;
        }

        /* è¯­éŸ³æŒ‡ç¤ºå™¨æ ·å¼ */
        .speech-indicator {
            animation: pulse 2s infinite;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* æœåŠ¡çŠ¶æ€æ æ ·å¼ */
        .service-status-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px 16px;
            margin: -16px -16px 16px -16px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .service-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* è¯­éŸ³å½•åˆ¶æŒ‡ç¤ºå™¨æ ·å¼ */
        .recording {
            background-color: #ef4444 !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f9fafb;
        }

        .file-upload-area:hover {
            border-color: #2962FF;
            background-color: #f0f4ff;
        }

        .file-upload-area.dragover {
            border-color: #2962FF;
            background-color: #e0e7ff;
        }

        /* æ–‡ä»¶ä¿¡æ¯å¡ç‰‡æ ·å¼ */
        .file-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2962FF, #1A237E);
            transition: width 0.3s ease;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (min-width: 1024px) {
            .sidebar-open ~ .flex-1 .chat-content-container,
            .sidebar-open ~ .flex-1 .input-container {
                left: 256px;
            }
        }
        
        @media (max-width: 640px) {
            .input-wrapper {
                max-width: 100%;
                padding: 0 12px;
            }
            
            .chat-content-container {
                top: 64px;
                bottom: 140px;
                padding: 12px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .ai-response {
                font-size: 14px;
            }
            
            .service-status-bar {
                margin: -12px -12px 12px -12px;
                padding: 8px 12px;
            }
            
            .file-upload-area {
                padding: 16px;
            }
            
            .file-info-card {
                padding: 8px;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white/90 backdrop-blur-md p-4 border-b border-gray-200/50 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <button id="sidebar-toggle" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                <i class="fas fa-bars"></i>
            </button>
            <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white">
                    <i class="fas fa-robot"></i>
                </div>
                <h1 class="text-xl font-semibold text-gray-800 hover:text-primary transition-colors">äº‘æ¢¦æ™ºé—´ AI</h1>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 flex items-center gap-2">
                <i class="fas fa-home"></i>
                <span>è¿”å›é¦–é¡µ</span>
            </a>
            <button id="new-chat-btn" class="px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-lg hover:opacity-90 flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>æ–°å¯¹è¯</span>
            </button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="flex flex-1 overflow-hidden">
        <!-- ä¾§è¾¹æ  -->
        <div id="sidebar" class="sidebar w-64 bg-white/90 backdrop-blur-md border-r border-gray-200/50 flex flex-col absolute lg:relative z-20 h-full shadow-lg">
            <div class="p-4 border-b border-gray-200">
                <button id="sidebar-new-chat-btn" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:opacity-90">
                    <i class="fas fa-plus"></i>
                    <span class="whitespace-nowrap">æ–°å»ºå¯¹è¯</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-custom">
                <div class="p-4">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-sm font-medium text-gray-700">å¯¹è¯åˆ†ç±»</span>
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </div>
                    <div class="space-y-2">
                        <button id="learning-assistant-btn" class="w-full text-left px-3 py-2 rounded-lg bg-blue-50 text-primary flex items-center gap-2">
                            <i class="fas fa-graduation-cap"></i>
                            <span>å­¦ä¹ åŠ©æ‰‹</span>
                        </button>
                        <button id="translation-assistant-btn" class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                            <i class="fas fa-language"></i>
                            <span>ç¿»è¯‘åŠ©æ‰‹</span>
                        </button>
                        <button id="writing-assistant-btn" class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                            <i class="fas fa-pen"></i>
                            <span>å†™ä½œåŠ©æ‰‹</span>
                        </button>
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div class="mt-4 space-y-2">
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-microphone-alt"></i>
                            <span>å£è¯­ç»ƒä¹ </span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-spell-check"></i>
                            <span>è¯­æ³•æ£€æŸ¥</span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-language"></i>
                            <span>æ–‡æœ¬ç¿»è¯‘</span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-book"></i>
                            <span>å­¦ä¹ è®¡åˆ’</span>
                        </button>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-medium text-gray-700">å†å²å¯¹è¯</span>
                        <button class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    <div class="space-y-3" id="chat-history-list">
                        <!-- å†å²å¯¹è¯ä¼šåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <img id="user-avatar-sidebar" src="94B2FFC12D41C799B69B2668BBA16BE7.jpg" class="w-8 h-8 rounded-full user-avatar" alt="ç”¨æˆ·å¤´åƒ">
                        <div>
                            <div id="user-name-sidebar" class="text-sm font-medium text-gray-900">æ¸¸å®¢</div>
                            <div id="user-status-sidebar" class="text-xs text-gray-500">è¯·ç™»å½•</div>
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ é®ç½© -->
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/50 z-10 lg:hidden"></div>

        <!-- èŠå¤©ä¸»åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
            <div id="chat-content-container" class="chat-content-container scrollbar-custom">
                <!-- å·²ç§»é™¤æœåŠ¡çŠ¶æ€æ˜¾ç¤º -->
                
                <div id="chat-content" class="chat-content space-y-6">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div id="welcome-container" class="welcome-container">
                        <div class="message-assistant p-6 shadow-message">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯äº‘æ¢¦æ™ºé—´ AIï¼Œä½ çš„æ™ºèƒ½å­¦ä¹ ä¼™ä¼´</h2>
                            <p class="font-content text-gray-700 mb-4">æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³è‹±è¯­å­¦ä¹ ä¸­çš„å„ç§é—®é¢˜ï¼ŒåŒ…æ‹¬å¬åŠ›ã€é˜…è¯»ã€å†™ä½œå’Œç¿»è¯‘ç­‰æ–¹é¢ã€‚è®©æˆ‘ä»¬ä¸€èµ·è½»æ¾æ„‰å¿«åœ°å­¦ä¹ å§ï¼</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50/50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-primary mb-2">ğŸ“š å­¦ä¹ è¾…å¯¼</h3>
                                    <ul class="font-content text-gray-700 space-y-1">
                                        <li>â€¢ è§£ç­”è‹±è¯­å­¦ä¹ é—®é¢˜</li>
                                        <li>â€¢ æä¾›å››å…­çº§/é›…æ€å¤‡è€ƒå»ºè®®</li>
                                        <li>â€¢ æ£€æŸ¥è¯­æ³•å’Œå†™ä½œ</li>
                                        <li>â€¢ è§£æå¤æ‚å¥å­ç»“æ„</li>
                                    </ul>
                                </div>
                                <div class="bg-blue-50/50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-primary mb-2">âœ¨ å®ç”¨åŠŸèƒ½</h3>
                                    <ul class="font-content text-gray-700 space-y-1">
                                        <li>â€¢ ä¸“ä¸šä¸­è‹±æ–‡ç¿»è¯‘</li>
                                        <li>â€¢ æ¨¡æ‹Ÿå£è¯­å¯¹è¯ç»ƒä¹ </li>
                                        <li>â€¢ ç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’</li>
                                        <li>â€¢ æä¾›å­¦ä¹ èµ„æºæ¨è</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- è¿™é‡Œä¼šåŠ¨æ€æ·»åŠ èŠå¤©æ¶ˆæ¯ -->
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div id="input-container" class="input-container">
                <div class="input-wrapper">
                    <!-- è¯­éŸ³æ§åˆ¶UI -->
                    <div class="flex items-center gap-2 mb-4">
                        <div class="flex-1"></div>
                        <div class="flex items-center gap-2">
                            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                <input type="checkbox" id="speech-toggle" checked class="rounded text-primary focus:ring-primary">
                                <span>AIè¯­éŸ³å›å¤</span>
                            </label>
                            <button id="speech-settings" class="text-gray-500 hover:text-primary transition-colors">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥æ¡† -->
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <textarea 
                                id="user-input"
                                class="input-box w-full p-3 pr-10 rounded-lg border border-gray-200 bg-white/80 backdrop-blur-sm focus:outline-none resize-none font-content"
                                rows="1"
                                placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Shift+Enter æ¢è¡Œ"
                                disabled
                            ></textarea>
                        </div>
                        <button 
                            id="send-btn"
                            class="send-btn bg-gradient-to-r from-primary to-secondary text-white w-12 h-12 rounded-lg flex items-center justify-center shadow"
                            disabled
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- å¿«æ·å·¥å…·æ  -->
                    <div class="flex items-center justify-center gap-3 mt-3">
                        <button id="voice-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-microphone"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">è¯­éŸ³è¾“å…¥</span>
                        </button>
                        <button id="image-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-camera"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">å›¾ç‰‡è¯†åˆ«</span>
                        </button>
                        <button id="file-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-file-upload"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">æ–‡ä»¶ä¸Šä¼ </span>
                        </button>
                        <div class="h-5 w-px bg-gray-200 mx-1"></div>
                        <button id="keyboard-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-keyboard"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">é”®ç›˜è¾“å…¥</span>
                        </button>
                    </div>
                    
                    <!-- å·²ç§»é™¤æ–‡ä»¶æ ¼å¼æç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center justify-center gap-3">
                <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <div>
                    <p class="font-medium text-gray-800">AIæ­£åœ¨æ€è€ƒ...</p>
                    <p class="text-sm text-gray-600">è¯·ç¨ç­‰ç‰‡åˆ»</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¢å¼ºè¯­éŸ³è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="speech-settings-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">è¯­éŸ³è®¾ç½® - ç™¾åº¦AI TTS</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è¯­éŸ³é€‰æ‹©</label>
                    <select id="voice-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="5118" selected>å¾¡å§éŸ³ - æˆç†Ÿä¼˜é›…ç£æ€§å£°çº¿</option>
                        <option value="0">æ ‡å‡†å¥³å£° - æ¸…æ™°è‡ªç„¶</option>
                        <option value="1">æ ‡å‡†ç”·å£° - æ²‰ç¨³æœ‰åŠ›</option>
                        <option value="3">åº¦é€é¥ - ç£æ€§ç”·å£°</option>
                        <option value="4">åº¦ä¸«ä¸« - å¯çˆ±å¥³å£°</option>
                    </select>
                    <p class="text-xs text-purple-500 mt-1">æ¨èä½¿ç”¨"å¾¡å§éŸ³"ï¼Œå£°éŸ³æˆç†Ÿä¼˜é›…å¯Œæœ‰ç£æ€§</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        è¯­é€Ÿ <span id="rate-value" class="text-primary font-medium">4</span>
                    </label>
                    <input type="range" id="speech-rate" min="0" max="15" step="1" value="4" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>è¾ƒæ…¢</span>
                        <span>æ¨è</span>
                        <span>è¾ƒå¿«</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        éŸ³è°ƒ <span id="pitch-value" class="text-primary font-medium">6</span>
                    </label>
                    <input type="range" id="speech-pitch" min="0" max="15" step="1" value="6" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>è¾ƒä½</span>
                        <span>æ¨è</span>
                        <span>è¾ƒé«˜</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        éŸ³é‡ <span id="volume-value" class="text-primary font-medium">8</span>
                    </label>
                    <input type="range" id="speech-volume" min="0" max="15" step="1" value="8" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>è¾ƒå°</span>
                        <span>æ¨è</span>
                        <span>è¾ƒå¤§</span>
                    </div>
                </div>

                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <div>
                            <p class="text-sm text-blue-700 font-medium">ä¼˜åŒ–å»ºè®®</p>
                            <p class="text-xs text-blue-600 mt-1">ä½¿ç”¨"å¾¡å§éŸ³"é…åˆæ¨èå‚æ•°ï¼Œå¯è·å¾—æˆç†Ÿä¼˜é›…çš„è¯­éŸ³ä½“éªŒ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="speech-test-btn" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-volume-up"></i>
                    æµ‹è¯•è¯­éŸ³
                </button>
                <button id="speech-settings-cancel" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="speech-settings-save" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                    ä¿å­˜è®¾ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- æœåŠ¡ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="service-info-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">AIæœåŠ¡ä¿¡æ¯</h3>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">æ‰£å­æ™ºèƒ½ä½“</h4>
                            <p class="text-sm text-gray-600">å­—èŠ‚è·³åŠ¨ AI æœåŠ¡</p>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-700">
                        <div class="flex justify-between">
                            <span>æœåŠ¡çŠ¶æ€:</span>
                            <span class="text-green-600 font-medium">åœ¨çº¿</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å“åº”é€Ÿåº¦:</span>
                            <span class="text-blue-600 font-medium">å¿«é€Ÿ</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ”¯æŒè¯­è¨€:</span>
                            <span class="text-gray-800">ä¸­è‹±æ–‡</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-800 mb-2">æœåŠ¡ç‰¹æ€§</h4>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li>â€¢ æ”¯æŒå¤šè½®å¯¹è¯è®°å¿†</li>
                        <li>â€¢ ä¸“ä¸šè‹±è¯­å­¦ä¹ è¾…å¯¼</li>
                        <li>â€¢ æ™ºèƒ½ç¿»è¯‘å’Œè¯­æ³•æ£€æŸ¥</li>
                        <li>â€¢ ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®</li>
                    </ul>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded-lg">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        <div>
                            <p class="text-sm text-yellow-700 font-medium">æœåŠ¡è¯´æ˜</p>
                            <p class="text-xs text-yellow-600 mt-1">å½“å‰ä½¿ç”¨æ‰£å­æ™ºèƒ½ä½“ä½œä¸ºAIæœåŠ¡åç«¯ï¼Œæä¾›ç¨³å®šå¯é çš„å¯¹è¯ä½“éªŒ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="service-info-close" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                    ç¡®å®š
                </button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„JavaScriptæ–‡ä»¶ -->
    <script src="äº‘æ¢¦æ™ºé—´ç»Ÿä¸€è®¤è¯.js"></script>
    <script src="äº‘æ¢¦æ™ºé—´UIç®¡ç†å™¨.js"></script>
    <script src="js/ai-api-service.js"></script>
    <script src="js/ai-voice-service.js"></script>
    <script src="js/ai-chat-manager.js"></script>

    <script>
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('AIèŠå¤©é¡µé¢åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–ä¾§è¾¹æ åŠŸèƒ½
            initSidebar();
            
            // åˆå§‹åŒ–è¯­éŸ³æ§åˆ¶åŠŸèƒ½
            initSpeechControl();
            
            // åˆå§‹åŒ–è¯­éŸ³æ’­æ”¾æ§åˆ¶
            initSpeechPlaybackControl();
            
            // åˆå§‹åŒ–æœåŠ¡çŠ¶æ€åŠŸèƒ½
            initServiceStatus();
            
            // æ·»åŠ ç”¨æˆ·äº¤äº’æ£€æµ‹ä»¥è§£å†³è‡ªåŠ¨æ’­æ”¾é™åˆ¶
            setupAutoplayHandler();
            
            // ç­‰å¾…å¿…è¦çš„JavaScriptæ–‡ä»¶åŠ è½½
            await waitForScripts();
            
            // ç­‰å¾…è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–
            await new Promise(resolve => {
                const checkAuth = () => {
                    if (window.unifiedAuthManager && window.unifiedAuthManager.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkAuth, 100);
                    }
                };
                checkAuth();
            });

            // åˆå§‹åŒ–AIèŠå¤©ç®¡ç†å™¨
            if (window.AIChatManager) {
                try {
                    window.aiChatManager = new window.AIChatManager();
                    console.log('AIèŠå¤©ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('AIèŠå¤©ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                    showErrorFallback();
                }
            } else {
                console.error('AIèŠå¤©ç®¡ç†å™¨ç±»æœªæ‰¾åˆ°');
                showErrorFallback();
            }

            // æ›´æ–°ç”¨æˆ·ç•Œé¢çŠ¶æ€
            updateUIState();
        });

        // æ–°å¢ï¼šè¯­éŸ³æ’­æ”¾æ§åˆ¶é€»è¾‘
        function initSpeechPlaybackControl() {
            let isPlaying = false;
            let currentPlayingMessageId = null;
            
            // ç›‘å¬è¯­éŸ³æ’­æ”¾è¯·æ±‚
            document.addEventListener('ai-voice-play', function(event) {
                const { messageId, text } = event.detail;
                
                // å¦‚æœæ­£åœ¨æ’­æ”¾ç›¸åŒæ¶ˆæ¯ï¼Œå¿½ç•¥è¯·æ±‚
                if (isPlaying && currentPlayingMessageId === messageId) {
                    return;
                }
                
                // å¦‚æœæ­£åœ¨æ’­æ”¾å…¶ä»–æ¶ˆæ¯ï¼Œå…ˆåœæ­¢
                if (isPlaying) {
                    stopCurrentPlayback();
                }
                
                // å¼€å§‹æ’­æ”¾æ–°æ¶ˆæ¯
                playSpeech(text, messageId);
            });
            
            // ç›‘å¬è¯­éŸ³åœæ­¢è¯·æ±‚
            document.addEventListener('ai-voice-stop', function() {
                stopCurrentPlayback();
            });
            
            function playSpeech(text, messageId) {
                if (!window.aiChatManager || !window.aiChatManager.voiceService) {
                    console.error('è¯­éŸ³æœåŠ¡æœªå°±ç»ª');
                    return;
                }
                
                isPlaying = true;
                currentPlayingMessageId = messageId;
                
                // æ›´æ–°UIçŠ¶æ€
                updateSpeechButtonState(messageId, 'playing');
                
                window.aiChatManager.voiceService.speak(text, {
                    messageId: messageId,
                    onStart: () => {
                        console.log('å¼€å§‹æ’­æ”¾æ¶ˆæ¯:', messageId);
                        updateSpeechButtonState(messageId, 'playing');
                    },
                    onEnd: () => {
                        console.log('æ’­æ”¾å®Œæˆæ¶ˆæ¯:', messageId);
                        isPlaying = false;
                        currentPlayingMessageId = null;
                        updateSpeechButtonState(messageId, 'stopped');
                    },
                    onError: (error) => {
                        console.error('æ’­æ”¾é”™è¯¯:', error);
                        isPlaying = false;
                        currentPlayingMessageId = null;
                        updateSpeechButtonState(messageId, 'error');
                    }
                }).catch(error => {
                    console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
                    isPlaying = false;
                    currentPlayingMessageId = null;
                    updateSpeechButtonState(messageId, 'error');
                });
            }
            
            function stopCurrentPlayback() {
                if (window.aiChatManager && window.aiChatManager.voiceService) {
                    window.aiChatManager.voiceService.stop();
                }
                isPlaying = false;
                
                if (currentPlayingMessageId) {
                    updateSpeechButtonState(currentPlayingMessageId, 'stopped');
                    currentPlayingMessageId = null;
                }
            }
            
            function updateSpeechButtonState(messageId, state) {
                // æ‰¾åˆ°å¯¹åº”çš„è¯­éŸ³æŒ‰é’®å¹¶æ›´æ–°çŠ¶æ€
                const speakBtn = document.querySelector(`[data-message-id="${messageId}"] .speak-btn`);
                if (speakBtn) {
                    const icon = speakBtn.querySelector('i');
                    switch (state) {
                        case 'playing':
                            icon.className = 'fas fa-stop';
                            speakBtn.classList.add('playing');
                            break;
                        case 'stopped':
                            icon.className = 'fas fa-volume-up';
                            speakBtn.classList.remove('playing');
                            break;
                        case 'error':
                            icon.className = 'fas fa-exclamation-triangle';
                            speakBtn.classList.remove('playing');
                            break;
                    }
                }
            }
            
            // å…¨å±€å‡½æ•°ï¼Œä¾›æ¶ˆæ¯æ¸²æŸ“è°ƒç”¨
            window.toggleSpeechPlayback = function(messageId, text) {
                const event = new CustomEvent('ai-voice-play', {
                    detail: { messageId, text }
                });
                document.dispatchEvent(event);
            };
            
            // æ–‡æœ¬è½¬ä¹‰å‡½æ•°
            window.escapeTextForJS = function(text) {
                return text.replace(/`/g, '\\`')
                           .replace(/\$/g, '\\$')
                           .replace(/\n/g, '\\n');
            };
        }

        // æ–°å¢ï¼šæ¶ˆæ¯æ¸²æŸ“å‡½æ•°ï¼Œæ·»åŠ è¯­éŸ³æ§åˆ¶
        function renderMessageWithSpeechControl(message, messageId) {
            const escapedContent = window.escapeTextForJS ? window.escapeTextForJS(message.content) : message.content.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\n/g, '\\n');
            
            return `
                <div class="message-container ${message.role}">
                    <div class="avatar-container">
                        <img src="${message.role === 'user' ? 'user-avatar.jpg' : 'ai-avatar.jpg'}" 
                             class="${message.role === 'user' ? 'user-avatar' : 'ai-avatar'}" 
                             alt="${message.role === 'user' ? 'ç”¨æˆ·' : 'AI'}å¤´åƒ">
                    </div>
                    <div class="message-content">
                        <div class="message-${message.role === 'user' ? 'user' : 'assistant'} p-4">
                            <div class="font-content ${message.role === 'user' ? 'user-message-text' : 'ai-response'}">
                                ${message.content}
                            </div>
                            ${message.role === 'assistant' ? `
                            <div class="message-actions flex items-center gap-2 mt-2" data-message-id="${messageId}">
                                <button class="speak-btn tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-blue-500 hover:bg-blue-50" 
                                        onclick="toggleSpeechPlayback('${messageId}', \`${escapedContent}\`)">
                                    <i class="fas fa-volume-up text-xs"></i>
                                    <span class="tooltip">æœ—è¯»</span>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ–°å¢ï¼šåˆå§‹åŒ–æœåŠ¡çŠ¶æ€åŠŸèƒ½
        function initServiceStatus() {
            const serviceInfoBtn = document.getElementById('service-info-btn');
            const serviceInfoModal = document.getElementById('service-info-modal');
            const serviceInfoClose = document.getElementById('service-info-close');

            // æœåŠ¡ä¿¡æ¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            if (serviceInfoBtn) {
                serviceInfoBtn.addEventListener('click', function() {
                    serviceInfoModal.classList.remove('hidden');
                });
            }

            // å…³é—­æœåŠ¡ä¿¡æ¯æ¨¡æ€æ¡†
            if (serviceInfoClose) {
                serviceInfoClose.addEventListener('click', function() {
                    serviceInfoModal.classList.add('hidden');
                });
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            if (serviceInfoModal) {
                serviceInfoModal.addEventListener('click', function(e) {
                    if (e.target === serviceInfoModal) {
                        serviceInfoModal.classList.add('hidden');
                    }
                });
            }

            // ç›‘å¬æœåŠ¡çŠ¶æ€å˜åŒ–
            window.addEventListener('ai-service-status-change', function(event) {
                updateServiceStatus(event.detail);
            });
        }

        // æ›´æ–°æœåŠ¡çŠ¶æ€æ˜¾ç¤º
        function updateServiceStatus(status) {
            // æœåŠ¡çŠ¶æ€æ˜¾ç¤ºå·²ç§»é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        }

        // æ–°å¢ï¼šç­‰å¾…å¿…è¦çš„è„šæœ¬åŠ è½½
        function waitForScripts() {
            return new Promise((resolve) => {
                const scripts = [
                    'äº‘æ¢¦æ™ºé—´ç»Ÿä¸€è®¤è¯.js',
                    'äº‘æ¢¦æ™ºé—´UIç®¡ç†å™¨.js', 
                    'js/ai-api-service.js',
                    'js/ai-voice-service.js',
                    'js/ai-chat-manager.js'
                ];
                
                let loadedCount = 0;
                
                const checkLoaded = () => {
                    loadedCount++;
                    if (loadedCount === scripts.length) {
                        console.log('æ‰€æœ‰å¿…è¦è„šæœ¬å·²åŠ è½½');
                        resolve();
                    }
                };
                
                // æ£€æŸ¥è„šæœ¬æ˜¯å¦å·²åŠ è½½
                scripts.forEach(script => {
                    const checkScript = () => {
                        const scriptName = script.replace('.js', '').replace('js/', '');
                        if (window[scriptName] || (script === 'js/ai-api-service.js' && window.AIApiService) ||
                            (script === 'js/ai-voice-service.js' && window.AIVoiceService) ||
                            (script === 'js/ai-chat-manager.js' && window.AIChatManager)) {
                            checkLoaded();
                        } else {
                            setTimeout(checkScript, 100);
                        }
                    };
                    checkScript();
                });
                
                // è¶…æ—¶ä¿æŠ¤
                setTimeout(() => {
                    console.log('è„šæœ¬åŠ è½½è¶…æ—¶ï¼Œç»§ç»­åˆå§‹åŒ–');
                    resolve();
                }, 5000);
            });
        }

        // æ·»åŠ ç”¨æˆ·äº¤äº’æ£€æµ‹ä»¥è§£å†³è‡ªåŠ¨æ’­æ”¾é™åˆ¶
        function setupAutoplayHandler() {
            let userInteracted = false;
            
            const enableAutoplay = () => {
                if (!userInteracted) {
                    userInteracted = true;
                    console.log('ç”¨æˆ·å·²äº¤äº’ï¼Œå…è®¸è‡ªåŠ¨æ’­æ”¾');
                    
                    // è§¦å‘è¯­éŸ³æœåŠ¡é¢„åŠ è½½
                    if (window.aiChatManager && window.aiChatManager.voiceService) {
                        window.aiChatManager.voiceService.init().then(() => {
                            console.log('è¯­éŸ³æœåŠ¡åœ¨ç”¨æˆ·äº¤äº’åé‡æ–°åˆå§‹åŒ–');
                        });
                    }
                    
                    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                    document.removeEventListener('click', enableAutoplay);
                    document.removeEventListener('keydown', enableAutoplay);
                    document.removeEventListener('touchstart', enableAutoplay);
                }
            };
            
            // æ·»åŠ å¤šç§ç”¨æˆ·äº¤äº’ç›‘å¬
            document.addEventListener('click', enableAutoplay);
            document.addEventListener('keydown', enableAutoplay);
            document.addEventListener('touchstart', enableAutoplay);
            
            // 10ç§’åè‡ªåŠ¨æ ‡è®°ä¸ºå·²äº¤äº’ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
            setTimeout(() => {
                if (!userInteracted) {
                    console.log('è‡ªåŠ¨æ ‡è®°ä¸ºç”¨æˆ·å·²äº¤äº’');
                    userInteracted = true;
                }
            }, 10000);
        }

        // å¢å¼ºè¯­éŸ³è®¾ç½®åŠŸèƒ½
        function initSpeechControl() {
            const speechToggle = document.getElementById('speech-toggle');
            const speechSettingsBtn = document.getElementById('speech-settings');
            const speechModal = document.getElementById('speech-settings-modal');
            const speechSettingsCancel = document.getElementById('speech-settings-cancel');
            const speechSettingsSave = document.getElementById('speech-settings-save');
            const speechTestBtn = document.getElementById('speech-test-btn');
            const speechRate = document.getElementById('speech-rate');
            const speechPitch = document.getElementById('speech-pitch');
            const speechVolume = document.getElementById('speech-volume');
            const rateValue = document.getElementById('rate-value');
            const pitchValue = document.getElementById('pitch-value');
            const volumeValue = document.getElementById('volume-value');
            const voiceSelect = document.getElementById('voice-select');

            // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
            speechRate.addEventListener('input', function() {
                rateValue.textContent = this.value;
            });
            
            speechPitch.addEventListener('input', function() {
                pitchValue.textContent = this.value;
            });

            speechVolume.addEventListener('input', function() {
                volumeValue.textContent = this.value;
            });

            // è¯­éŸ³è®¾ç½®æŒ‰é’®äº‹ä»¶
            speechSettingsBtn.addEventListener('click', function() {
                speechModal.classList.remove('hidden');
            });

            // æµ‹è¯•è¯­éŸ³æŒ‰é’®
            speechTestBtn.addEventListener('click', function() {
                const testText = "æ‚¨å¥½ï¼Œè¿™æ˜¯äº‘æ¢¦æ™ºé—´AIçš„è¯­éŸ³æµ‹è¯•ã€‚å¦‚æœå¬åˆ°è¿™æ®µè¯ï¼Œè¯´æ˜è¯­éŸ³åŠŸèƒ½å·¥ä½œæ­£å¸¸ã€‚";
                if (window.aiChatManager) {
                    window.aiChatManager.speakAIResponse(testText, {
                        onStart: () => {
                            speechTestBtn.innerHTML = '<i class="fas fa-volume-up"></i> æµ‹è¯•ä¸­...';
                            speechTestBtn.disabled = true;
                        },
                        onEnd: () => {
                            speechTestBtn.innerHTML = '<i class="fas fa-volume-up"></i> æµ‹è¯•è¯­éŸ³';
                            speechTestBtn.disabled = false;
                        },
                        onError: (error) => {
                            speechTestBtn.innerHTML = '<i class="fas fa-volume-up"></i> æµ‹è¯•è¯­éŸ³';
                            speechTestBtn.disabled = false;
                            alert('è¯­éŸ³æµ‹è¯•å¤±è´¥: ' + error);
                        }
                    });
                }
            });

            // å…³é—­æ¨¡æ€æ¡†
            speechSettingsCancel.addEventListener('click', function() {
                speechModal.classList.add('hidden');
            });

            speechSettingsSave.addEventListener('click', function() {
                // ä¿å­˜è¯­éŸ³è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
                const settings = {
                    enabled: speechToggle.checked,
                    voice: voiceSelect.value,
                    rate: speechRate.value,
                    pitch: speechPitch.value,
                    volume: speechVolume.value
                };
                
                localStorage.setItem('speech-settings', JSON.stringify(settings));
                
                // åº”ç”¨è¯­éŸ³é€‰æ‹©
                if (window.aiChatManager && window.aiChatManager.voiceService) {
                    window.aiChatManager.voiceService.setVoice(voiceSelect.value);
                }
                
                // å…³é—­æ¨¡æ€æ¡†
                speechModal.classList.add('hidden');
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                if (window.uiManager) {
                    window.uiManager.showMessage('è¯­éŸ³è®¾ç½®å·²ä¿å­˜', 'success');
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            speechModal.addEventListener('click', function(e) {
                if (e.target === speechModal) {
                    speechModal.classList.add('hidden');
                }
            });

            // åŠ è½½ä¿å­˜çš„è¯­éŸ³è®¾ç½®
            const savedSettings = localStorage.getItem('speech-settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (speechToggle) speechToggle.checked = settings.enabled !== false; // é»˜è®¤å¼€å¯
                if (voiceSelect) voiceSelect.value = settings.voice || '5118'; // é»˜è®¤å¾¡å§éŸ³
                if (speechRate) speechRate.value = settings.rate || '4';
                if (speechPitch) speechPitch.value = settings.pitch || '6';
                if (speechVolume) speechVolume.value = settings.volume || '8';
                if (rateValue) rateValue.textContent = settings.rate || '4';
                if (pitchValue) pitchValue.textContent = settings.pitch || '6';
                if (volumeValue) volumeValue.textContent = settings.volume || '8';
            }
        }

        // é”™è¯¯å›é€€å¤„ç†
        function showErrorFallback() {
            const chatContent = document.getElementById('chat-content');
            if (chatContent) {
                chatContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-500 text-2xl mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">åŠŸèƒ½åŠ è½½å¤±è´¥</h3>
                        <p class="text-gray-600 mb-4">AIèŠå¤©åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                        <button onclick="window.location.reload()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-redo mr-2"></i>åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                `;
            }
        }

        // åˆå§‹åŒ–ä¾§è¾¹æ 
        function initSidebar() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            if (sidebarToggle && sidebar && sidebarOverlay) {
                sidebarToggle.addEventListener('click', toggleSidebar);
                sidebarOverlay.addEventListener('click', toggleSidebar);
            }

            // ç§»é™¤åŠ©æ‰‹åˆ‡æ¢äº‹ä»¶ç»‘å®šï¼Œå› ä¸ºå·²ç»åœ¨AIChatManagerä¸­å¤„ç†
            // åªä¿ç•™å¿«é€Ÿæ“ä½œæŒ‰é’®çš„ç»‘å®š
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.textContent.trim();
                    const prompts = {
                        'å£è¯­ç»ƒä¹ ': 'æˆ‘æƒ³ç»ƒä¹ è‹±è¯­å£è¯­ï¼Œè¯·æ¨¡æ‹Ÿä¸€ä¸ªæ—¥å¸¸å¯¹è¯åœºæ™¯ï¼Œæ¯”å¦‚åœ¨å’–å•¡åº—ç‚¹é¤ã€‚',
                        'è¯­æ³•æ£€æŸ¥': 'è¯·å¸®æˆ‘æ£€æŸ¥ä»¥ä¸‹è‹±æ–‡å¥å­çš„è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œå¹¶æŒ‡å‡ºé”™è¯¯ï¼š',
                        'æ–‡æœ¬ç¿»è¯‘': 'è¯·å°†ä»¥ä¸‹ä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡ï¼š',
                        'å­¦ä¹ è®¡åˆ’': 'æˆ‘éœ€è¦ä¸€ä¸ªä¸ºæœŸ30å¤©çš„è‹±è¯­å­¦ä¹ è®¡åˆ’ï¼Œç›®æ ‡æ˜¯æå‡å•†åŠ¡è‹±è¯­èƒ½åŠ›ã€‚'
                    };
                    
                    const userInput = document.getElementById('user-input');
                    userInput.value = prompts[action] || action;
                    userInput.focus();
                    handleInputChange();
                    
                    if (window.aiChatManager) {
                        window.aiChatManager.showQuickActionFeedback(action);
                    }
                });
            });
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('sidebar-open');
            sidebarOverlay.classList.toggle('sidebar-overlay-open');
            adjustInputPosition();
        }

        // è°ƒæ•´è¾“å…¥æ¡†ä½ç½®
        function adjustInputPosition() {
            const chatContentContainer = document.getElementById('chat-content-container');
            const inputContainer = document.getElementById('input-container');
            
            if (window.innerWidth >= 1024 && document.getElementById('sidebar').classList.contains('sidebar-open')) {
                chatContentContainer.style.left = '256px';
                inputContainer.style.left = '256px';
            } else {
                chatContentContainer.style.left = '0';
                inputContainer.style.left = '0';
            }
        }

        // åˆ‡æ¢åŠ©æ‰‹
        function switchAssistant(assistantType) {
            if (window.aiChatManager) {
                window.aiChatManager.switchAssistant(assistantType);
            }
        }

        // å¤„ç†è¾“å…¥å˜åŒ–
        function handleInputChange() {
            if (window.aiChatManager) {
                window.aiChatManager.handleInputChange();
            } else {
                // å¤‡ç”¨å¤„ç†
                const userInput = document.getElementById('user-input');
                const sendBtn = document.getElementById('send-btn');
                
                if (userInput && sendBtn) {
                    userInput.style.height = 'auto';
                    userInput.style.height = (userInput.scrollHeight) + 'px';
                    
                    const hasText = userInput.value.trim().length > 0;
                    const isLoggedIn = window.unifiedAuthManager ? window.unifiedAuthManager.isLoggedIn() : false;
                    const canSend = hasText && (isLoggedIn || true); // æ¸¸å®¢ä¹Ÿå¯ä»¥å‘é€
                    
                    sendBtn.disabled = !canSend;
                }
            }
        }

        // æ›´æ–°UIçŠ¶æ€
        function updateUIState() {
            const isLoggedIn = window.unifiedAuthManager ? window.unifiedAuthManager.isLoggedIn() : false;
            const user = window.unifiedAuthManager ? window.unifiedAuthManager.getCurrentUser() : null;

            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const userAvatar = document.getElementById('user-avatar-sidebar');
            const userName = document.getElementById('user-name-sidebar');
            const userStatus = document.getElementById('user-status-sidebar');

            if (isLoggedIn && user) {
                userInput.disabled = false;
                userInput.placeholder = 'è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Shift+Enter æ¢è¡Œ';
                
                // æ›´æ–°ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯
                if (userAvatar) userAvatar.src = user.avatar || '94B2FFC12D41C799B69B2668BBA16BE7.jpg';
                if (userName) userName.textContent = user.name;
                if (userStatus) {
                    userStatus.textContent = user.memberLevel === 'vip' ? 'VIPä¼šå‘˜' : 'æ™®é€šç”¨æˆ·';
                    userStatus.className = user.memberLevel === 'vip' ? 
                        'text-xs text-yellow-600 font-medium' : 'text-xs text-gray-500';
                }
            } else {
                userInput.disabled = false; // å…è®¸æ¸¸å®¢ä½¿ç”¨
                userInput.placeholder = 'æ¸¸å®¢æ¨¡å¼ï¼Œæ¯æ—¥å¯å‘é€5æ¡æ¶ˆæ¯';
                
                if (userName) userName.textContent = 'æ¸¸å®¢';
                if (userStatus) {
                    userStatus.textContent = 'è¯·ç™»å½•';
                    userStatus.className = 'text-xs text-gray-500';
                }
            }

            handleInputChange();
        }

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', adjustInputPosition);

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
        });

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        window.addEventListener('online', function() {
            console.log('ç½‘ç»œè¿æ¥æ¢å¤');
            if (window.uiManager) {
                window.uiManager.showMessage('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
            }
        });

        window.addEventListener('offline', function() {
            console.log('ç½‘ç»œè¿æ¥æ–­å¼€');
            if (window.uiManager) {
                window.uiManager.showMessage('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', 'error');
            }
        });
    </script>
</body>
</html>