<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸé¢˜è€ƒè¯• - äº‘æ¢¦æ™ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- æ·»åŠ ç»Ÿä¸€è®¤è¯å’ŒUIç®¡ç†å™¨ -->
    <script src="äº‘æ¢¦æ™ºé—´ç»Ÿä¸€è®¤è¯.js"></script>
    <script src="äº‘æ¢¦æ™ºé—´UIç®¡ç†å™¨.js"></script>
    
    <style>
        /* è€ƒè¯•ç•Œé¢ä¼˜åŒ–æ ·å¼ */
        .exam-interface {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .exam-header {
            background: linear-gradient(135deg, #2962FF, #1565C0);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .exam-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exam-info h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .exam-info p {
            margin: 0.25rem 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .timer-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .timer-container.warning {
            background: rgba(255, 235, 59, 0.3);
            animation: pulse 1.5s infinite;
        }

        .exam-controls {
            display: flex;
            gap: 0.75rem;
        }

        .exam-main {
            display: flex;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        .navigation-sidebar {
            width: 320px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .section-tabs-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .section-tab-vertical {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background: #f3f4f6;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .section-tab-vertical.active {
            background: #2962FF;
            color: white;
            border-color: #2962FF;
        }

        .section-info {
            background: #e0f2fe;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .question-grid-vertical {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            max-height: 240px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .question-number {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f3f4f6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .question-number.current {
            background: #2962FF;
            color: white;
        }

        .question-number.answered {
            background: #10b981;
            color: white;
        }

        .question-number.review {
            background: #f59e0b;
            color: white;
        }

        .question-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: #f9fafb;
        }

        .question-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .question-header {
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .question-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .question-type-badge {
            background: #2962FF;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .reading-passage {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            line-height: 1.7;
            font-size: 1rem;
            color: #374151;
        }

        .translation-passage {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            line-height: 1.7;
            font-size: 1rem;
            color: #374151;
        }

        .writing-prompt {
            background: #fef7cd;
            border: 1px solid #fde047;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            line-height: 1.7;
            font-size: 1rem;
            color: #374151;
        }

        .question-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        /* é€‰é¡¹æ ·å¼ä¼˜åŒ– - å¢å¼ºç‚¹å‡»æ•ˆæœ */
        .question-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .option-item:hover {
            border-color: #2962FF;
            background-color: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(41, 98, 255, 0.1);
        }

        .option-item.selected {
            border-color: #2962FF;
            background-color: #dbeafe;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.15);
        }

        /* é€‰ä¸­çŠ¶æ€çš„è§†è§‰å¢å¼º */
        .option-item.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #2962FF;
            border-radius: 4px 0 0 4px;
        }

        .option-letter {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            background: #f3f4f6;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .option-item:hover .option-letter {
            background: #2962FF;
            color: white;
            transform: scale(1.05);
        }

        .option-item.selected .option-letter {
            background: #2962FF;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 6px rgba(41, 98, 255, 0.3);
        }

        /* å¤šé€‰é¢˜æ ·å¼ */
        .option-item.multiple-selected {
            border-color: #10b981;
            background-color: #d1fae5;
        }

        .option-item.multiple-selected::before {
            background: #10b981;
        }

        .option-item.multiple-selected .option-letter {
            background: #10b981;
            color: white;
        }

        /* é€‰é¡¹å†…å®¹æ ·å¼ */
        .option-content {
            flex: 1;
            line-height: 1.6;
            color: #374151;
            transition: color 0.2s;
        }

        .option-item.selected .option-content {
            color: #1e40af;
            font-weight: 500;
        }

        .translation-textarea, .essay-textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.2s;
            font-family: inherit;
        }

        .translation-textarea:focus, .essay-textarea:focus {
            border-color: #2962FF;
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        .question-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            position: sticky;
            bottom: 0;
            z-index: 30;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .nav-button.prev {
            background: #f3f4f6;
            color: #374151;
        }

        .nav-button.prev:hover {
            background: #e5e7eb;
            transform: translateX(-2px);
        }

        .nav-button.next {
            background: #2962FF;
            color: white;
        }

        .nav-button.next:hover {
            background: #1e40af;
            transform: translateX(2px);
        }

        .nav-button.submit {
            background: #ef4444;
            color: white;
        }

        .nav-button.submit:hover {
            background: #dc2626;
            transform: scale(1.02);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€‰é¡¹ç‚¹å‡»åŠ¨ç”» */
        @keyframes optionSelect {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .option-item.selected {
            animation: optionSelect 0.3s ease-out;
        }

        .auth-sync-loading {
            background: linear-gradient(90deg, #f0f7ff, #e3f2ff, #f0f7ff);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* ç¡®ä¿é˜…è¯»ææ–™æ­£ç¡®æ¢è¡Œ */
        .passage-text {
            white-space: pre-line;
            line-height: 1.8;
            font-size: 1rem;
            color: #374151;
        }

        /* é¢˜ç›®æ–‡æœ¬æ ·å¼ */
        .question-text {
            white-space: pre-line;
            line-height: 1.7;
        }

        /* æ–°å¢æ ·å¼ï¼šåˆ†ç±»æ ‡é¢˜å’Œå¡ç‰‡å¸ƒå±€ */
        .exam-category-section {
            margin-bottom: 3rem;
        }

        .exam-category-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid;
            display: inline-block;
        }

        .exam-category-title.cet4 {
            color: #2962FF;
            border-bottom-color: #2962FF;
        }

        .exam-category-title.cet6 {
            color: #7c3aed;
            border-bottom-color: #7c3aed;
        }

        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        /* æ–°å¢ï¼šåˆ†ç±»ç­›é€‰æŒ‰é’®æ ·å¼ */
        .category-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }

        .category-filter {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            background: white;
            color: #6b7280;
        }

        .category-filter:hover {
            border-color: #2962FF;
            color: #2962FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(41, 98, 255, 0.1);
        }

        .category-filter.active {
            background: #2962FF;
            color: white;
            border-color: #2962FF;
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.2);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .exam-main {
                flex-direction: column;
            }
            
            .navigation-sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }
            
            .question-content-area {
                padding: 1rem;
            }

            .exam-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .exam-header {
                padding: 1rem;
            }
            
            .exam-header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .question-grid-vertical {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .question-navigation {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .option-item {
                padding: 0.75rem 1rem;
            }
            
            .option-letter {
                width: 2rem;
                height: 2rem;
                margin-right: 0.75rem;
            }

            .exam-grid {
                grid-template-columns: 1fr;
            }

            .category-filters {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .category-filter {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        /* æ–°å¢ï¼šéŸ³é¢‘æ’­æ”¾å™¨æ ·å¼ - ä¸å¬åŠ›ç•Œé¢å®Œå…¨ä¸€è‡´ */
        .audio-player-container {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .audio-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .audio-player-title {
            font-weight: 600;
            color: #374151;
        }

        .audio-player-filename {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .audio-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .audio-controls button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .audio-controls button:hover {
            transform: translateY(-1px);
        }

        .audio-controls button:active {
            transform: translateY(0);
        }

        .audio-controls .play-btn {
            background: #2962FF;
            color: white;
        }

        .audio-controls .play-btn:hover {
            background: #1e40af;
        }

        .audio-controls .pause-btn {
            background: #6b7280;
            color: white;
        }

        .audio-controls .pause-btn:hover {
            background: #4b5563;
        }

        .audio-controls .replay-btn {
            background: #10b981;
            color: white;
        }

        .audio-controls .replay-btn:hover {
            background: #059669;
        }

        .progress-container {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #2962FF;
            width: 0%;
            transition: width 0.1s linear;
        }

        .audio-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .audio-status.success {
            color: #10b981;
        }

        .audio-status.warning {
            color: #f59e0b;
        }

        .audio-status.error {
            color: #ef4444;
        }

        .audio-help-info {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .audio-help-info h5 {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .audio-help-info p {
            color: #92400e;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .audio-help-info code {
            background: #fef7cd;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: #92400e;
        }

        /* æ–°å¢ï¼šéŸ³é¢‘è°ƒè¯•ä¿¡æ¯æ ·å¼ */
        .audio-debug-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="flex items-center justify-between px-6 lg:px-12 h-16 bg-white/90 backdrop-blur-md fixed top-0 left-0 right-0 z-50 border-b border-blue-50">
        <div class="flex items-center gap-8 lg:gap-16">
            <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="flex items-center gap-3">
                <span class="text-2xl font-bold tracking-tight" style="color: #2962FF;">äº‘æ¢¦æ™ºé—´</span>
            </a>
            <div class="hidden lg:flex items-center gap-8">
                <a href="äº‘æ¢¦æ™ºé—´å­¦ä¹ åˆ†æ.html" class="text-gray-700 hover:text-primary transition-colors font-medium">å¤‡è€ƒè§„åˆ’</a>
                <a href="äº‘æ¢¦æ™ºé—´æ•™å­¦.html" class="text-gray-700 hover:text-primary transition-colors font-medium">åœ¨çº¿æ•™å­¦</a>
                <a href="äº‘æ¢¦æ™ºé—´çœŸé¢˜è€ƒè¯•.html" class="text-gray-700 hover:text-primary transition-colors font-medium">çœŸé¢˜è€ƒè¯•</a>
                <a href="äº‘æ¢¦æ™ºé—´ç¤¾åŒº.html" class="text-gray-700 hover:text-primary transition-colors font-medium">å­¦ä¹ ç¤¾åŒº</a>
            </div>
        </div>
        
        <div class="flex items-center gap-4 lg:gap-6">
            <a href="#" class="flex items-center px-4 lg:px-6 py-2 bg-primary text-white rounded-button hover:bg-secondary transition-colors text-sm font-medium">
                é‡æ–°è¯„ä¼°
            </a>
            <div id="auth-section">
                <!-- åŠ¨æ€è®¤è¯å†…å®¹ -->
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto px-4 pt-20 py-8">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">çœŸé¢˜æ¨¡æ‹Ÿè€ƒè¯•</h1>
            <p class="text-gray-600">å…¨çœŸæ¨¡æ‹Ÿå››å…­çº§è€ƒè¯•ç¯å¢ƒï¼Œæå‡åº”è¯•èƒ½åŠ›</p>
            
            <div id="user-stats-section" class="mt-6">
                <!-- ç»Ÿè®¡ä¿¡æ¯åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- è®¤è¯çŠ¶æ€åŒæ­¥æŒ‡ç¤ºå™¨ -->
        <div id="auth-sync-indicator" class="bg-white rounded-lg shadow-sm p-4 mb-6 border border-blue-100 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div id="auth-sync-icon" class="w-8 h-8 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-sync-alt text-blue-500"></i>
                    </div>
                    <div>
                        <h4 id="auth-sync-title" class="font-semibold text-gray-800">åŒæ­¥è®¤è¯çŠ¶æ€</h4>
                        <p id="auth-sync-message" class="text-sm text-gray-600">æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...</p>
                    </div>
                </div>
                <div id="auth-sync-status" class="text-sm font-medium text-blue-600">
                    åŒæ­¥ä¸­...
                </div>
            </div>
        </div>

        <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
        <div id="guest-mode-message" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    <span class="text-blue-700">æ¸¸å®¢æ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™ã€‚ç™»å½•åå¯ä½¿ç”¨å®Œæ•´åŠŸèƒ½å¹¶ä¿å­˜å­¦ä¹ è®°å½•ã€‚</span>
                </div>
                <a href="#" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                    ç«‹å³ç™»å½•
                </a>
            </div>
        </div>

        <!-- åˆ†ç±»ç­›é€‰æŒ‰é’® -->
        <div class="category-filters">
            <button class="category-filter active" data-category="all">
                <i class="fas fa-th-large mr-2"></i>å…¨éƒ¨çœŸé¢˜
            </button>
            <button class="category-filter" data-category="cet4">
                <i class="fas fa-book mr-2"></i>å››çº§çœŸé¢˜
            </button>
            <button class="category-filter" data-category="cet6">
                <i class="fas fa-graduation-cap mr-2"></i>å…­çº§çœŸé¢˜
            </button>
        </div>

        <!-- è€ƒè¯•åˆ—è¡¨ -->
        <div id="examList" class="space-y-8">
            <!-- å†…å®¹åŠ¨æ€åŠ è½½ -->
        </div>

        <!-- è€ƒè¯•è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="examDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 id="examModalTitle" class="text-xl font-semibold"></h3>
                        <button id="closeExamModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div id="examModalContent">
                        <!-- è€ƒè¯•è¯¦æƒ…å†…å®¹åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- è€ƒè¯•ç»“æœæ¨¡æ€æ¡† -->
        <div id="examResultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-semibold">è€ƒè¯•å®Œæˆ</h3>
                            <p id="resultExamTitle" class="text-blue-100"></p>
                        </div>
                        <button id="closeResultModal" class="text-white hover:text-blue-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div id="examResultContent">
                        <!-- è€ƒè¯•ç»“æœå†…å®¹åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- è€ƒè¯•ç•Œé¢ -->
        <div id="examInterface" class="fixed inset-0 bg-white hidden z-50 flex flex-col exam-interface">
            <!-- é¡¶éƒ¨è€ƒè¯•ä¿¡æ¯æ  -->
            <div class="exam-header">
                <div class="exam-header-content">
                    <div class="exam-info">
                        <h2 id="examTitle">åŠ è½½ä¸­...</h2>
                        <p id="examInfo">è€ƒè¯•ä¿¡æ¯åŠ è½½ä¸­...</p>
                    </div>
                    <div class="exam-controls">
                        <div id="examTimer" class="timer-container">
                            <i class="fas fa-clock mr-2"></i>
                            <span class="font-mono font-bold">120:00</span>
                        </div>
                        <button id="submitExam" class="nav-button submit">
                            <i class="fas fa-paper-plane mr-2"></i>
                            æäº¤è¯•å·
                        </button>
                        <button id="exitExam" class="nav-button prev">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            é€€å‡ºè€ƒè¯•
                        </button>
                    </div>
                </div>
            </div>

            <div class="exam-main">
                <!-- å·¦ä¾§é¢˜ç›®å¯¼èˆª -->
                <div class="navigation-sidebar">
                    <h3 class="font-semibold mb-4 text-gray-700 border-b pb-2">é¢˜ç›®å¯¼èˆª</h3>
                    
                    <!-- å‚ç›´éƒ¨åˆ†æ ‡ç­¾ -->
                    <div id="sectionTabs" class="section-tabs-vertical">
                        <!-- éƒ¨åˆ†æ ‡ç­¾åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="section-info">
                        <h4 class="font-semibold text-blue-800 text-sm">å½“å‰éƒ¨åˆ†</h4>
                        <p id="currentSectionName" class="text-blue-600 text-sm font-medium">åŠ è½½ä¸­...</p>
                        <div class="flex justify-between text-xs text-blue-500 mt-1">
                            <span>é¢˜ç›®: <span id="currentSectionQuestionCount">0</span></span>
                            <span>æ—¶é—´: <span id="currentSectionTime">30åˆ†é’Ÿ</span></span>
                        </div>
                    </div>

                    <!-- é¢˜ç›®ç½‘æ ¼å¯¼èˆª -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-700 text-sm mb-2">é¢˜ç›®åˆ—è¡¨</h4>
                        <div id="questionNavigation" class="question-grid-vertical">
                            <!-- é¢˜ç›®ç¼–å·åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§é¢˜ç›®å†…å®¹ -->
                <div class="question-content-area">
                    <div class="question-container">
                        <!-- æ–°å¢ï¼šéŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨ -->
                        <div id="exam-audio-player-container" class="audio-player-container hidden">
                            <!-- éŸ³é¢‘æ’­æ”¾å™¨åŠ¨æ€åŠ è½½ -->
                        </div>
                        
                        <div id="currentSection" class="mb-6">
                            <!-- å½“å‰éƒ¨åˆ†ä¿¡æ¯ -->
                        </div>
                        <div id="questionContent">
                            <!-- é¢˜ç›®å†…å®¹åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªåŒºåŸŸ -->
            <div class="question-navigation">
                <div class="progress-info">
                    å·²ç­” <span id="answeredCount">0</span> / <span id="totalCount">0</span> é¢˜
                </div>
                <div class="nav-buttons">
                    <button id="prevQuestion" class="nav-button prev">
                        <i class="fas fa-arrow-left mr-2"></i>
                        ä¸Šä¸€é¢˜
                    </button>
                    <button id="nextQuestion" class="nav-button next">
                        ä¸‹ä¸€é¢˜
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        let examPapers = [];
        let currentExam = null;
        let currentSession = null;
        let examState = {
            currentSectionIndex: 0,
            currentQuestionIndex: 0,
            answers: {},
            timeRemaining: 0,
            timerInterval: null,
            currentSectionData: null
        };

        // éŸ³é¢‘æ’­æ”¾å™¨çŠ¶æ€ - ä¸å¬åŠ›ç•Œé¢å®Œå…¨ä¸€è‡´
        let audioPlayerState = {
            audioPlayer: null,
            isPlaying: false,
            audioProgressInterval: null,
            audioProgressBar: null,
            currentAudioUrl: null
        };

        // APIåŸºç¡€URL
        const API_BASE_URL = '/api/exam';

        // å¢å¼ºç‰ˆè€ƒè¯•ç®¡ç†å™¨ - éŸ³é¢‘åŠŸèƒ½å®Œå…¨ä¸å¬åŠ›ç•Œé¢ä¸€è‡´
        class EnhancedExamManager {
            constructor() {
                this.isAuthenticated = false;
                this.currentUser = null;
                this.authSystemReady = false;
                this.saveTimeout = null;
                this.baseURL = API_BASE_URL;
                this.currentCategory = 'all';
                this.init();
            }

            async init() {
                console.log('ğŸš€ åˆå§‹åŒ–å¢å¼ºç‰ˆè€ƒè¯•ç®¡ç†å™¨ - éŸ³é¢‘åŠŸèƒ½ä¸å¬åŠ›ç•Œé¢ä¸€è‡´');
                this.bindEvents();
                
                // ç­‰å¾…ç»Ÿä¸€è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–
                await this.waitForAuthSystem();
                
                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                await this.checkAuthentication();
                
                // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
                this.setupAuthListeners();
                
                // è®¾ç½®åˆ†ç±»ç­›é€‰äº‹ä»¶
                this.setupCategoryFilters();
                
                // å¦‚æœå·²ç™»å½•ï¼ŒåŠ è½½æ•°æ®
                if (this.isAuthenticated) {
                    await this.loadExamList();
                }
            }

            // è®¾ç½®åˆ†ç±»ç­›é€‰äº‹ä»¶
            setupCategoryFilters() {
                const filters = document.querySelectorAll('.category-filter');
                filters.forEach(filter => {
                    filter.addEventListener('click', () => {
                        const category = filter.getAttribute('data-category');
                        this.setCurrentCategory(category);
                    });
                });
            }

            // è®¾ç½®å½“å‰åˆ†ç±»
            setCurrentCategory(category) {
                this.currentCategory = category;
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                const filters = document.querySelectorAll('.category-filter');
                filters.forEach(filter => {
                    if (filter.getAttribute('data-category') === category) {
                        filter.classList.add('active');
                    } else {
                        filter.classList.remove('active');
                    }
                });
                
                // é‡æ–°æ¸²æŸ“è€ƒè¯•åˆ—è¡¨
                this.renderExamList();
            }

            // ç­‰å¾…ç»Ÿä¸€è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–
            async waitForAuthSystem() {
                return new Promise((resolve) => {
                    const checkAuth = () => {
                        if (window.unifiedAuthManager && window.unifiedAuthManager.isInitialized) {
                            console.log('âœ… ç»Ÿä¸€è®¤è¯ç³»ç»Ÿå·²å°±ç»ª');
                            this.authSystemReady = true;
                            resolve();
                        } else if (window.uiManager && window.uiManager.authManager) {
                            console.log('âœ… UIç®¡ç†å™¨è®¤è¯ç³»ç»Ÿå·²å°±ç»ª');
                            this.authSystemReady = true;
                            resolve();
                        } else {
                            setTimeout(checkAuth, 100);
                        }
                    };
                    checkAuth();
                });
            }

            // å¢å¼ºè®¤è¯æ£€æŸ¥æ–¹æ³•
            async checkAuthentication() {
                try {
                    // ä½¿ç”¨ç»Ÿä¸€è®¤è¯ç³»ç»Ÿæ£€æŸ¥çŠ¶æ€
                    if (window.unifiedAuthManager) {
                        this.isAuthenticated = window.unifiedAuthManager.isLoggedIn();
                        this.currentUser = window.unifiedAuthManager.getCurrentUser();
                    } else if (window.uiManager && window.uiManager.authManager) {
                        this.isAuthenticated = window.uiManager.authManager.isLoggedIn();
                        this.currentUser = window.uiManager.authManager.getCurrentUser();
                    } else {
                        // é™çº§ï¼šæ£€æŸ¥æœ¬åœ°å­˜å‚¨
                        const token = localStorage.getItem('auth_token');
                        const userData = localStorage.getItem('user_data');
                        this.isAuthenticated = !!(token && userData);
                        if (userData) {
                            try {
                                this.currentUser = JSON.parse(userData);
                            } catch (e) {
                                console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }

                    console.log('ğŸ” è€ƒè¯•ç³»ç»Ÿè®¤è¯æ£€æŸ¥ç»“æœ:', {
                        isAuthenticated: this.isAuthenticated,
                        user: this.currentUser
                    });

                    // æ›´æ–°UI
                    this.updateAuthUI();
                    
                } catch (error) {
                    console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                    this.showLoginRequired();
                }
            }

            // æ›´æ–°è®¤è¯UI
            updateAuthUI() {
                if (this.isAuthenticated && this.currentUser) {
                    // å·²ç™»å½•çŠ¶æ€
                    this.showAuthenticatedUI();
                } else {
                    // æœªç™»å½•çŠ¶æ€
                    this.showLoginRequired();
                }
                this.updateGuestModeDisplay();
            }

            // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€çš„UI
            showAuthenticatedUI() {
                // éšè—ç™»å½•æç¤º
                const loginPrompt = document.querySelector('.login-prompt-overlay');
                if (loginPrompt) loginPrompt.style.display = 'none';
                
                // ç¡®ä¿è€ƒè¯•åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
                this.loadExamList();
            }

            // æ˜¾ç¤ºç™»å½•è¦æ±‚
            showLoginRequired() {
                const container = document.getElementById('examList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-12 fade-in">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user-lock text-primary text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">è¯·å…ˆç™»å½•</h3>
                            <p class="text-gray-600 mb-6">ç™»å½•åå³å¯ä½¿ç”¨çœŸé¢˜è€ƒè¯•åŠŸèƒ½</p>
                            <button onclick="examManager.handleLogin()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors font-medium">
                                <i class="fas fa-sign-in-alt mr-2"></i>ç«‹å³ç™»å½•
                            </button>
                        </div>
                    `;
                }
                
                // ç¦ç”¨å¼€å§‹è€ƒè¯•æŒ‰é’®
                const startButtons = document.querySelectorAll('.start-exam-btn');
                startButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
            }

            // å¤„ç†ç™»å½•
            handleLogin() {
                window.location.href = 'äº‘æ¢¦æ™ºé—´ç™»å½•.html';
            }

            // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
            setupAuthListeners() {
                // ç›‘å¬ç»Ÿä¸€è®¤è¯ç³»ç»Ÿçš„çŠ¶æ€å˜åŒ–
                if (window.unifiedAuthManager) {
                    window.unifiedAuthManager.addAuthListener((isLoggedIn, user, authState) => {
                        console.log('ğŸ”” è€ƒè¯•ç³»ç»Ÿæ”¶åˆ°è®¤è¯çŠ¶æ€å˜åŒ–:', { isLoggedIn, user });
                        this.handleAuthStateChange(isLoggedIn, user, authState);
                    });
                }
                
                // ç›‘å¬UIç®¡ç†å™¨çš„è®¤è¯çŠ¶æ€å˜åŒ–
                if (window.uiManager && window.uiManager.authManager) {
                    window.uiManager.authManager.addAuthListener((isLoggedIn, user, authState) => {
                        console.log('ğŸ”” è€ƒè¯•ç³»ç»Ÿæ”¶åˆ°UIç®¡ç†å™¨è®¤è¯çŠ¶æ€å˜åŒ–:', { isLoggedIn, user });
                        this.handleAuthStateChange(isLoggedIn, user, authState);
                    });
                }
                
                // ç›‘å¬å…¨å±€è®¤è¯äº‹ä»¶
                document.addEventListener('authSystemReady', (event) => {
                    console.log('ğŸ”” è€ƒè¯•ç³»ç»Ÿæ”¶åˆ°å…¨å±€è®¤è¯å°±ç»ªäº‹ä»¶');
                    this.checkAuthentication();
                });
                
                document.addEventListener('uiAuthStateUpdated', (event) => {
                    console.log('ğŸ”” è€ƒè¯•ç³»ç»Ÿæ”¶åˆ°UIè®¤è¯çŠ¶æ€æ›´æ–°äº‹ä»¶');
                    const { isLoggedIn, user } = event.detail;
                    this.handleAuthStateChange(isLoggedIn, user);
                });
            }

            // å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–
            handleAuthStateChange(isLoggedIn, user, authState) {
                this.isAuthenticated = isLoggedIn;
                this.currentUser = user;
                
                if (isLoggedIn) {
                    this.showAuthenticatedUI();
                    // é‡æ–°åŠ è½½æ•°æ®
                    this.loadExamList();
                } else {
                    this.showLoginRequired();
                }
                
                this.updateGuestModeDisplay();
            }

            // æ›´æ–°æ¸¸å®¢æ¨¡å¼æ˜¾ç¤º
            updateGuestModeDisplay() {
                const guestMessage = document.getElementById('guest-mode-message');
                if (guestMessage) {
                    guestMessage.classList.toggle('hidden', this.isAuthenticated);
                }
            }

            // å¢å¼ºAPIè¯·æ±‚æ–¹æ³•ï¼Œæ·»åŠ è®¤è¯å¤´
            async makeApiRequest(endpoint, options = {}) {
                try {
                    const url = `${this.baseURL}${endpoint}`;
                    
                    // è·å–è®¤è¯token
                    let token = '';
                    if (window.unifiedAuthManager) {
                        token = window.unifiedAuthManager.getToken();
                    } else if (window.uiManager && window.uiManager.authManager) {
                        token = window.uiManager.authManager.getToken();
                    } else {
                        token = localStorage.getItem('auth_token');
                    }
                    
                    const defaultOptions = {
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token && { 'Authorization': `Bearer ${token}` })
                        },
                        ...options
                    };

                    console.log('ğŸ” å‘é€APIè¯·æ±‚:', { endpoint, hasToken: !!token });
                    
                    const response = await fetch(url, defaultOptions);
                    
                    if (!response.ok) {
                        // å¦‚æœè®¤è¯å¤±è´¥ï¼Œé‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€
                        if (response.status === 401) {
                            console.log('ğŸ” APIè¿”å›401ï¼Œé‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€');
                            await this.checkAuthentication();
                        }
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`APIè¯·æ±‚é”™è¯¯: ${endpoint}`, error);
                    throw error;
                }
            }

            // åŠ è½½è€ƒè¯•åˆ—è¡¨ - å¢å¼ºç‰ˆæœ¬
            async loadExamList() {
                console.log('ğŸ¯ loadExamList è¢«è°ƒç”¨ - å¢å¼ºç‰ˆæœ¬');
                console.log('ğŸ” å½“å‰è®¤è¯çŠ¶æ€:', this.isAuthenticated);
                
                const examList = document.getElementById('examList');
                
                if (!this.isAuthenticated) {
                    this.showLoginRequired();
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                examList.innerHTML = `
                    <div class="text-center py-12 auth-sync-loading rounded-lg">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="mt-4 text-gray-600">æ­£åœ¨åŠ è½½çœŸé¢˜è¯•å·...</p>
                        <p class="text-sm text-gray-500 mt-2">ç”¨æˆ·: ${this.currentUser?.name || this.currentUser?.username || 'æœªçŸ¥ç”¨æˆ·'}</p>
                    </div>
                `;

                try {
                    // ä½¿ç”¨å¢å¼ºçš„APIè¯·æ±‚æ–¹æ³•
                    const result = await this.makeApiRequest('/papers');
                    
                    if (result.success) {
                        examPapers = result.data;
                        this.renderExamList();
                    } else {
                        throw new Error(result.message || 'è·å–è¯•å·åˆ—è¡¨å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('ğŸš¨ åŠ è½½è€ƒè¯•åˆ—è¡¨å¤±è´¥:', error);
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                    if (error.message.includes('401') || error.message.includes('è®¤è¯')) {
                        this.showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'warning');
                        setTimeout(() => {
                            window.location.href = 'äº‘æ¢¦æ™ºé—´ç™»å½•.html';
                        }, 2000);
                    } else {
                        this.showErrorState('åŠ è½½è¯•å·åˆ—è¡¨å¤±è´¥', error.message);
                    }
                }
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, type = 'info') {
                // ä½¿ç”¨UIç®¡ç†å™¨çš„æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½
                if (window.uiManager && window.uiManager.showMessage) {
                    window.uiManager.showMessage(message, type);
                } else {
                    // é™çº§æ˜¾ç¤º
                    alert(`${type.toUpperCase()}: ${message}`);
                }
            }

            // æ¸²æŸ“è€ƒè¯•åˆ—è¡¨ - ä¿®æ”¹ï¼šæ ¹æ®å½“å‰åˆ†ç±»æ¸²æŸ“
            renderExamList() {
                const examList = document.getElementById('examList');
                console.log('ğŸ¨ æ¸²æŸ“è€ƒè¯•åˆ—è¡¨ï¼Œæ•°æ®:', examPapers);
                
                if (!examPapers || examPapers.length === 0) {
                    examList.innerHTML = `
                        <div class="text-center py-12 fade-in">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">æš‚æ— å¯ç”¨çœŸé¢˜è¯•å·</p>
                        </div>
                    `;
                    return;
                }

                // è¿‡æ»¤è¯•å·ï¼Œåªä¿ç•™ç¿»è¯‘ã€å†™ä½œå’Œé˜…è¯»ç†è§£éƒ¨åˆ†ï¼Œç§»é™¤å¬åŠ›éƒ¨åˆ†
                const filteredPapers = examPapers.filter(paper => {
                    // è¿‡æ»¤æ‰å¬åŠ›éƒ¨åˆ†
                    if (paper.sections) {
                        paper.sections = paper.sections.filter(section => {
                            // ä¿ç•™ç¿»è¯‘ã€å†™ä½œå’Œé˜…è¯»ç†è§£éƒ¨åˆ†
                            return section.section_type && (
                                section.section_type.includes('translation') || 
                                section.section_type.includes('writing') || 
                                section.section_type.includes('reading')
                            );
                        });
                    }
                    return paper;
                });

                // æŒ‰è€ƒè¯•ç±»å‹åˆ†ç»„
                const cet4Papers = filteredPapers.filter(paper => 
                    paper.exam_type && paper.exam_type.includes('CET-4')
                );
                
                const cet6Papers = filteredPapers.filter(paper => 
                    paper.exam_type && paper.exam_type.includes('CET-6')
                );

                // æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç±»æ¸²æŸ“
                let html = '';
                
                // å…¨éƒ¨çœŸé¢˜
                if (this.currentCategory === 'all') {
                    // å››çº§çœŸé¢˜éƒ¨åˆ†
                    if (cet4Papers.length > 0) {
                        html += this.renderExamCategory('å››çº§çœŸé¢˜', 'cet4', cet4Papers);
                    }
                    
                    // å…­çº§çœŸé¢˜éƒ¨åˆ†
                    if (cet6Papers.length > 0) {
                        html += this.renderExamCategory('å…­çº§çœŸé¢˜', 'cet6', cet6Papers);
                    }
                }
                // å››çº§çœŸé¢˜
                else if (this.currentCategory === 'cet4' && cet4Papers.length > 0) {
                    html += this.renderExamCategory('å››çº§çœŸé¢˜', 'cet4', cet4Papers);
                }
                // å…­çº§çœŸé¢˜
                else if (this.currentCategory === 'cet6' && cet6Papers.length > 0) {
                    html += this.renderExamCategory('å…­çº§çœŸé¢˜', 'cet6', cet6Papers);
                }
                
                // å¦‚æœæ²¡æœ‰è¯•å·ï¼Œæ˜¾ç¤ºæç¤º
                if (html === '') {
                    html = `
                        <div class="text-center py-12 fade-in">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">æš‚æ— å¯ç”¨çœŸé¢˜è¯•å·</p>
                        </div>
                    `;
                }
                
                examList.innerHTML = html;
                
                console.log('âœ… è€ƒè¯•åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
                this.updateGuestModeDisplay();
            }

            // æ–°å¢ï¼šæ¸²æŸ“è€ƒè¯•åˆ†ç±»
            renderExamCategory(title, categoryClass, papers) {
                return `
                    <div class="exam-category-section">
                        <h2 class="exam-category-title ${categoryClass}">${title}</h2>
                        <div class="exam-grid">
                            ${papers.map(paper => this.renderExamCard(paper)).join('')}
                        </div>
                    </div>
                `;
            }

            // ä¿®æ”¹ï¼šæ¸²æŸ“å•ä¸ªè€ƒè¯•å¡ç‰‡
            renderExamCard(paper) {
                // è®¡ç®—éå¬åŠ›é¢˜ç›®çš„æ•°é‡
                const nonListeningQuestions = paper.sections ? 
                    paper.sections.reduce((total, section) => {
                        // åªè®¡ç®—ç¿»è¯‘ã€å†™ä½œå’Œé˜…è¯»ç†è§£éƒ¨åˆ†çš„é¢˜ç›®
                        if (section.section_type && (
                            section.section_type.includes('translation') || 
                            section.section_type.includes('writing') || 
                            section.section_type.includes('reading')
                        )) {
                            return total + (section.questions_count || 0);
                        }
                        return total;
                    }, 0) : 0;

                return `
                    <div class="exam-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow fade-in border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">${paper.title || 'æœªçŸ¥è¯•å·'}</h3>
                                <p class="text-gray-600 mt-1">${paper.description || 'å…¨çœŸæ¨¡æ‹Ÿè€ƒè¯•'}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                ${paper.exam_type || 'CET-4'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                            <div class="text-center">
                                <div class="text-gray-500">å¹´ä»½</div>
                                <div class="font-semibold">${paper.year || '2024'}å¹´${paper.month || '6'}æœˆ</div>
                            </div>
                            <div class="text-center">
                                <div class="text-gray-500">é¢˜ç›®æ•°é‡</div>
                                <div class="font-semibold">${nonListeningQuestions}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-gray-500">è€ƒè¯•æ—¶é•¿</div>
                                <div class="font-semibold">${paper.time_allowed || 120}åˆ†é’Ÿ</div>
                            </div>
                            <div class="text-center">
                                <div class="text-gray-500">æ€»åˆ†</div>
                                <div class="font-semibold">${paper.total_score || 710}</div>
                            </div>
                        </div>

                        <div class="exam-sections mb-4">
                            <div class="text-sm text-gray-500 mb-2">åŒ…å«é¢˜å‹ï¼š</div>
                            <div class="flex flex-wrap gap-2">
                                ${this.renderSectionBadges(paper)}
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="examManager.showExamDetail(${paper.id})" 
                                    class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            <button onclick="examManager.startExam(${paper.id})" 
                                    class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                <i class="fas fa-play mr-2"></i>
                                å¼€å§‹è€ƒè¯•
                            </button>
                        </div>
                    </div>
                `;
            }

            // æ–°å¢ï¼šæ¸²æŸ“éƒ¨åˆ†å¾½ç« 
            renderSectionBadges(paper) {
                if (!paper.sections || paper.sections.length === 0) {
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">ç¿»è¯‘å†™ä½œé˜…è¯»</span>';
                }
                
                const sectionTypes = new Set();
                
                paper.sections.forEach(section => {
                    if (section.section_type) {
                        if (section.section_type.includes('translation')) {
                            sectionTypes.add('ç¿»è¯‘');
                        } else if (section.section_type.includes('writing')) {
                            sectionTypes.add('å†™ä½œ');
                        } else if (section.section_type.includes('reading')) {
                            sectionTypes.add('é˜…è¯»');
                        }
                    }
                });
                
                // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„éƒ¨åˆ†ç±»å‹ï¼Œæ˜¾ç¤ºé»˜è®¤å€¼
                if (sectionTypes.size === 0) {
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">ç¿»è¯‘å†™ä½œé˜…è¯»</span>';
                }
                
                return Array.from(sectionTypes).map(type => 
                    `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">${type}</span>`
                ).join('');
            }

            // æ˜¾ç¤ºè€ƒè¯•è¯¦æƒ…
            async showExamDetail(paperId) {
                if (!this.isAuthenticated) {
                    this.showLoginPrompt();
                    return;
                }
                
                try {
                    const result = await this.makeApiRequest(`/papers/${paperId}`);
                    
                    if (result.success) {
                        this.renderExamDetail(result.data);
                    } else {
                        throw new Error(result.message || 'è·å–è¯•å·è¯¦æƒ…å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½è€ƒè¯•è¯¦æƒ…å¤±è´¥:', error);
                    this.showMessage('åŠ è½½è¯•å·è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
                }
            }

            renderExamDetail(paper) {
                const modal = document.getElementById('examDetailModal');
                const title = document.getElementById('examModalTitle');
                const content = document.getElementById('examModalContent');

                title.textContent = paper.title;

                // è®¡ç®—éå¬åŠ›é¢˜ç›®çš„æ•°é‡
                const nonListeningQuestions = paper.sections ? 
                    paper.sections.reduce((total, section) => {
                        // åªè®¡ç®—ç¿»è¯‘ã€å†™ä½œå’Œé˜…è¯»ç†è§£éƒ¨åˆ†çš„é¢˜ç›®
                        if (section.section_type && (
                            section.section_type.includes('translation') || 
                            section.section_type.includes('writing') || 
                            section.section_type.includes('reading')
                        )) {
                            return total + (section.questions_count || 0);
                        }
                        return total;
                    }, 0) : 0;

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600">${paper.year || '2024'}</div>
                                <div class="text-sm text-blue-600">å¹´ä»½</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600">${paper.month || '6'}</div>
                                <div class="text-sm text-green-600">æœˆä»½</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600">${nonListeningQuestions}</div>
                                <div class="text-sm text-purple-600">é¢˜ç›®æ•°é‡</div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-orange-600">${paper.time_allowed || 120}</div>
                                <div class="text-sm text-orange-600">è€ƒè¯•æ—¶é•¿(åˆ†é’Ÿ)</div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold mb-3">è¯•å·è¯´æ˜</h4>
                            <p class="text-gray-600 bg-gray-50 p-4 rounded-lg">${paper.description || 'æš‚æ— è¯¦ç»†è¯´æ˜'}</p>
                        </div>

                        <div>
                            <h4 class="font-semibold mb-3">è€ƒè¯•å†…å®¹</h4>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-blue-700"><i class="fas fa-check-circle mr-2"></i>æœ¬è¯•å·å·²è¿‡æ»¤å¬åŠ›éƒ¨åˆ†ï¼ŒåŒ…å«ç¿»è¯‘ã€å†™ä½œå’Œé˜…è¯»ç†è§£é¢˜å‹</p>
                            </div>
                        </div>

                        <div class="flex space-x-3 pt-4 border-t">
                            <button onclick="examManager.startExam(${paper.id})" 
                                    class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center text-lg start-exam-btn">
                                <i class="fas fa-play mr-2"></i>
                                å¼€å§‹æ¨¡æ‹Ÿè€ƒè¯•
                            </button>
                        </div>
                    </div>
                `;

                this.updateGuestModeDisplay();
                modal.classList.remove('hidden');
            }

            // å¼€å§‹è€ƒè¯•
            async startExam(paperId) {
                if (!this.isAuthenticated) {
                    this.showLoginPrompt();
                    return;
                }

                try {
                    const result = await this.makeApiRequest('/sessions/start', {
                        method: 'POST',
                        body: JSON.stringify({
                            paper_id: paperId,
                            user_id: this.currentUser?.id
                        })
                    });
                    
                    if (result.success) {
                        currentExam = this.normalizeExamData(result.data.paper);
                        currentSession = result.data.session;
                        this.initializeExam();
                    } else {
                        throw new Error(result.message || 'å¼€å§‹è€ƒè¯•å¤±è´¥');
                    }
                } catch (error) {
                    console.error('å¼€å§‹è€ƒè¯•å¤±è´¥:', error);
                    this.showMessage('å¼€å§‹è€ƒè¯•å¤±è´¥: ' + error.message, 'error');
                }
            }

            normalizeExamData(examData) {
                if (!examData) return null;
                
                // è¿‡æ»¤æ‰å¬åŠ›éƒ¨åˆ†
                if (examData.sections) {
                    examData.sections = examData.sections.filter(section => {
                        // ä¿ç•™ç¿»è¯‘ã€å†™ä½œå’Œé˜…è¯»ç†è§£éƒ¨åˆ†
                        return section.section_type && (
                            section.section_type.includes('translation') || 
                            section.section_type.includes('writing') || 
                            section.section_type.includes('reading')
                        );
                    });
                }
                
                return {
                    id: examData.id,
                    title: examData.title,
                    exam_type: examData.exam_type,
                    year: examData.year,
                    month: examData.month,
                    total_score: examData.total_score || 710,
                    time_allowed: examData.time_allowed || 120,
                    questions_count: examData.questions_count || 0,
                    sections: examData.sections || []
                };
            }

            showLoginPrompt() {
                this.showMessage('è¯·å…ˆç™»å½•åä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
            }

            // åˆå§‹åŒ–è€ƒè¯•ç•Œé¢
            initializeExam() {
                document.getElementById('examDetailModal').classList.add('hidden');
                
                document.getElementById('examTitle').textContent = currentExam.title;
                document.getElementById('examInfo').textContent = 
                    `${currentExam.exam_type} - ${currentExam.year}å¹´${currentExam.month}æœˆ - æ€»åˆ†: ${currentExam.total_score}`;
                
                examState = {
                    currentSectionIndex: 0,
                    currentQuestionIndex: 0,
                    answers: {},
                    timeRemaining: currentExam.time_allowed * 60,
                    timerInterval: null,
                    currentSectionData: null
                };

                this.startTimer();
                this.loadCurrentSection();
                document.getElementById('examInterface').classList.remove('hidden');
            }

            startTimer() {
                const timerElement = document.getElementById('examTimer');
                
                if (examState.timerInterval) {
                    clearInterval(examState.timerInterval);
                }

                const updateTimer = () => {
                    examState.timeRemaining--;
                    
                    if (examState.timeRemaining <= 0) {
                        this.submitExam();
                        return;
                    }

                    // ä¿®å¤ï¼šæ­£ç¡®æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
                    const minutes = Math.floor(examState.timeRemaining / 60);
                    const seconds = examState.timeRemaining % 60;
                    timerElement.querySelector('span').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (examState.timeRemaining <= 300 && !timerElement.classList.contains('warning')) {
                        timerElement.classList.add('warning');
                    }
                };

                updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
                examState.timerInterval = setInterval(updateTimer, 1000);
            }

            // ä¿®å¤ï¼šåŠ è½½å½“å‰éƒ¨åˆ† - å¢å¼ºæ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
            async loadCurrentSection() {
                try {
                    console.log('ğŸ” åŠ è½½å½“å‰éƒ¨åˆ†:', {
                        paperId: currentExam.id,
                        sectionIndex: examState.currentSectionIndex,
                        examTitle: currentExam.title
                    });

                    const result = await this.makeApiRequest(`/papers/${currentExam.id}/sections/${examState.currentSectionIndex}`);
                    
                    if (result.success) {
                        console.log('âœ… éƒ¨åˆ†æ•°æ®åŠ è½½æˆåŠŸ:', {
                            currentSection: result.data.currentSection,
                            sectionsCount: result.data.sections?.length,
                            questionsCount: result.data.currentSection?.questions?.length,
                            hasPassage: !!result.data.currentSection?.passage_content,
                            hasTranslation: !!result.data.currentSection?.translation_content
                        });
                        
                        // æ•°æ®éªŒè¯å’Œå¢å¼º
                        if (result.data.currentSection) {
                            // ç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨
                            result.data.currentSection.passage_content = result.data.currentSection.passage_content || '';
                            result.data.currentSection.translation_content = result.data.currentSection.translation_content || '';
                            result.data.currentSection.directions = result.data.currentSection.directions || '';
                            
                            // éªŒè¯é¢˜ç›®æ•°æ®
                            if (result.data.currentSection.questions) {
                                result.data.currentSection.questions = result.data.currentSection.questions.map(q => ({
                                    ...q,
                                    question_text: q.question_text || `é¢˜ç›® ${q.question_number || 'æœªçŸ¥'}`,
                                    options: q.options || [],
                                    passage_content: q.passage_content || result.data.currentSection.passage_content || '',
                                    translation_content: q.translation_content || result.data.currentSection.translation_content || ''
                                }));
                            }
                        }
                        
                        examState.currentSectionData = result.data;
                        this.renderCurrentSection();
                        
                        // æ£€æŸ¥å½“å‰éƒ¨åˆ†æ˜¯å¦ä¸ºå¬åŠ›éƒ¨åˆ†ï¼Œå¦‚æœæ˜¯åˆ™è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
                        const currentSection = examState.currentSectionData.currentSection;
                        if (currentSection && this.isListeningSection(currentSection)) {
                            await this.setupExamAudioPlayer();
                        } else {
                            // éšè—éŸ³é¢‘æ’­æ”¾å™¨
                            document.getElementById('exam-audio-player-container').classList.add('hidden');
                        }
                    } else {
                        throw new Error(result.message || 'åŠ è½½éƒ¨åˆ†å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½éƒ¨åˆ†å¤±è´¥:', error);
                    this.showMessage('åŠ è½½é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
                    this.showNoQuestionsMessage();
                }
            }

            // æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå¬åŠ›éƒ¨åˆ†çš„æ–¹æ³• - ä¸å¬åŠ›ç•Œé¢é€»è¾‘ä¸€è‡´
            isListeningSection(section) {
                if (!section || !section.section_type) return false;
                
                const listeningTypes = ['listening', 'å¬åŠ›', 'å¬åŠ›ç†è§£', 'å¬åŠ›éƒ¨åˆ†'];
                return listeningTypes.some(type => 
                    section.section_type.toLowerCase().includes(type.toLowerCase())
                );
            }

            // ä¿®æ”¹ï¼šè®¾ç½®è€ƒè¯•éŸ³é¢‘æ’­æ”¾å™¨ - å®Œå…¨ä¸å¬åŠ›ç•Œé¢ä¸€è‡´
            async setupExamAudioPlayer() {
                const audioContainer = document.getElementById('exam-audio-player-container');
                if (!audioContainer) return;
                
                audioContainer.classList.remove('hidden');
                
                const audioInfo = await this.findAudioFile(currentExam);
                
                if (audioInfo && audioInfo.exists) {
                    // ä½¿ç”¨ä¸å¬åŠ›ç•Œé¢å®Œå…¨ä¸€è‡´çš„URLç”Ÿæˆé€»è¾‘
                    const audioUrls = this.generateAudioUrls(audioInfo);
                    
                    console.log('ğŸµ è€ƒè¯•ç•Œé¢å°è¯•çš„éŸ³é¢‘URL:', audioUrls);
                    
                    // ä½¿ç”¨ç¬¬ä¸€ä¸ªURLï¼Œä½†æä¾›å¤‡ç”¨æµ‹è¯•
                    const actualAudioUrl = audioUrls[0];
                    
                    audioContainer.innerHTML = this.renderAudioPlayer(audioInfo, actualAudioUrl, audioUrls);
                    this.setupAudioPlayerControls(audioInfo, actualAudioUrl);
                    
                    // ç«‹å³æµ‹è¯•æ‰€æœ‰URLçš„å¯ç”¨æ€§
                    this.testAudioUrls(audioUrls, audioInfo.filename);
                    
                } else {
                    // éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œå¸®åŠ©
                    const filename = this.generateAudioFilename(currentExam) || 'æœªçŸ¥æ–‡ä»¶';
                    audioContainer.innerHTML = this.renderAudioError(filename);
                }
            }

            // æ–°å¢ï¼šç”Ÿæˆä¸å¬åŠ›ç•Œé¢ä¸€è‡´çš„éŸ³é¢‘URLåˆ—è¡¨
            generateAudioUrls(audioInfo) {
                const urls = [];
                const filename = audioInfo.filename;
                
                // ä¸»è¦URLï¼ˆä¸å¬åŠ›ç•Œé¢ä¸€è‡´ï¼‰
                if (audioInfo.webPath) {
                    urls.push(audioInfo.webPath);
                }
                
                // å¤‡ç”¨URLï¼ˆä¸å¬åŠ›ç•Œé¢ä¸€è‡´ï¼‰
                urls.push(
                    `/api/test-audio/${filename}`,
                    `/api/listening/audio/${filename}`,
                    `/å››çº§å¬åŠ›/${filename}`,
                    `/å…­çº§å¬åŠ›/${filename}`,
                    `/audio/${filename}`,
                    `/cet4-audio/${filename}`,
                    `/cet6-audio/${filename}`,
                    `/audio-fallback/${filename}`
                );
                
                return [...new Set(urls)]; // å»é‡
            }

            // æ–°å¢ï¼šæµ‹è¯•æ‰€æœ‰éŸ³é¢‘URLçš„å¯ç”¨æ€§
            async testAudioUrls(urls, filename) {
                console.log('ğŸ§ª è€ƒè¯•ç•Œé¢æµ‹è¯•éŸ³é¢‘URLå¯ç”¨æ€§:');
                
                for (const url of urls) {
                    try {
                        const response = await fetch(url, { method: 'HEAD' });
                        console.log(`   ${response.status === 200 ? 'âœ…' : 'âŒ'} ${url}: ${response.status}`);
                        
                        if (response.status === 200) {
                            // æ‰¾åˆ°å¯ç”¨çš„URLï¼Œæ›´æ–°éŸ³é¢‘æº
                            this.updateAudioSource(url);
                            break;
                        }
                    } catch (error) {
                        console.log(`   âŒ ${url}: ${error.message}`);
                    }
                }
            }

            // æ–°å¢ï¼šæ›´æ–°éŸ³é¢‘æº
            updateAudioSource(workingUrl) {
                if (!audioPlayerState.audioPlayer) return;
                
                const currentSource = audioPlayerState.audioPlayer.querySelector('source');
                if (currentSource && currentSource.src !== workingUrl) {
                    currentSource.src = workingUrl;
                    audioPlayerState.audioPlayer.load(); // é‡æ–°åŠ è½½éŸ³é¢‘
                    
                    console.log('ğŸ”„ æ›´æ–°éŸ³é¢‘æºä¸º:', workingUrl);
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const statusElement = document.querySelector('.audio-status');
                    if (statusElement) {
                        statusElement.className = 'audio-status success';
                        statusElement.innerHTML = `
                            <i class="fas fa-check-circle"></i>
                            <span>éŸ³é¢‘æ–‡ä»¶å¯ç”¨: ${workingUrl}</span>
                        `;
                    }
                }
            }

            // æ–°å¢ï¼šæ™ºèƒ½éŸ³é¢‘æ–‡ä»¶æœç´¢å’ŒåŒ¹é…å‡½æ•° - ä¸å¬åŠ›ç•Œé¢å®Œå…¨ä¸€è‡´
            async findAudioFile(paperInfo) {
                const { year, month, exam_type, paper_number = 1, title } = paperInfo;
                
                console.log(`ğŸ” è€ƒè¯•ç•Œé¢å¼€å§‹æœç´¢éŸ³é¢‘æ–‡ä»¶: ${exam_type} ${year}å¹´${month}æœˆ è¯•å·${paper_number}`);
                
                // æ ¹æ®è¯•å·ç±»å‹ç¡®å®šä¸»è¦æœç´¢ç±»å‹å’Œæ¬¡è¦æœç´¢ç±»å‹
                const isPrimaryCET4 = exam_type.toLowerCase().includes('cet4') || exam_type === 'CET-4';
                const primaryType = isPrimaryCET4 ? 'cet4' : 'cet6';
                const secondaryType = isPrimaryCET4 ? 'cet6' : 'cet4';
                
                const monthStr = month.toString().padStart(2, '0');
                
                // ç”Ÿæˆå¯èƒ½çš„éŸ³é¢‘æ–‡ä»¶åæ¨¡å¼ - åŒæ—¶åŒ…å«ä¸»è¦ç±»å‹å’Œæ¬¡è¦ç±»å‹
                const possibleFilenames = [
                    // ä¸»è¦ç±»å‹æ–‡ä»¶åï¼ˆä¼˜å…ˆï¼‰
                    `${primaryType}_${year}_${monthStr}_${paper_number}.mp3`,
                    `${primaryType}_${year}_${month}_${paper_number}.mp3`,
                    `${primaryType}_${year}_${monthStr}.mp3`,
                    `${primaryType}_${year}_${month}.mp3`,
                    `${primaryType}_${year}${monthStr}_${paper_number}.mp3`,
                    `${primaryType}_${year}${month}_${paper_number}.mp3`,
                    
                    // æ¬¡è¦ç±»å‹æ–‡ä»¶åï¼ˆå¤‡ç”¨ï¼‰
                    `${secondaryType}_${year}_${monthStr}_${paper_number}.mp3`,
                    `${secondaryType}_${year}_${month}_${paper_number}.mp3`,
                    `${secondaryType}_${year}_${monthStr}.mp3`,
                    `${secondaryType}_${year}_${month}.mp3`,
                    `${secondaryType}_${year}${monthStr}_${paper_number}.mp3`,
                    `${secondaryType}_${year}${month}_${paper_number}.mp3`,
                    
                    // é€šç”¨æ ¼å¼
                    `${year}_${monthStr}_${paper_number}.mp3`,
                    `${year}_${month}_${paper_number}.mp3`,
                    `${year}${monthStr}_${paper_number}.mp3`,
                    `${year}${month}_${paper_number}.mp3`
                ];
                
                let bestMatch = null;
                let matchScore = 0;
                
                // åœ¨æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶åä¸­æœç´¢æ–‡ä»¶ï¼Œè®¡ç®—åŒ¹é…åˆ†æ•°
                for (const filename of possibleFilenames) {
                    try {
                        const response = await fetch(`/api/listening/check-audio-file?filename=${encodeURIComponent(filename)}`, {
                            headers: window.unifiedAuthManager.getAuthHeaders()
                        });
                        const result = await response.json();
                        
                        if (result.exists) {
                            // è®¡ç®—åŒ¹é…åˆ†æ•°
                            let score = 0;
                            
                            // æ–‡ä»¶åä¸è¯•å·ç±»å‹å®Œå…¨åŒ¹é… +10åˆ†
                            if (filename.startsWith(`${primaryType}_`)) {
                                score += 10;
                            }
                            
                            // åœ¨ä¸»è¦ç›®å½•ä¸­æ‰¾åˆ° +5åˆ†
                            if (result.folder_type.includes('å››çº§å¬åŠ›') && primaryType === 'cet4') {
                                score += 5;
                            } else if (result.folder_type.includes('å…­çº§å¬åŠ›') && primaryType === 'cet6') {
                                score += 5;
                            }
                            
                            // åŒ…å«å®Œæ•´å¹´æœˆæ—¥ä¿¡æ¯ +3åˆ†
                            if (filename.includes(`${year}_${monthStr}_${paper_number}`)) {
                                score += 3;
                            } else if (filename.includes(`${year}_${month}_${paper_number}`)) {
                                score += 2;
                            } else if (filename.includes(`${year}_${monthStr}`)) {
                                score += 1;
                            }
                            
                            console.log(`   ğŸ“Š åŒ¹é…æ–‡ä»¶: ${filename}, è·¯å¾„: ${result.folder_type}, åˆ†æ•°: ${score}`);
                            
                            // æ›´æ–°æœ€ä½³åŒ¹é…
                            if (!bestMatch || score > matchScore) {
                                bestMatch = {
                                    exists: true,
                                    filename: filename,
                                    filePath: result.path,
                                    searchPath: result.folder_type,
                                    matchScore: score,
                                    matchType: filename.startsWith(`${primaryType}_`) ? 'primary' : 'secondary',
                                    webPath: result.web_url
                                };
                                matchScore = score;
                            }
                        }
                    } catch (error) {
                        console.warn(`æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶å¤±è´¥: ${filename}`, error);
                    }
                }
                
                if (bestMatch) {
                    console.log(`âœ… æ‰¾åˆ°æœ€ä½³éŸ³é¢‘æ–‡ä»¶: ${bestMatch.filename}`);
                    console.log(`   è·¯å¾„: ${bestMatch.filePath}`);
                    console.log(`   åŒ¹é…åˆ†æ•°: ${bestMatch.matchScore}`);
                    console.log(`   åŒ¹é…ç±»å‹: ${bestMatch.matchType}`);
                    console.log(`   Webè·¯å¾„: ${bestMatch.webPath}`);
                    
                    return bestMatch;
                }
                
                console.log(`âŒ æœªæ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶ï¼Œè¯•å·: ${exam_type} ${year}å¹´${month}æœˆ`);
                console.log(`   æœç´¢æ¨¡å¼: ${possibleFilenames.slice(0, 3).join(', ')}...`);
                
                return {
                    exists: false,
                    filename: possibleFilenames[0],
                    possibleFilenames: possibleFilenames
                };
            }

            // æ–°å¢ï¼šç”ŸæˆéŸ³é¢‘æ–‡ä»¶å
            generateAudioFilename(paper) {
                if (!paper || !paper.exam_type || !paper.year || !paper.month) {
                    return null;
                }
                
                const examType = paper.exam_type.toLowerCase().includes('cet4') ? 'cet4' : 'cet6';
                const monthStr = paper.month.toString().padStart(2, '0');
                
                // ç”Ÿæˆæœ€å¯èƒ½çš„æ–‡ä»¶åæ ¼å¼
                return `${examType}_${paper.year}_${monthStr}_1.mp3`;
            }

            // ä¿®æ”¹ï¼šæ¸²æŸ“éŸ³é¢‘æ’­æ”¾å™¨ - å¢å¼ºè°ƒè¯•ä¿¡æ¯
            renderAudioPlayer(audioInfo, actualAudioUrl, allUrls) {
                return `
                    <div class="audio-player-header">
                        <div class="audio-player-title">å¬åŠ›éŸ³é¢‘</div>
                        <div class="audio-player-filename">${audioInfo.filename}</div>
                    </div>
                    
                    <div class="audio-debug-info mb-3 p-3 bg-blue-50 rounded-lg text-sm">
                        <div class="font-semibold text-blue-800 mb-1">éŸ³é¢‘åŒ¹é…ä¿¡æ¯ï¼š</div>
                        <div class="grid grid-cols-2 gap-1 text-xs">
                            <div>åŒ¹é…åˆ†æ•°: <span class="font-mono">${audioInfo.matchScore}</span></div>
                            <div>åŒ¹é…ç±»å‹: <span class="font-mono">${audioInfo.matchType}</span></div>
                            <div>æ–‡ä»¶è·¯å¾„: <span class="font-mono">${audioInfo.filePath}</span></div>
                            <div>æœç´¢ç›®å½•: <span class="font-mono">${audioInfo.searchPath}</span></div>
                        </div>
                    </div>
                    
                    <div class="audio-debug-info mb-2 p-2 bg-green-50 rounded text-xs">
                        <strong>å½“å‰ä½¿ç”¨URL:</strong> ${actualAudioUrl}<br>
                        <strong>å¤‡ç”¨URL:</strong> ${allUrls.slice(1, 3).join(', ')}${allUrls.length > 3 ? '...' : ''}
                    </div>
                    
                    <audio id="exam-listening-audio" controls class="w-full" preload="metadata">
                        <source src="${actualAudioUrl}" type="audio/mpeg">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                    </audio>
                    
                    <div class="progress-container">
                        <div class="progress-bar" id="exam-audio-progress"></div>
                    </div>
                    
                    <div class="audio-controls">
                        <button id="play-exam-audio" class="play-btn">
                            <i class="fas fa-play mr-2"></i>æ’­æ”¾
                        </button>
                        <button id="pause-exam-audio" class="pause-btn">
                            <i class="fas fa-pause mr-2"></i>æš‚åœ
                        </button>
                        <button id="replay-exam-audio" class="replay-btn">
                            <i class="fas fa-redo mr-2"></i>é‡æ’­
                        </button>
                        <button onclick="examManager.testAllAudioUrls()" class="bg-purple-500 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-vial mr-1"></i>æµ‹è¯•URL
                        </button>
                    </div>
                    
                    <div class="audio-status mt-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span>å‡†å¤‡æ’­æ”¾éŸ³é¢‘ - ä½¿ç”¨: ${new URL(actualAudioUrl, window.location.origin).pathname}</span>
                    </div>
                `;
            }

            // ä¿®æ”¹ï¼šè®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨æ§åˆ¶ - å¢å¼ºé”™è¯¯å¤„ç†
            setupAudioPlayerControls(audioInfo, actualAudioUrl) {
                audioPlayerState.audioPlayer = document.getElementById('exam-listening-audio');
                audioPlayerState.audioProgressBar = document.getElementById('exam-audio-progress');
                
                if (!audioPlayerState.audioPlayer) {
                    console.error('éŸ³é¢‘æ’­æ”¾å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                // æ·»åŠ é”™è¯¯äº‹ä»¶ç›‘å¬
                audioPlayerState.audioPlayer.addEventListener('error', (e) => {
                    console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                    const error = audioPlayerState.audioPlayer.error;
                    console.error('éŸ³é¢‘é”™è¯¯è¯¦æƒ…:', {
                        code: error.code,
                        message: error.message
                    });
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const statusElement = document.querySelector('.audio-status');
                    if (statusElement) {
                        statusElement.className = 'audio-status error';
                        statusElement.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>éŸ³é¢‘åŠ è½½å¤±è´¥: ${this.getAudioErrorText(error.code)}</span>
                        `;
                    }
                    
                    // è‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªURL
                    this.tryNextAudioUrl(audioInfo, actualAudioUrl);
                });
                
                // åŸæœ‰çš„æ—¶é—´æ›´æ–°å’Œæ§ä»¶ç»‘å®šä¿æŒä¸å˜
                audioPlayerState.audioPlayer.addEventListener('timeupdate', () => {
                    if (audioPlayerState.audioPlayer.duration) {
                        const percent = (audioPlayerState.audioPlayer.currentTime / audioPlayerState.audioPlayer.duration) * 100;
                        if (audioPlayerState.audioProgressBar) {
                            audioPlayerState.audioProgressBar.style.width = percent + '%';
                        }
                    }
                });
                
                // ç»‘å®šéŸ³é¢‘æ§åˆ¶äº‹ä»¶
                const playBtn = document.getElementById('play-exam-audio');
                const pauseBtn = document.getElementById('pause-exam-audio');
                const replayBtn = document.getElementById('replay-exam-audio');
                
                if (playBtn) {
                    playBtn.addEventListener('click', () => {
                        audioPlayerState.audioPlayer.play().catch(e => {
                            console.error('æ’­æ”¾å¤±è´¥:', e);
                            this.showMessage('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„', 'error');
                        });
                        audioPlayerState.isPlaying = true;
                    });
                }
                
                if (pauseBtn) {
                    pauseBtn.addEventListener('click', () => {
                        audioPlayerState.audioPlayer.pause();
                        audioPlayerState.isPlaying = false;
                    });
                }
                
                if (replayBtn) {
                    replayBtn.addEventListener('click', () => {
                        audioPlayerState.audioPlayer.currentTime = 0;
                        audioPlayerState.audioPlayer.play();
                        audioPlayerState.isPlaying = true;
                    });
                }

                // éŸ³é¢‘ç»“æŸäº‹ä»¶
                audioPlayerState.audioPlayer.addEventListener('ended', () => {
                    audioPlayerState.isPlaying = false;
                });
                
                console.log('âœ… è€ƒè¯•éŸ³é¢‘æ’­æ”¾å™¨è®¾ç½®å®Œæˆ');
            }

            // æ–°å¢ï¼šè·å–éŸ³é¢‘é”™è¯¯æ–‡æœ¬
            getAudioErrorText(errorCode) {
                const errorMap = {
                    1: 'MEDIA_ERR_ABORTED - ç”¨æˆ·å–æ¶ˆ',
                    2: 'MEDIA_ERR_NETWORK - ç½‘ç»œé”™è¯¯',
                    3: 'MEDIA_ERR_DECODE - è§£ç é”™è¯¯', 
                    4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - æ ¼å¼ä¸æ”¯æŒ'
                };
                return errorMap[errorCode] || `æœªçŸ¥é”™è¯¯ (${errorCode})`;
            }

            // æ–°å¢ï¼šå°è¯•ä¸‹ä¸€ä¸ªéŸ³é¢‘URL
            async tryNextAudioUrl(audioInfo, currentUrl) {
                const urls = this.generateAudioUrls(audioInfo);
                const currentIndex = urls.indexOf(currentUrl);
                
                if (currentIndex < urls.length - 1) {
                    const nextUrl = urls[currentIndex + 1];
                    console.log(`ğŸ”„ è‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªURL: ${nextUrl}`);
                    this.updateAudioSource(nextUrl);
                }
            }

            // ä¿®æ”¹ï¼šæ¸²æŸ“éŸ³é¢‘é”™è¯¯ä¿¡æ¯ - å¢å¼ºè°ƒè¯•ä¿¡æ¯
            renderAudioError(filename) {
                return `
                    <div class="audio-player-header">
                        <div class="audio-player-title">å¬åŠ›éŸ³é¢‘</div>
                        <div class="audio-player-filename">${filename}</div>
                    </div>
                    
                    <div class="audio-help-info">
                        <h5>éŸ³é¢‘æ–‡ä»¶æœªæ‰¾åˆ°</h5>
                        <p>
                            ç³»ç»Ÿæ­£åœ¨æŸ¥æ‰¾æ–‡ä»¶: <code>${filename}</code>
                        </p>
                        <p>
                            è¯·ç¡®ä¿éŸ³é¢‘æ–‡ä»¶å·²æ”¾ç½®åœ¨æ­£ç¡®çš„ç›®å½•ä¸­ï¼š
                        </p>
                        <ul class="text-sm mt-2 space-y-1">
                            <li><code>çœŸé¢˜ä¸å¬åŠ›/å››çº§å¬åŠ›/</code> - å››çº§å¬åŠ›éŸ³é¢‘</li>
                            <li><code>çœŸé¢˜ä¸å¬åŠ›/å…­çº§å¬åŠ›/</code> - å…­çº§å¬åŠ›éŸ³é¢‘</li>
                            <li><code>çœŸé¢˜ä¸å¬åŠ›/å››çº§å¬åŠ›çœŸé¢˜/</code> - å››çº§å¬åŠ›çœŸé¢˜éŸ³é¢‘</li>
                            <li><code>çœŸé¢˜ä¸å¬åŠ›/å…­çº§å¬åŠ›çœŸé¢˜/</code> - å…­çº§å¬åŠ›çœŸé¢˜éŸ³é¢‘</li>
                        </ul>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <h6 class="font-semibold text-blue-800 mb-2">è°ƒè¯•ä¿¡æ¯ï¼š</h6>
                            <div class="text-xs text-blue-700 space-y-1">
                                <div>å½“å‰è¯•å·: ${currentExam?.title}</div>
                                <div>è¯•å·ç±»å‹: ${currentExam?.exam_type}</div>
                                <div>å¹´ä»½: ${currentExam?.year}å¹´${currentExam?.month}æœˆ</div>
                                <div>é¢„æœŸæ–‡ä»¶å: ${filename}</div>
                            </div>
                        </div>
                        
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button onclick="examManager.rescanExamAudio()" class="text-sm bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>é‡æ–°æ‰«æéŸ³é¢‘
                            </button>
                            <button onclick="examManager.testAudioManually()" class="text-sm bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition-colors">
                                <i class="fas fa-wrench mr-1"></i>æ‰‹åŠ¨æµ‹è¯•éŸ³é¢‘
                            </button>
                            <button onclick="examManager.hideAudioPlayer()" class="text-sm bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600 transition-colors">
                                <i class="fas fa-eye-slash mr-1"></i>éšè—éŸ³é¢‘é¢æ¿
                            </button>
                        </div>
                    </div>
                `;
            }

            // æ–°å¢ï¼šæ‰‹åŠ¨æµ‹è¯•éŸ³é¢‘
            async testAudioManually() {
                const audioInfo = await this.findAudioFile(currentExam);
                if (!audioInfo) return;
                
                const urls = this.generateAudioUrls(audioInfo);
                await this.testAudioUrls(urls, audioInfo.filename);
            }

            // æ–°å¢ï¼šé‡æ–°æ‰«æè€ƒè¯•éŸ³é¢‘ - ä¸å¬åŠ›ç•Œé¢å®Œå…¨ä¸€è‡´
            async rescanExamAudio() {
                try {
                    this.showMessage('æ­£åœ¨é‡æ–°æ‰«æéŸ³é¢‘æ–‡ä»¶...', 'info');
                    
                    const response = await fetch('/api/listening/rescan-audio', {
                        method: 'POST',
                        headers: window.unifiedAuthManager.getAuthHeaders()
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showMessage(`æ‰«æå®Œæˆ: ${result.data.matched_papers}/${result.data.total_papers} å¥—è¯•å·åŒ¹é…æˆåŠŸ`, 'success');
                        // é‡æ–°è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
                        await this.setupExamAudioPlayer();
                    } else {
                        this.showMessage('é‡æ–°æ‰«æå¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('é‡æ–°æ‰«æéŸ³é¢‘å¤±è´¥:', error);
                    this.showMessage('é‡æ–°æ‰«æå¤±è´¥', 'error');
                }
            }

            // æ–°å¢ï¼šéšè—éŸ³é¢‘æ’­æ”¾å™¨
            hideAudioPlayer() {
                const audioContainer = document.getElementById('exam-audio-player-container');
                if (audioContainer) {
                    audioContainer.classList.add('hidden');
                }
            }

            // æ–°å¢ï¼šæµ‹è¯•æ‰€æœ‰éŸ³é¢‘URLçš„æ–¹æ³•
            async testAllAudioUrls() {
                const audioInfo = await this.findAudioFile(currentExam);
                if (!audioInfo) return;
                
                const urls = this.generateAudioUrls(audioInfo);
                await this.testAudioUrls(urls, audioInfo.filename);
            }

            // ä¿®å¤ï¼šæ¸²æŸ“å½“å‰éƒ¨åˆ† - æ”¹è¿›é¢˜ç›®æ•°æ®æ£€æŸ¥
            renderCurrentSection() {
                if (!examState.currentSectionData) {
                    console.error('âŒ å½“å‰éƒ¨åˆ†æ•°æ®ä¸ºç©º');
                    this.showNoQuestionsMessage();
                    return;
                }

                console.log('ğŸ¨ æ¸²æŸ“å½“å‰éƒ¨åˆ†æ•°æ®:', {
                    currentSection: examState.currentSectionData.currentSection,
                    currentQuestion: examState.currentSectionData.currentQuestion,
                    sections: examState.currentSectionData.sections
                });

                const currentSection = examState.currentSectionData.currentSection;
                
                // ä¿®å¤ï¼šæ£€æŸ¥é¢˜ç›®æ•°æ®çš„å¤šç§æƒ…å†µ
                let hasQuestions = false;
                let questions = [];
                
                if (currentSection && currentSection.questions && currentSection.questions.length > 0) {
                    hasQuestions = true;
                    questions = currentSection.questions;
                    console.log('âœ… ä»currentSection.questionsè·å–é¢˜ç›®:', questions.length);
                } else if (examState.currentSectionData.currentQuestion) {
                    hasQuestions = true;
                    questions = [examState.currentSectionData.currentQuestion];
                    console.log('âœ… ä»currentQuestionè·å–é¢˜ç›®');
                }
                
                if (!hasQuestions) {
                    console.warn('âš ï¸ å½“å‰éƒ¨åˆ†æ²¡æœ‰é¢˜ç›®');
                    this.showNoQuestionsMessage();
                    return;
                }

                this.renderSectionTabs();
                this.renderQuestionNavigation(questions);
                this.renderCurrentQuestion(questions);
                this.updateProgressInfo();
                
                // æ›´æ–°å½“å‰éƒ¨åˆ†ä¿¡æ¯
                document.getElementById('currentSectionName').textContent = currentSection.section_name;
                document.getElementById('currentSectionQuestionCount').textContent = questions.length;
            }

            // ä¿®å¤ï¼šé¢˜ç›®å¯¼èˆªæ¸²æŸ“ - æ¥å—é¢˜ç›®æ•°ç»„å‚æ•°
            renderQuestionNavigation(questions = []) {
                const questionNav = document.getElementById('questionNavigation');
                
                if (!questions || questions.length === 0) {
                    questionNav.innerHTML = '<div class="text-gray-500 text-sm">æš‚æ— é¢˜ç›®</div>';
                    return;
                }

                console.log('ğŸ“‹ é¢˜ç›®å¯¼èˆªæ•°æ®:', {
                    questionsCount: questions.length,
                    currentQuestionIndex: examState.currentQuestionIndex
                });

                questionNav.innerHTML = questions.map((question, index) => {
                    const isCurrent = index === examState.currentQuestionIndex;
                    const answerKey = `${examState.currentSectionIndex}-${index}`;
                    const isAnswered = examState.answers[answerKey];
                    const statusClass = isCurrent ? 'current' : isAnswered ? 'answered' : '';
                    
                    return `
                        <div class="question-number ${statusClass}" 
                             onclick="examManager.switchQuestion(${index})">
                            ${index + 1}
                        </div>
                    `;
                }).join('');

                // æ›´æ–°è¿›åº¦ä¿¡æ¯
                this.updateProgressInfo();
            }

            // ä¿®å¤ï¼šæ¸²æŸ“å½“å‰é¢˜ç›® - æ¥å—é¢˜ç›®æ•°ç»„å‚æ•°
            renderCurrentQuestion(questions = []) {
                const sectionElement = document.getElementById('currentSection');
                const questionElement = document.getElementById('questionContent');
                const currentSection = examState.currentSectionData?.currentSection;
                
                if (!currentSection) {
                    sectionElement.innerHTML = '<div class="bg-red-50 p-4 rounded-lg text-red-700">é¢˜ç›®æ•°æ®åŠ è½½å¤±è´¥</div>';
                    questionElement.innerHTML = '';
                    return;
                }

                // ä¿®å¤ï¼šå®‰å…¨è·å–å½“å‰é¢˜ç›®
                let currentQuestion = null;
                if (questions.length > 0 && examState.currentQuestionIndex < questions.length) {
                    currentQuestion = questions[examState.currentQuestionIndex];
                } else if (examState.currentSectionData.currentQuestion) {
                    currentQuestion = examState.currentSectionData.currentQuestion;
                }

                if (!currentQuestion) {
                    console.error('âŒ æ— æ³•è·å–å½“å‰é¢˜ç›®:', {
                        questionsCount: questions.length,
                        currentQuestionIndex: examState.currentQuestionIndex,
                        hasCurrentQuestion: !!examState.currentSectionData.currentQuestion
                    });
                    
                    questionElement.innerHTML = `
                        <div class="question-card fade-in">
                            <div class="text-center py-12">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">é¢˜ç›®æ•°æ®åŠ è½½å¤±è´¥</h3>
                                <p class="text-gray-600 mb-4">æ— æ³•åŠ è½½å½“å‰é¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼</p>
                                <button onclick="examManager.loadCurrentSection()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-redo mr-2"></i>é‡æ–°åŠ è½½
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                sectionElement.innerHTML = `
                    <div class="section-info">
                        <h3 class="font-semibold text-blue-800">${currentSection.section_name}</h3>
                        <p class="text-blue-600 text-sm mt-1">${currentSection.directions || ''}</p>
                    </div>
                `;

                questionElement.innerHTML = this.renderQuestionContent(currentQuestion, currentSection);
            }

            renderSectionTabs() {
                const sectionTabs = document.getElementById('sectionTabs');
                const sections = examState.currentSectionData.sections || [];

                sectionTabs.innerHTML = sections.map((section, index) => {
                    const isActive = index === examState.currentSectionIndex;
                    return `
                        <button onclick="examManager.switchSection(${index})" 
                                class="section-tab-vertical ${isActive ? 'active' : ''}">
                            <div class="flex justify-between items-center">
                                <span>${section.section_name}</span>
                                <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">${section.questions_count || 0}</span>
                            </div>
                        </button>
                    `;
                }).join('');
            }

            // å¢å¼ºçš„é¢˜ç›®å†…å®¹æ¸²æŸ“ - å®Œå…¨ä¿®å¤ç‰ˆæœ¬
            renderQuestionContent(question, sectionData = null) {
                console.log('ğŸ” æ¸²æŸ“é¢˜ç›®å†…å®¹:', { 
                    questionId: question.id, 
                    sectionType: sectionData?.section_type,
                    hasPassage: !!question.passage_content,
                    hasTranslation: !!question.translation_content,
                    hasOptions: question.options && question.options.length > 0
                });
                
                let optionsHtml = '';
                let passageHtml = '';
                let translationHtml = '';
                let writingHtml = '';
                
                // è·å–å½“å‰éƒ¨åˆ†æ•°æ®
                const currentSection = examState.currentSectionData?.currentSection;
                
                // æ ¹æ®sectionç±»å‹æ¸²æŸ“ä¸åŒçš„å†…å®¹
                const sectionType = currentSection?.section_type;
                
                console.log('ğŸ“‹ éƒ¨åˆ†æ•°æ®è¯¦æƒ…:', {
                    sectionType: sectionType,
                    sectionName: currentSection?.section_name,
                    hasSectionPassage: !!currentSection?.passage_content,
                    hasSectionTranslation: !!currentSection?.translation_content,
                    questionType: question.question_type
                });
                
                // é¦–å…ˆå¤„ç†é˜…è¯»ææ–™ï¼ˆé€‚ç”¨äºæ‰€æœ‰é˜…è¯»ç†è§£éƒ¨åˆ†ï¼‰
                if (sectionType && sectionType.includes('reading')) {
                    // ä¼˜å…ˆä½¿ç”¨éƒ¨åˆ†çš„é˜…è¯»ææ–™ï¼Œå…¶æ¬¡ä½¿ç”¨é¢˜ç›®çš„é˜…è¯»ææ–™
                    const passageContent = currentSection?.passage_content || question.passage_content;
                    if (passageContent) {
                        passageHtml = this.renderReadingPassage(passageContent, 'é˜…è¯»ææ–™');
                    }
                }
                
                // å¤„ç†ç¿»è¯‘å†…å®¹
                if (sectionType === 'translation') {
                    const translationContent = currentSection?.translation_content || question.translation_content;
                    if (translationContent) {
                        translationHtml = this.renderTranslationContent(translationContent);
                    }
                }
                
                // å¤„ç†å†™ä½œå†…å®¹
                if (sectionType === 'writing') {
                    const writingContent = currentSection?.passage_content || question.passage_content;
                    if (writingContent) {
                        writingHtml = this.renderWritingPrompt(writingContent);
                    }
                }
                
                // ç„¶åæ ¹æ®é¢˜ç›®ç±»å‹æ¸²æŸ“é€‰é¡¹
                switch(question.question_type) {
                    case 'single_choice':
                    case 'multiple_choice':
                    case 'paragraph_matching':
                    case 'blank_filling':
                        if (question.options && question.options.length > 0) {
                            optionsHtml = this.renderChoiceOptions(question, currentSection);
                        }
                        break;
                        
                    case 'translation':
                        optionsHtml = this.renderTranslationInput(question, currentSection);
                        break;
                        
                    case 'writing':
                    case 'essay':
                        optionsHtml = this.renderWritingInput(question, currentSection);
                        break;
                        
                    case 'fill_blank':
                        optionsHtml = this.renderFillBlankInput(question, currentSection);
                        break;
                        
                    default:
                        // é»˜è®¤å¤„ç†é€‰æ‹©é¢˜
                        if (question.options && question.options.length > 0) {
                            optionsHtml = this.renderChoiceOptions(question, currentSection);
                        }
                }

                // ç‰¹æ®Šå¤„ç†ï¼šå¯¹äºæ®µè½åŒ¹é…é¢˜ï¼Œç¡®ä¿æ˜¾ç¤ºé€‰é¡¹
                if (question.question_type === 'paragraph_matching' && (!question.options || question.options.length === 0)) {
                    optionsHtml = this.renderParagraphMatchingOptions(question, currentSection);
                }

                return `
                    <div class="question-card fade-in">
                        <div class="question-header">
                            <div class="question-title">
                                <h3 class="text-xl font-semibold text-gray-800">ç¬¬ ${examState.currentQuestionIndex + 1} é¢˜</h3>
                                <div class="question-meta flex items-center gap-4">
                                    <span class="question-type-badge">
                                        ${this.getQuestionTypeText(question.question_type)}
                                    </span>
                                    <span class="text-sm text-gray-500">åˆ†å€¼: ${question.score || 1} åˆ†</span>
                                </div>
                            </div>
                            ${currentSection?.directions ? `
                                <div class="directions-text mt-2 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                                    <strong>é¢˜ç›®è¦æ±‚:</strong> ${currentSection.directions}
                                </div>
                            ` : ''}
                        </div>

                        ${passageHtml}
                        ${translationHtml}
                        ${writingHtml}

                        <div class="question-text mt-4 text-lg text-gray-700 leading-relaxed">
                            ${question.question_text || 'é¢˜ç›®å†…å®¹åŠ è½½ä¸­...'}
                        </div>

                        ${optionsHtml}
                    </div>
                `;
            }

            // æ–°å¢ï¼šä¸“é—¨å¤„ç†æ®µè½åŒ¹é…é¢˜é€‰é¡¹
            renderParagraphMatchingOptions(question, sectionData) {
                // ä¸ºæ®µè½åŒ¹é…é¢˜ç”Ÿæˆé»˜è®¤é€‰é¡¹ï¼ˆAåˆ°Jï¼‰
                const defaultOptions = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
                let optionsHtml = '<div class="question-options mt-4">';
                
                defaultOptions.forEach(option => {
                    const answerKey = `${examState.currentSectionIndex}-${examState.currentQuestionIndex}`;
                    const isSelected = examState.answers[answerKey] === option;
                    
                    optionsHtml += `
                        <div class="option-item ${isSelected ? 'selected' : ''}" 
                             onclick="examManager.selectAnswer('${option}')">
                            <div class="option-letter">${option}</div>
                            <div class="option-text">æ®µè½ ${option}</div>
                        </div>
                    `;
                });
                
                optionsHtml += '</div>';
                return optionsHtml;
            }

            // ä¿®å¤ï¼šæ¸²æŸ“é˜…è¯»ææ–™çš„æ–¹æ³• - å¢å¼ºé”™è¯¯å¤„ç†
            renderReadingPassage(passageContent, title = 'é˜…è¯»ææ–™') {
                if (!passageContent || passageContent.trim() === '') {
                    return `
                        <div class="reading-passage fade-in">
                            <h4 class="text-lg font-semibold mb-3 text-blue-800">
                                <i class="fas fa-book-reader mr-2"></i>${title}
                            </h4>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-700">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                é˜…è¯»ææ–™æš‚æ—¶æ— æ³•åŠ è½½ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="reading-passage fade-in">
                        <h4 class="text-lg font-semibold mb-3 text-blue-800">
                            <i class="fas fa-book-reader mr-2"></i>${title}
                        </h4>
                        <div class="passage-text bg-white p-4 rounded-lg border border-gray-200 leading-relaxed text-gray-700 whitespace-pre-line">
                            ${passageContent}
                        </div>
                    </div>
                `;
            }

            // ä¿®å¤ï¼šæ¸²æŸ“ç¿»è¯‘å†…å®¹çš„æ–¹æ³•
            renderTranslationContent(translationContent) {
                if (!translationContent || translationContent.trim() === '') {
                    return `
                        <div class="translation-passage fade-in">
                            <h4 class="text-lg font-semibold mb-3 text-green-800">
                                <i class="fas fa-language mr-2"></i>ç¿»è¯‘åŸæ–‡
                            </h4>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-700">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                ç¿»è¯‘åŸæ–‡æš‚æ—¶æ— æ³•åŠ è½½ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="translation-passage fade-in">
                        <h4 class="text-lg font-semibold mb-3 text-green-800">
                            <i class="fas fa-language mr-2"></i>ç¿»è¯‘åŸæ–‡
                        </h4>
                        <div class="translation-text bg-white p-4 rounded-lg border border-green-200 leading-relaxed text-gray-700">
                            ${translationContent}
                        </div>
                    </div>
                `;
            }

            // æ–°å¢ï¼šæ¸²æŸ“å†™ä½œæç¤ºçš„æ–¹æ³•
            renderWritingPrompt(writingPrompt) {
                return `
                    <div class="writing-prompt fade-in">
                        <h4 class="text-lg font-semibold mb-3 text-yellow-800">
                            <i class="fas fa-edit mr-2"></i>å†™ä½œæç¤º
                        </h4>
                        <div class="prompt-text bg-white p-4 rounded-lg border border-yellow-200 leading-relaxed text-gray-700">
                            ${writingPrompt}
                        </div>
                    </div>
                `;
            }

            // æ–°å¢ï¼šæ¸²æŸ“é€‰æ‹©é¢˜é€‰é¡¹çš„æ–¹æ³• - ä¼˜åŒ–é€‰é¡¹é€‰ä¸­æ•ˆæœ
            renderChoiceOptions(question, sectionData) {
                let optionsHtml = '<div class="question-options">';
                const answerKey = `${examState.currentSectionIndex}-${examState.currentQuestionIndex}`;
                const currentAnswer = examState.answers[answerKey];
                
                question.options.forEach((option, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = currentAnswer === optionLetter;
                    
                    optionsHtml += `
                        <div class="option-item ${isSelected ? 'selected' : ''}" 
                             onclick="examManager.selectAnswer('${optionLetter}')">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-content">${option}</div>
                        </div>
                    `;
                });
                optionsHtml += '</div>';
                return optionsHtml;
            }

            // æ–°å¢ï¼šæ¸²æŸ“ç¿»è¯‘è¾“å…¥æ¡†çš„æ–¹æ³•
            renderTranslationInput(question, sectionData) {
                const currentTranslation = examState.answers[`${examState.currentSectionIndex}-${examState.currentQuestionIndex}`] || '';
                return `
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç¿»è¯‘å†…å®¹ï¼š</label>
                        <textarea class="translation-textarea" 
                                  placeholder="è¯·åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„ç¿»è¯‘..." 
                                  oninput="examManager.updateTranslationAnswer(this.value)">${currentTranslation}</textarea>
                    </div>
                `;
            }

            // æ–°å¢ï¼šæ¸²æŸ“å†™ä½œè¾“å…¥æ¡†çš„æ–¹æ³•
            renderWritingInput(question, sectionData) {
                const currentEssay = examState.answers[`${examState.currentSectionIndex}-${examState.currentQuestionIndex}`] || '';
                return `
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½œæ–‡å†…å®¹ï¼š</label>
                        <textarea class="essay-textarea" 
                                  placeholder="è¯·åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„ä½œæ–‡..." 
                                  oninput="examManager.updateEssayAnswer(this.value)">${currentEssay}</textarea>
                    </div>
                `;
            }

            // æ–°å¢ï¼šæ¸²æŸ“å¡«ç©ºé¢˜è¾“å…¥æ¡†çš„æ–¹æ³•
            renderFillBlankInput(question, sectionData) {
                const currentAnswer = examState.answers[`${examState.currentSectionIndex}-${examState.currentQuestionIndex}`] || '';
                return `
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¯·è¾“å…¥ç­”æ¡ˆï¼š</label>
                        <input type="text" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”æ¡ˆ..." 
                               value="${currentAnswer}"
                               oninput="examManager.updateTextAnswer(this.value)">
                    </div>
                `;
            }

            getQuestionTypeText(type) {
                const typeMap = {
                    'single_choice': 'å•é€‰é¢˜',
                    'multiple_choice': 'å¤šé€‰é¢˜',
                    'true_false': 'åˆ¤æ–­é¢˜',
                    'fill_blank': 'å¡«ç©ºé¢˜',
                    'translation': 'ç¿»è¯‘é¢˜',
                    'essay': 'ä½œæ–‡é¢˜',
                    'writing': 'å†™ä½œé¢˜',
                    'reading_comprehension': 'é˜…è¯»ç†è§£',
                    'paragraph_matching': 'æ®µè½åŒ¹é…'
                };
                return typeMap[type] || type;
            }

            // ç­”æ¡ˆå¤„ç† - ä¼˜åŒ–é€‰é¡¹ç‚¹å‡»æ•ˆæœ
            selectAnswer(answer) {
                const answerKey = `${examState.currentSectionIndex}-${examState.currentQuestionIndex}`;
                examState.answers[answerKey] = answer;
                this.saveAnswer(answer);
                
                // æ›´æ–°å½“å‰é¢˜ç›®é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                this.updateQuestionOptionsStyle(answer);
                
                this.renderQuestionNavigation();
                this.updateProgressInfo();
            }

            // æ–°å¢ï¼šæ›´æ–°å½“å‰é¢˜ç›®çš„é€‰é¡¹æ ·å¼
            updateQuestionOptionsStyle(selectedAnswer) {
                const optionItems = document.querySelectorAll('.option-item');
                optionItems.forEach(item => {
                    const optionLetter = item.querySelector('.option-letter').textContent;
                    if (optionLetter === selectedAnswer) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            updateTranslationAnswer(answer) {
                const answerKey = `${examState.currentSectionIndex}-${examState.currentQuestionIndex}`;
                examState.answers[answerKey] = answer;
                this.debouncedSaveAnswer(answer);
            }

            updateEssayAnswer(answer) {
                const answerKey = `${examState.currentSectionIndex}-${examState.currentQuestionIndex}`;
                examState.answers[answerKey] = answer;
                this.debouncedSaveAnswer(answer);
            }

            updateTextAnswer(answer) {
                const answerKey = `${examState.currentSectionIndex}-${examState.currentQuestionIndex}`;
                examState.answers[answerKey] = answer;
                this.debouncedSaveAnswer(answer);
            }

            debouncedSaveAnswer(answer) {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.saveAnswer(answer);
                    this.updateProgressInfo();
                }, 1000);
            }

            async saveAnswer(answer) {
                try {
                    const currentQuestion = examState.currentSectionData.currentQuestion;
                    if (!currentSession || !currentQuestion) return;
                    
                    const result = await this.makeApiRequest(`/sessions/${currentSession.id}/answer`, {
                        method: 'POST',
                        body: JSON.stringify({
                            question_id: currentQuestion.id,
                            answer: answer,
                            section_index: examState.currentSectionIndex,
                            question_index: examState.currentQuestionIndex
                        })
                    });
                    
                    if (!result.success) {
                        console.error('ä¿å­˜ç­”æ¡ˆå¤±è´¥:', result.message);
                    }
                } catch (error) {
                    console.error('ä¿å­˜ç­”æ¡ˆå¤±è´¥:', error);
                }
            }

            updateProgressInfo() {
                const answeredCount = Object.keys(examState.answers).length;
                document.getElementById('answeredCount').textContent = answeredCount;
            }

            // å¯¼èˆªæ§åˆ¶
            switchSection(sectionIndex) {
                if (sectionIndex !== examState.currentSectionIndex) {
                    // åœæ­¢å½“å‰éŸ³é¢‘æ’­æ”¾
                    if (audioPlayerState.audioPlayer && audioPlayerState.isPlaying) {
                        audioPlayerState.audioPlayer.pause();
                        audioPlayerState.isPlaying = false;
                    }
                    
                    examState.currentSectionIndex = sectionIndex;
                    examState.currentQuestionIndex = 0;
                    this.loadCurrentSection();
                }
            }

            switchQuestion(questionIndex) {
                const currentSection = examState.currentSectionData?.currentSection;
                if (!currentSection) {
                    console.error('âŒ åˆ‡æ¢é¢˜ç›®å¤±è´¥ï¼šå½“å‰éƒ¨åˆ†æ•°æ®ä¸ºç©º');
                    return;
                }

                // å®‰å…¨åœ°è·å–é¢˜ç›®æ•°ç»„
                let questions = [];
                if (examState.currentSectionData.currentSection?.questions) {
                    questions = examState.currentSectionData.currentSection.questions;
                }

                if (questionIndex >= 0 && questionIndex < questions.length) {
                    examState.currentQuestionIndex = questionIndex;
                    this.loadCurrentSection();
                } else {
                    console.error('âŒ é¢˜ç›®ç´¢å¼•è¶…å‡ºèŒƒå›´:', questionIndex, 'æ€»é¢˜ç›®æ•°:', questions.length);
                }
            }

            // prevQuestion æ–¹æ³•
            prevQuestion() {
                const currentSection = examState.currentSectionData?.currentSection;
                if (!currentSection) {
                    console.error('âŒ å½“å‰éƒ¨åˆ†æ•°æ®ä¸ºç©º');
                    return;
                }

                // å®‰å…¨åœ°è·å–é¢˜ç›®æ•°ç»„
                let questions = [];
                if (examState.currentSectionData.currentSection?.questions) {
                    questions = examState.currentSectionData.currentSection.questions;
                }

                if (questions.length > 0 && examState.currentQuestionIndex > 0) {
                    this.switchQuestion(examState.currentQuestionIndex - 1);
                }
            }

            // nextQuestion æ–¹æ³•
            nextQuestion() {
                const currentSection = examState.currentSectionData?.currentSection;
                if (!currentSection) {
                    console.error('âŒ å½“å‰éƒ¨åˆ†æ•°æ®ä¸ºç©º');
                    return;
                }

                // å®‰å…¨åœ°è·å–é¢˜ç›®æ•°ç»„
                let questions = [];
                if (examState.currentSectionData.currentSection?.questions) {
                    questions = examState.currentSectionData.currentSection.questions;
                }

                console.log('ğŸ” NextQuestionæ£€æŸ¥:', {
                    hasQuestions: currentSection.questions?.length,
                    currentIndex: examState.currentQuestionIndex,
                    totalQuestions: questions.length
                });

                if (questions.length > 0 && examState.currentQuestionIndex < questions.length - 1) {
                    this.switchQuestion(examState.currentQuestionIndex + 1);
                } else {
                    console.log('ğŸ“‹ å·²ç»æ˜¯æœ€åä¸€é“é¢˜æˆ–æ²¡æœ‰é¢˜ç›®');
                }
            }

            // è€ƒè¯•æäº¤
            async submitExam() {
                // åœæ­¢éŸ³é¢‘æ’­æ”¾
                if (audioPlayerState.audioPlayer && audioPlayerState.isPlaying) {
                    audioPlayerState.audioPlayer.pause();
                    audioPlayerState.isPlaying = false;
                }
                
                const answeredCount = Object.keys(examState.answers).length;
                const confirmMessage = answeredCount === 0 ? 
                    'æ‚¨è¿˜æ²¡æœ‰å›ç­”ä»»ä½•é¢˜ç›®ï¼Œç¡®å®šè¦æäº¤ç©ºç™½è¯•å·å—ï¼Ÿ' : 
                    `æ‚¨å·²å›ç­”äº† ${answeredCount} é¢˜ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`;

                if (!confirm(confirmMessage)) return;

                try {
                    const timeSpent = (currentExam.time_allowed * 60) - examState.timeRemaining;
                    
                    const result = await this.makeApiRequest(`/sessions/${currentSession.id}/submit`, {
                        method: 'POST',
                        body: JSON.stringify({
                            answers: examState.answers,
                            time_spent: timeSpent
                        })
                    });
                    
                    if (result.success) {
                        this.showExamResult(result.data);
                    } else {
                        throw new Error(result.message || 'æäº¤è€ƒè¯•å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æäº¤è€ƒè¯•å¤±è´¥:', error);
                    this.showMessage('æäº¤è¯•å·å¤±è´¥', 'error');
                }
            }

            showExamResult(result) {
                this.exitExam();
                this.renderExamResult(result);
            }

            renderExamResult(result) {
                const modal = document.getElementById('examResultModal');
                const title = document.getElementById('resultExamTitle');
                const content = document.getElementById('examResultContent');

                title.textContent = `${currentExam.title} - è€ƒè¯•ç»“æœ`;

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-6 rounded-lg text-center">
                                <div class="text-3xl font-bold text-blue-600">${result.total_score}</div>
                                <div class="text-sm text-blue-600">æ€»åˆ†</div>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg text-center">
                                <div class="text-3xl font-bold text-green-600">${result.correct_count}/${result.total_count}</div>
                                <div class="text-sm text-green-600">æ­£ç¡®é¢˜æ•°</div>
                            </div>
                            <div class="bg-purple-50 p-6 rounded-lg text-center">
                                <div class="text-3xl font-bold text-purple-600">${result.accuracy}%</div>
                                <div class="text-sm text-purple-600">æ­£ç¡®ç‡</div>
                            </div>
                            <div class="bg-orange-50 p-6 rounded-lg text-center">
                                <div class="text-3xl font-bold text-orange-600">${Math.floor(result.time_spent / 60)}:${(result.time_spent % 60).toString().padStart(2, '0')}</div>
                                <div class="text-sm text-orange-600">ç”¨æ—¶</div>
                            </div>
                        </div>

                        <div class="flex space-x-3 pt-4 border-t">
                            <button onclick="examManager.restartExam()" 
                                    class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                                <i class="fas fa-redo mr-2"></i>
                                é‡æ–°è€ƒè¯•
                            </button>
                            <button onclick="location.reload()" 
                                    class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                <i class="fas fa-home mr-2"></i>
                                è¿”å›é¦–é¡µ
                            </button>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
            }

            exitExam() {
                // åœæ­¢éŸ³é¢‘æ’­æ”¾
                if (audioPlayerState.audioPlayer && audioPlayerState.isPlaying) {
                    audioPlayerState.audioPlayer.pause();
                    audioPlayerState.isPlaying = false;
                }
                
                if (examState.timerInterval) {
                    clearInterval(examState.timerInterval);
                }
                document.getElementById('examInterface').classList.add('hidden');
            }

            restartExam() {
                document.getElementById('examResultModal').classList.add('hidden');
                this.startExam(currentExam.id);
            }

            bindEvents() {
                // æ¨¡æ€æ¡†äº‹ä»¶
                document.getElementById('closeExamModal')?.addEventListener('click', () => {
                    document.getElementById('examDetailModal').classList.add('hidden');
                });

                document.getElementById('closeResultModal')?.addEventListener('click', () => {
                    document.getElementById('examResultModal').classList.add('hidden');
                });

                document.getElementById('exitExam')?.addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦é€€å‡ºè€ƒè¯•å—ï¼Ÿé€€å‡ºåè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
                        this.exitExam();
                    }
                });

                document.getElementById('submitExam')?.addEventListener('click', () => {
                    this.submitExam();
                });

                document.getElementById('prevQuestion')?.addEventListener('click', () => {
                    this.prevQuestion();
                });

                document.getElementById('nextQuestion')?.addEventListener('click', () => {
                    this.nextQuestion();
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                document.getElementById('examDetailModal')?.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('examDetailModal')) {
                        document.getElementById('examDetailModal').classList.add('hidden');
                    }
                });

                document.getElementById('examResultModal')?.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('examResultModal')) {
                        document.getElementById('examResultModal').classList.add('hidden');
                    }
                });
            }

            showErrorState(title, message) {
                const container = document.getElementById('examList');
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 fade-in">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${title}</h3>
                            <p class="text-gray-600 mb-4">${message}</p>
                            <button onclick="examManager.loadExamList()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                <i class="fas fa-redo mr-2"></i>é‡è¯•
                            </button>
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºæ— é¢˜ç›®æç¤º
            showNoQuestionsMessage() {
                const questionElement = document.getElementById('questionContent');
                questionElement.innerHTML = `
                    <div class="question-card fade-in">
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">æš‚æ— é¢˜ç›®</h3>
                            <p class="text-gray-600 mb-4">å½“å‰éƒ¨åˆ†è¿˜æ²¡æœ‰é…ç½®é¢˜ç›®æ•°æ®</p>
                            <button onclick="examManager.loadCurrentSection()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-redo mr-2"></i>é‡æ–°åŠ è½½
                            </button>
                        </div>
                    </div>
                `;
                
                // æ¸…ç©ºé¢˜ç›®å¯¼èˆª
                document.getElementById('questionNavigation').innerHTML = '<div class="text-gray-500 text-sm">æš‚æ— é¢˜ç›®</div>';
            }

            // æ·»åŠ å…¨å±€è®¤è¯çŠ¶æ€å˜åŒ–å¤„ç†
            handleGlobalAuthChange(isLoggedIn, user, authState) {
                console.log('ğŸ”” è€ƒè¯•ç®¡ç†å™¨æ”¶åˆ°å…¨å±€è®¤è¯å˜åŒ–:', { isLoggedIn, user });
                
                this.isAuthenticated = isLoggedIn;
                this.currentUser = user;
                
                if (isLoggedIn) {
                    this.showAuthenticatedUI();
                    // é‡æ–°åŠ è½½æ•°æ®
                    this.loadExamList();
                } else {
                    this.showLoginRequired();
                }
            }
        }

        // æ›´æ–°åˆå§‹åŒ–ä»£ç 
        let examManager;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“ çœŸé¢˜è€ƒè¯•é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å¢å¼ºç‰ˆè€ƒè¯•ç®¡ç†å™¨');
            
            try {
                examManager = new EnhancedExamManager();
                
                // è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
                window.addEventListener('error', function(event) {
                    console.error('å…¨å±€é”™è¯¯:', event.error);
                });
                
                window.addEventListener('unhandledrejection', function(event) {
                    console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                    event.preventDefault();
                });
                
            } catch (error) {
                console.error('è€ƒè¯•ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                
                const examList = document.getElementById('examList');
                if (examList) {
                    examList.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 text-red-500"></i>
                            <h3 class="text-lg font-semibold mb-2">ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥</h3>
                            <p class="text-gray-600 mb-4">è¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ</p>
                            <button onclick="location.reload()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                <i class="fas fa-redo mr-2"></i>åˆ·æ–°é¡µé¢
                            </button>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>