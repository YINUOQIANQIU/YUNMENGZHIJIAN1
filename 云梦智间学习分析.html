<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ åˆ†æ - äº‘æ¢¦æ™ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="js/ai-learning-analysis.js"></script>
    <script src="js/test-analysis-flow.js"></script>
    <!-- å¼•å…¥è®¤è¯å’ŒUIç®¡ç†å™¨ -->
    <script src="äº‘æ¢¦æ™ºé—´ç»Ÿä¸€è®¤è¯.js"></script>
    <script src="äº‘æ¢¦æ™ºé—´UIç®¡ç†å™¨.js"></script>
    <style>
        .ability-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            border: 1px solid rgba(41, 98, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .ability-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(41, 98, 255, 0.1);
            border-color: rgba(41, 98, 255, 0.2);
        }
        .knowledge-graph {
            min-height: 400px;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .weakness-tag {
            transition: all 0.3s ease;
        }
        .weakness-tag:hover {
            transform: scale(1.05);
        }
        .timeline-item {
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #2962FF;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(41, 98, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(41, 98, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(41, 98, 255, 0); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.6s ease-out;
        }
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .ai-status-processing { border-left: 4px solid #3B82F6; }
        .ai-status-success { border-left: 4px solid #10B981; }
        .ai-status-error { border-left: 4px solid #EF4444; }
        .gradient-bg {
            background: linear-gradient(135deg, #F0F7FF 0%, #E3F2FF 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(41, 98, 255, 0.15);
        }
        .user-dropdown {
            transition: all 0.2s ease;
        }
        .user-dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        .analysis-stage {
            transition: all 0.3s ease;
        }
        .analysis-stage.completed { color: #10B981; }
        .analysis-stage.active { color: #3B82F6; font-weight: 600; }
        .analysis-stage.pending { color: #6B7280; }
        
        /* æ–°å¢æ ·å¼ä¼˜åŒ– */
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #learning-path-timeline::-webkit-scrollbar,
        #review-schedule::-webkit-scrollbar,
        #recommendations-list::-webkit-scrollbar {
            width: 4px;
        }
        #learning-path-timeline::-webkit-scrollbar-track,
        #review-schedule::-webkit-scrollbar-track,
        #recommendations-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        #learning-path-timeline::-webkit-scrollbar-thumb,
        #review-schedule::-webkit-scrollbar-thumb,
        #recommendations-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        #learning-path-timeline::-webkit-scrollbar-thumb:hover,
        #review-schedule::-webkit-scrollbar-thumb:hover,
        #recommendations-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            .ability-card {
                margin-bottom: 1rem;
            }
        }
        /* åŠ¨ç”»ä¼˜åŒ– */
        .fade-in {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* è¿›åº¦æ¡ç¾åŒ– */
        .progress-ring circle {
            transition: stroke-dashoffset 1s ease-in-out;
        }
        /* æ ‡ç­¾æ ·å¼ä¼˜åŒ– */
        .weakness-tag {
            border-left: 4px solid #EF4444;
        }
        .weakness-tag:hover {
            border-left-color: #DC2626; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  - ä½¿ç”¨ç»Ÿä¸€è®¤è¯ç³»ç»Ÿç®¡ç† -->
    <nav class="flex items-center justify-between px-6 lg:px-12 h-16 bg-white/90 backdrop-blur-md fixed top-0 left-0 right-0 z-50 border-b border-blue-50">
        <div class="flex items-center gap-8 lg:gap-16">
            <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="flex items-center gap-3">
                <span class="text-2xl font-bold tracking-tight" style="color: #2962FF;">äº‘æ¢¦æ™ºé—´</span>
            </a>
            <div class="hidden lg:flex items-center gap-8">
                <a href="äº‘æ¢¦æ™ºé—´è®¡åˆ’.html" class="text-gray-700 hover:text-primary transition-colors font-medium">å¤‡è€ƒè§„åˆ’</a>
                <a href="äº‘æ¢¦æ™ºé—´æ•™å­¦.html" class="text-gray-700 hover:text-primary transition-colors font-medium">åœ¨çº¿æ•™å­¦</a>
                <a href="äº‘æ¢¦æ™ºé—´çœŸé¢˜ç»ƒä¹ .html" class="text-gray-700 hover:text-primary transition-colors font-medium">çœŸé¢˜ç»ƒä¹ </a>
                <a href="äº‘æ¢¦æ™ºé—´ç¤¾åŒº.html" class="text-gray-700 hover:text-primary transition-colors font-medium">å­¦ä¹ ç¤¾åŒº</a>
            </div>
        </div>
        
        <!-- åŠ¨æ€ç™»å½•/ç”¨æˆ·åŒºåŸŸ - ç”±UIç®¡ç†å™¨æ§åˆ¶ -->
        <div class="flex items-center gap-4 lg:gap-6">
            <a href="äº‘æ¢¦æ™ºé—´æµ‹è¯•.html" class="flex items-center px-4 lg:px-6 py-2 bg-primary text-white rounded-button hover:bg-secondary transition-colors text-sm font-medium">
                é‡æ–°è¯„ä¼°
            </a>
            <div id="auth-section">
                <!-- è¿™é‡Œçš„å†…å®¹å°†ç”±UIç®¡ç†å™¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </nav>

    <!-- AIåˆ†æçŠ¶æ€æ˜¾ç¤º -->
    <div id="analysis-progress" class="max-w-7xl mx-auto pt-20 py-8 px-4 sm:px-6 lg:px-8">
        <div class="ability-card rounded-lg p-8 mb-8">
            <div id="analysis-status" class="text-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">AIåˆ†æè¿›è¡Œä¸­</h2>
                <p class="text-gray-600 text-lg mb-4" id="current-stage-message">æ­£åœ¨åŠ è½½æµ‹è¯•ç»“æœæ•°æ®...</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" id="progress-bar" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-500" id="progress-text">0% å®Œæˆ</p>
                
                <!-- åˆ†æé˜¶æ®µè¯¦æƒ… -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                    <div class="p-4 border rounded-lg">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-chart-network text-blue-500 mr-2"></i>
                            <span class="font-medium">èƒ½åŠ›å›¾è°±ç”Ÿæˆ</span>
                        </div>
                        <div id="ability-map-status" class="text-sm analysis-stage pending">ç­‰å¾…ä¸­...</div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
                            <span class="font-medium">è–„å¼±ç‚¹åˆ†æ</span>
                        </div>
                        <div id="weakpoints-status" class="text-sm analysis-stage pending">ç­‰å¾…ä¸­...</div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-route text-green-500 mr-2"></i>
                            <span class="font-medium">å­¦ä¹ è·¯å¾„è§„åˆ’</span>
                        </div>
                        <div id="learning-path-status" class="text-sm analysis-stage pending">ç­‰å¾…ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <div id="success-message" class="text-center hidden">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-3xl mx-auto mb-4">
                    <i class="fas fa-check"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">åˆ†æå®Œæˆï¼</h2>
                <p class="text-gray-600 mb-6">æ‚¨çš„ä¸ªæ€§åŒ–å­¦ä¹ åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ</p>
                <!-- ä¿®æ”¹è¿™é‡Œï¼šæŒ‰é’®æ–‡å­—é¢œè‰²æ”¹ä¸ºæ·±è‰²ï¼Œç¡®ä¿å¯è§ -->
                <button onclick="showAnalysisResults()" class="px-6 py-3 bg-primary text-gray-900 rounded-lg hover:bg-secondary transition-colors font-medium">
                    æŸ¥çœ‹åˆ†ææŠ¥å‘Š
                </button>
            </div>
        </div>
    </div>

    <!-- åˆ†æå†…å®¹ -->
    <div id="analysis-content" class="max-w-7xl mx-auto pt-20 py-8 px-4 sm:px-6 lg:px-8 hidden">
        <!-- é¡¶éƒ¨æ¦‚è§ˆå¡ç‰‡ - ä¼˜åŒ–å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            <!-- æ€»ä½“èƒ½åŠ›æ°´å¹³ -->
            <div class="lg:col-span-3 ability-card rounded-xl p-6 card-hover">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">æ€»ä½“èƒ½åŠ›æ°´å¹³</h3>
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-4 relative">
                        <svg class="w-full h-full progress-ring" viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="16" fill="none" stroke="#E5E7EB" stroke-width="2"/>
                            <circle cx="18" cy="18" r="16" fill="none" stroke="#2962FF" stroke-width="2" 
                                    stroke-dasharray="100" stroke-linecap="round" id="overall-score-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <p class="text-2xl font-bold text-gray-900" id="overall-score">0</p>
                            <p class="text-sm text-gray-600" id="cefr-level">CEFR Level</p>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>åŸºäºæ™ºæ™®AIåˆ†æ</p>
                        <p id="assessment-date">è¯„ä¼°æ—¥æœŸ: --</p>
                    </div>
                </div>
            </div>

            <!-- å­¦ä¹ è¿›åº¦æ¦‚è§ˆ -->
            <div class="lg:col-span-3 ability-card rounded-xl p-6 card-hover">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">å­¦ä¹ è¿›åº¦æ¦‚è§ˆ</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">è®¡åˆ’å®Œæˆåº¦</span>
                        <span class="font-semibold text-primary" id="plan-completion">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="completion-progress" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm text-gray-600">å¾…å¤ä¹ ä»»åŠ¡</span>
                        <span class="font-semibold text-orange-600" id="pending-reviews">0ä¸ª</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">å­¦ä¹ æ—¶é•¿</span>
                        <span class="font-semibold text-blue-600" id="total-study-time">0åˆ†é’Ÿ</span>
                    </div>
                </div>
            </div>

            <!-- èƒ½åŠ›åˆ†å¸ƒé›·è¾¾å›¾ -->
            <div class="lg:col-span-6 ability-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">ä¸‰ç»´èƒ½åŠ›å›¾è°±</h3>
                    <div class="flex gap-2">
                        <button onclick="toggleRadarView()" class="px-3 py-1 text-sm bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>åˆ‡æ¢è§†å›¾
                        </button>
                    </div>
                </div>
                <div id="ability-radar-chart" class="h-64"></div>
            </div>
        </div>

        <!-- AIåˆ†æå¢å¼ºåŒºåŸŸ -->
        <div id="ai-analysis-enhanced" class="hidden">
            <!-- åŠ¨æ€ç”Ÿæˆçš„AIåˆ†æè¯´æ˜ -->
        </div>

        <!-- æ ¸å¿ƒåˆ†æåŒºåŸŸ - ä¼˜åŒ–ä¸º3åˆ—å¸ƒå±€ -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
            <!-- å·¦ä¾§ï¼šè–„å¼±ç‚¹åˆ†æå’Œå»ºè®® -->
            <div class="xl:col-span-2 space-y-6">
                <!-- è–„å¼±çŸ¥è¯†ç‚¹åˆ†æ -->
                <div class="ability-card rounded-xl p-6 card-hover">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">è–„å¼±çŸ¥è¯†ç‚¹åˆ†æ</h3>
                        <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium" id="weakness-count">
                            0ä¸ªè–„å¼±ç‚¹
                        </span>
                    </div>
                    
                    <!-- çŸ¥è¯†ç‚¹æƒé‡åˆ†å¸ƒ -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-700 mb-3">èƒ½åŠ›ç»´åº¦æƒé‡åˆ†å¸ƒ</h4>
                        <div id="knowledge-weights" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <!-- åŠ¨æ€ç”ŸæˆçŸ¥è¯†ç‚¹æƒé‡ -->
                        </div>
                    </div>

                    <!-- è–„å¼±ç‚¹åˆ—è¡¨ -->
                    <div id="weak-points-analysis" class="space-y-4">
                        <div class="animate-pulse">
                            <div class="h-20 bg-gray-200 rounded-lg"></div>
                        </div>
                    </div>
                </div>

                <!-- AIå­¦ä¹ å»ºè®® -->
                <div class="ability-card rounded-xl p-6 card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">AIå­¦ä¹ å»ºè®®</h3>
                        <i class="fas fa-robot text-blue-500 text-xl"></i>
                    </div>
                    <div id="recommendations-list" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                        <div class="animate-pulse">
                            <div class="h-4 bg-gray-200 rounded mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå­¦ä¹ è·¯å¾„æ¦‚è§ˆ -->
            <div class="space-y-6">
                <!-- å­¦ä¹ è·¯å¾„æ¦‚è§ˆ -->
                <div class="ability-card rounded-xl p-6 card-hover">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">å­¦ä¹ è·¯å¾„æ¦‚è§ˆ</h3>
                        <button onclick="adjustLearningPath()" class="px-3 py-1 text-sm bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            è°ƒæ•´è®¡åˆ’
                        </button>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-gray-700">è®¡åˆ’æ—¶é•¿</span>
                            <span class="font-semibold text-primary" id="path-duration">--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-gray-700">é‡ç‚¹é¢†åŸŸ</span>
                            <span class="font-semibold text-green-600" id="focus-areas">--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                            <span class="text-gray-700">é¢„è®¡æå‡</span>
                            <span class="font-semibold text-orange-600" id="expected-improvement">--</span>
                        </div>
                    </div>

                    <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg text-white">
                        <h4 class="font-medium mb-2 flex items-center">
                            <i class="fas fa-robot mr-2"></i>
                            AIè·¯å¾„è§„åˆ’
                        </h4>
                        <p class="text-sm opacity-90" id="path-description">
                            åŸºäºæ‚¨çš„èƒ½åŠ›è¯„ä¼°ç»“æœï¼Œæ™ºæ™®AIä¸ºæ‚¨ç”Ÿæˆäº†ä¸ªæ€§åŒ–çš„å­¦ä¹ è·¯å¾„...
                        </p>
                    </div>

                    <div class="mt-6 space-y-3">
                        <a href="äº‘æ¢¦æ™ºé—´æµ‹è¯•.html" class="w-full py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-colors text-center block font-medium">
                            <i class="fas fa-redo mr-2"></i>é‡æ–°è¯„ä¼°èƒ½åŠ›
                        </a>
                        <button onclick="startLearning()" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-center block font-medium">
                            <i class="fas fa-play mr-2"></i>å¼€å§‹å­¦ä¹ 
                        </button>
                    </div>
                </div>

                <!-- å­¦ä¹ ç»Ÿè®¡ -->
                <div class="ability-card rounded-xl p-6 card-hover">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">å­¦ä¹ ç»Ÿè®¡</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="total-tasks">0</div>
                            <div class="text-sm text-gray-600">æ€»ä»»åŠ¡æ•°</div>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="completed-tasks">0</div>
                            <div class="text-sm text-gray-600">å·²å®Œæˆ</div>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="study-days">0</div>
                            <div class="text-sm text-gray-600">å­¦ä¹ å¤©æ•°</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="efficiency-score">0</div>
                            <div class="text-sm text-gray-600">æ•ˆç‡è¯„åˆ†</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†è®¡åˆ’å’Œå¤ä¹ è®¡åˆ’ - å¹¶æ’å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- è¯¦ç»†å­¦ä¹ è®¡åˆ’ -->
            <div class="ability-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">è¯¦ç»†å­¦ä¹ è®¡åˆ’</h3>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                            <i class="fas fa-calendar mr-1"></i>
                            <span id="plan-duration">4å‘¨</span>
                        </span>
                    </div>
                </div>
                <div id="learning-path-timeline" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <div class="animate-pulse">
                        <div class="h-32 bg-gray-200 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <!-- æŠ—é—å¿˜å¤ä¹ è®¡åˆ’ -->
            <div class="ability-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">æŠ—é—å¿˜å¤ä¹ è®¡åˆ’</h3>
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                        <i class="fas fa-brain mr-1"></i>
                        <span id="review-count">0ä¸ªå¤ä¹ </span>
                    </span>
                </div>
                <div id="review-schedule" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <div class="animate-pulse">
                        <div class="h-20 bg-gray-200 rounded-lg"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let analysisData = null;
        let learningPath = null;
        let currentRadarView = 'standard';

        // ä¸»åˆå§‹åŒ–å‡½æ•°
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“Š å­¦ä¹ åˆ†æé¡µé¢åˆå§‹åŒ–');
            
            // ç­‰å¾…è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
            waitForAuthSystem().then(() => {
                console.log('âœ… è®¤è¯ç³»ç»Ÿå·²å°±ç»ªï¼Œå¼€å§‹åˆ†ææµç¨‹');
                startAnalysisProcess();
            }).catch(error => {
                console.error('âŒ è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                // å³ä½¿è®¤è¯ç³»ç»Ÿå¤±è´¥ï¼Œä¹Ÿå°è¯•å¼€å§‹åˆ†ææµç¨‹
                startAnalysisProcess();
            });
        });

        // ç­‰å¾…è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–
        function waitForAuthSystem() {
            return new Promise((resolve, reject) => {
                const checkAuthSystem = () => {
                    if (window.unifiedAuthManager && window.unifiedAuthManager.isInitialized) {
                        resolve();
                    } else if (window.uiManager && window.uiManager.authManager) {
                        resolve();
                    } else {
                        setTimeout(checkAuthSystem, 100);
                    }
                };
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    reject(new Error('è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–è¶…æ—¶'));
                }, 5000);
                
                checkAuthSystem();
            });
        }

        // å¼€å§‹åˆ†ææµç¨‹
        async function startAnalysisProcess() {
            try {
                // å¤šé‡æ•°æ®æºæ¢å¤ç­–ç•¥
                analysisData = await recoverAnalysisData();
                
                if (analysisData) {
                    console.log('âœ… æˆåŠŸæ¢å¤åˆ†ææ•°æ®:', analysisData);
                    
                    // å¼€å§‹æ¨¡æ‹ŸAIåˆ†æè¿‡ç¨‹
                    startAIAnalysisSimulation();
                } else {
                    console.error('âŒ æ— æ³•æ¢å¤åˆ†ææ•°æ®');
                    showNoData();
                }
            } catch (error) {
                console.error('âŒ åˆ†ææµç¨‹åˆå§‹åŒ–å¤±è´¥:', error);
                showErrorState(error);
            }
        }

        // å¤šé‡æ•°æ®æºæ¢å¤ç­–ç•¥
        async function recoverAnalysisData() {
            console.log('ğŸ”„ å¼€å§‹æ¢å¤åˆ†ææ•°æ®...');
            
            const recoveryStrategies = [
                recoverFromEnhancedURL,      // æ–°å¢ï¼šå¢å¼ºURLæ¢å¤
                recoverFromMultipleStorage,  // æ–°å¢ï¼šå¤šé‡å­˜å‚¨æ¢å¤  
                recoverFromURLParams,
                recoverFromLocalStorage,
                recoverFromSessionStorage,
                recoverFromForceTransfer,
                generateFallbackData
            ];
            
            for (let i = 0; i < recoveryStrategies.length; i++) {
                try {
                    console.log(`ğŸ”„ å°è¯•æ•°æ®æº ${i + 1}: ${recoveryStrategies[i].name}`);
                    const data = await recoveryStrategies[i]();
                    
                    if (data && data.assessment) {
                        console.log(`âœ… ä» ${recoveryStrategies[i].name} æˆåŠŸæ¢å¤æ•°æ®`);
                        // éªŒè¯æ•°æ®å®Œæ•´æ€§
                        if (validateAnalysisData(data)) {
                            return data;
                        } else {
                            console.warn('âŒ æ•°æ®éªŒè¯å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç­–ç•¥');
                        }
                    }
                } catch (error) {
                    console.warn(`âŒ æ•°æ®æº ${i + 1} å¤±è´¥:`, error);
                }
            }
            
            console.error('âŒ æ‰€æœ‰æ•°æ®æ¢å¤ç­–ç•¥éƒ½å¤±è´¥äº†');
            return null;
        }

        // æ–°å¢ï¼šå¢å¼ºURLæ¢å¤ç­–ç•¥
        async function recoverFromEnhancedURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const enhanced = urlParams.get('enhanced');
            const fresh = urlParams.get('fresh');
            
            if (enhanced === 'true' || fresh === 'true') {
                console.log('ğŸ†• æ£€æµ‹åˆ°å¢å¼ºåˆ†æç»“æœ');
                
                // å°è¯•å¤šä¸ªå­˜å‚¨ä½ç½®
                const storageKeys = [
                    'current_ai_analysis',
                    'FORCE_ANALYSIS_DATA',
                    'last_ai_analysis', 
                    'analysis_report_data'
                ];
                
                for (const key of storageKeys) {
                    const data = getLocalStorageData(key);
                    if (data && validateAnalysisData(data)) {
                        console.log(`âœ… ä» ${key} æ¢å¤å¢å¼ºæ•°æ®`);
                        
                        // æ¸…ç†ä¸´æ—¶æ•°æ®
                        sessionStorage.removeItem('temp_analysis_data');
                        sessionStorage.removeItem('backup_analysis_data');
                        
                        return data;
                    }
                }
            }
            return null;
        }
        recoverFromEnhancedURL.name = 'å¢å¼ºURL';

        // æ–°å¢ï¼šå¤šé‡å­˜å‚¨æ¢å¤ç­–ç•¥
        async function recoverFromMultipleStorage() {
            console.log('ğŸ” æ‰§è¡Œå¤šé‡å­˜å‚¨æ¢å¤...');
            
            // å°è¯•æ‰€æœ‰å¯èƒ½çš„å­˜å‚¨ä½ç½®
            const storageLocations = [
                { type: 'localStorage', keys: ['current_ai_analysis', 'FORCE_ANALYSIS_DATA', 'last_ai_analysis', 'analysis_report_data'] },
                { type: 'sessionStorage', keys: ['temp_analysis_data', 'backup_analysis_data'] }
            ];
            
            for (const location of storageLocations) {
                for (const key of location.keys) {
                    let data;
                    if (location.type === 'localStorage') {
                        data = getLocalStorageData(key);
                    } else {
                        data = getSessionStorageData(key);
                    }
                    
                    if (data && validateAnalysisData(data)) {
                        console.log(`âœ… ä» ${location.type}.${key} æ¢å¤æ•°æ®`);
                        return data;
                    }
                }
            }
            
            return null;
        }
        recoverFromMultipleStorage.name = 'å¤šé‡å­˜å‚¨';

        // æ–°å¢ï¼šæ•°æ®éªŒè¯å‡½æ•°
        function validateAnalysisData(data) {
            if (!data) return false;
            
            const requiredFields = ['assessment', 'abilityAnalysis'];
            const hasRequiredFields = requiredFields.every(field => data[field]);
            
            if (!hasRequiredFields) {
                console.warn('âŒ æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µ:', requiredFields.filter(field => !data[field]));
                return false;
            }
            
            // éªŒè¯assessmentç»“æ„
            if (!data.assessment.overallScore && !data.assessment.overall_score) {
                console.warn('âŒ assessmentæ•°æ®ä¸å®Œæ•´');
                return false;
            }
            
            console.log('âœ… æ•°æ®éªŒè¯é€šè¿‡');
            return true;
        }

        // ä»URLå‚æ•°æ¢å¤æ•°æ®
        async function recoverFromURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const analysisId = urlParams.get('analysis_id');
            const fresh = urlParams.get('fresh');
            const fallback = urlParams.get('fallback');
            
            if (fresh === 'true') {
                console.log('ğŸ†• æ£€æµ‹åˆ°æ–°åˆ†æç»“æœ');
                const data = getLocalStorageData('current_ai_analysis');
                if (data) {
                    // æ¸…ç†ä¸´æ—¶æ•°æ®
                    sessionStorage.removeItem('temp_analysis_data');
                    return data;
                }
            }
            
            if (fallback === 'true') {
                console.log('ğŸ”„ ä½¿ç”¨é™çº§æ¨¡å¼');
                return getLocalStorageData('current_ai_analysis');
            }
            
            if (analysisId) {
                // æ–°æµç¨‹ï¼šä»æœ¬åœ°å­˜å‚¨è·å–å®Œæ•´æ•°æ®
                const localData = localStorage.getItem('current_ai_analysis');
                if (localData) {
                    try {
                        return JSON.parse(localData);
                    } catch (e) {
                        console.warn('è§£ææœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥');
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰ç‰¹å®šå‚æ•°ï¼Œå°è¯•ä»URLå‚æ•°ç”Ÿæˆæ•°æ®
            const overallScore = parseInt(urlParams.get('overall_score'));
            if (overallScore) {
                return generateDataFromURLParams(urlParams);
            }
            
            return null;
        }
        recoverFromURLParams.name = 'URLå‚æ•°';

        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ•°æ®
        async function recoverFromLocalStorage() {
            const keys = ['current_ai_analysis', 'analysis_report', 'last_ai_analysis', 'FORCE_ANALYSIS_DATA'];
            
            for (const key of keys) {
                const data = getLocalStorageData(key);
                if (data) {
                    console.log(`âœ… ä» localStorage.${key} æ¢å¤æ•°æ®`);
                    return data;
                }
            }
            return null;
        }
        recoverFromLocalStorage.name = 'æœ¬åœ°å­˜å‚¨';

        // ä»ä¼šè¯å­˜å‚¨æ¢å¤æ•°æ®
        async function recoverFromSessionStorage() {
            const data = getSessionStorageData('temp_analysis_data');
            if (data) {
                console.log('âœ… ä» sessionStorage æ¢å¤ä¸´æ—¶æ•°æ®');
                return data;
            }
            return null;
        }
        recoverFromSessionStorage.name = 'ä¼šè¯å­˜å‚¨';

        // å¼ºåˆ¶æ•°æ®ä¼ è¾“æ¢å¤
        async function recoverFromForceTransfer() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('force_transfer') === 'true') {
                console.log('ğŸ”§ ä½¿ç”¨å¼ºåˆ¶æ•°æ®æ¢å¤');
                
                // å°è¯•å¤šä¸ªæ•°æ®æº
                const data = 
                    getLocalStorageData('FORCE_ANALYSIS_DATA') ||
                    getLocalStorageData('current_ai_analysis') ||
                    generateDataFromURLParams(urlParams);
                    
                if (data) {
                    console.log('âœ… å¼ºåˆ¶æ•°æ®æ¢å¤æˆåŠŸ');
                    return data;
                }
            }
            return null;
        }
        recoverFromForceTransfer.name = 'å¼ºåˆ¶ä¼ è¾“';

        // é™çº§æ•°æ®ç”Ÿæˆ
        function generateFallbackData() {
            console.log('ğŸ”„ ä½¿ç”¨é™çº§æ•°æ®');
            return {
                metadata: {
                    timestamp: new Date().toISOString(),
                    examType: 'CET4',
                    generatedBy: 'fallback_system',
                    dataVersion: '1.0'
                },
                assessment: {
                    overallScore: 75,
                    level: 'B1',
                    examType: 'CET4',
                    testDate: new Date().toISOString()
                },
                abilityAnalysis: {
                    overallScore: 75,
                    level: 'B1',
                    abilityMap: {
                        dataPoints: [
                            { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: 75, weight: 0.25 },
                            { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: 68, weight: 0.25 },
                            { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: 82, weight: 0.25 },
                            { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: 71, weight: 0.25 }
                        ]
                    },
                    weakPoints: [
                        {
                            dimension: 'grammar',
                            displayName: 'è¯­æ³•èƒ½åŠ›',
                            score: 68,
                            priority: 'medium',
                            knowledgeGaps: ['æ—¶æ€è¯­æ€', 'ä»å¥ç»“æ„'],
                            recommendedActions: ['è¯­æ³•ä¸“é¡¹ç»ƒä¹ ', 'å¥å­æ”¹é”™è®­ç»ƒ']
                        }
                    ]
                },
                recommendations: [
                    {
                        message: 'ç³»ç»Ÿæ­£åœ¨ä¼˜åŒ–åˆ†ææµç¨‹ï¼Œå½“å‰æ˜¾ç¤ºåŸºç¡€åˆ†æç»“æœ',
                        actions: ['é‡æ–°æµ‹è¯•è·å–å®Œæ•´åˆ†æ', 'è”ç³»æŠ€æœ¯æ”¯æŒ'],
                        priority: 'medium'
                    }
                ],
                detailedLearningPlan: {
                    totalTasks: 56,
                    completedTasks: 12,
                    duration: "4å‘¨",
                    weeklyPlans: [
                        {
                            week: 1,
                            focus: 'åŸºç¡€å·©å›º',
                            focusAreas: ['è¯­æ³•', 'è¯æ±‡'],
                            dailyTasks: Array.from({ length: 7 }, (_, i) => ({
                                day: i + 1,
                                completed: i < 3, // å‰3å¤©å·²å®Œæˆ
                                tasks: [
                                    { type: 'grammar', duration: 30, content: 'è¯­æ³•ä¸“é¡¹ç»ƒä¹ ' },
                                    { type: 'vocabulary', duration: 25, content: 'è¯æ±‡è®°å¿†è®­ç»ƒ' }
                                ]
                            })),
                            weeklyGoals: ['æŒæ¡åŸºç¡€è¯­æ³•', 'ç§¯ç´¯æ ¸å¿ƒè¯æ±‡']
                        },
                        {
                            week: 2,
                            focus: 'èƒ½åŠ›æå‡',
                            focusAreas: ['é˜…è¯»', 'å¬åŠ›'],
                            dailyTasks: Array.from({ length: 7 }, (_, i) => ({
                                day: i + 1,
                                completed: false,
                                tasks: [
                                    { type: 'reading', duration: 40, content: 'é˜…è¯»ç†è§£è®­ç»ƒ' },
                                    { type: 'listening', duration: 35, content: 'å¬åŠ›ç†è§£ç»ƒä¹ ' }
                                ]
                            })),
                            weeklyGoals: ['æå‡é˜…è¯»é€Ÿåº¦', 'åŠ å¼ºå¬åŠ›ç†è§£']
                        }
                    ]
                },
                reviewPlan: {
                    totalReviews: 12,
                    completedReviews: 3,
                    schedule: [
                        {
                            id: 'review-1',
                            knowledgePoint: 'æ—¶æ€è¯­æ€',
                            reviewType: 'è®°å¿†å¼ºåŒ–',
                            dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                            status: 'pending',
                            estimatedTime: 20,
                            materials: ['è¯­æ³•æ‰‹å†Œ', 'ç»ƒä¹ å†ŒP45']
                        },
                        {
                            id: 'review-2',
                            knowledgePoint: 'ä»å¥ç»“æ„',
                            reviewType: 'åº”ç”¨ç»ƒä¹ ',
                            dueDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                            status: 'pending',
                            estimatedTime: 25,
                            materials: ['è¯­æ³•æ‰‹å†Œ', 'ç»ƒä¹ å†ŒP78']
                        },
                        {
                            id: 'review-3',
                            knowledgePoint: 'åŸºç¡€è¯æ±‡',
                            reviewType: 'è®°å¿†æµ‹è¯•',
                            dueDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                            status: 'completed',
                            estimatedTime: 15,
                            materials: ['è¯æ±‡æ‰‹å†Œ', 'å•è¯å¡']
                        }
                    ]
                }
            };
        }
        generateFallbackData.name = 'é™çº§æ•°æ®';

        // å·¥å…·å‡½æ•°
        function getLocalStorageData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.warn(`è§£æ localStorage.${key} å¤±è´¥:`, e);
                return null;
            }
        }

        function getSessionStorageData(key) {
            try {
                const data = sessionStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.warn(`è§£æ sessionStorage.${key} å¤±è´¥:`, e);
                return null;
            }
        }

        // ä»URLå‚æ•°ç”Ÿæˆæ•°æ®
        function generateDataFromURLParams(urlParams) {
            const overallScore = parseInt(urlParams.get('overall_score')) || 75;
            const examType = urlParams.get('exam_type') || 'CET4';
            
            return {
                assessment: {
                    overallScore: overallScore,
                    level: getCEFRLevel(overallScore),
                    examType: examType,
                    testDate: new Date().toISOString()
                },
                abilityMap: {
                    dataPoints: [
                        { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: overallScore - 5 },
                        { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: overallScore - 10 },
                        { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: overallScore + 5 },
                        { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: overallScore - 8 }
                    ]
                },
                weakPoints: [
                    {
                        dimension: 'grammar',
                        displayName: 'è¯­æ³•èƒ½åŠ›',
                        score: overallScore - 10,
                        priority: 'medium',
                        recommendedActions: ['è¯­æ³•ä¸“é¡¹ç»ƒä¹ ', 'å¥å­ç»“æ„åˆ†æ']
                    }
                ]
            };
        }

        // AIåˆ†ææ¨¡æ‹Ÿ
        function startAIAnalysisSimulation() {
            const stages = [
                { id: 'data_loading', name: 'æ•°æ®åŠ è½½', message: 'æ­£åœ¨åŠ è½½æµ‹è¯•ç»“æœæ•°æ®...' },
                { id: 'score_calculation', name: 'åˆ†æ•°è®¡ç®—', message: 'æ­£åœ¨è®¡ç®—å„ç»´åº¦å¾—åˆ†...' },
                { id: 'ability_mapping', name: 'èƒ½åŠ›å›¾è°±ç”Ÿæˆ', message: 'æ­£åœ¨ç”Ÿæˆä¸‰ç»´èƒ½åŠ›å›¾è°±...' },
                { id: 'weakness_analysis', name: 'è–„å¼±ç‚¹åˆ†æ', message: 'æ­£åœ¨åˆ†æçŸ¥è¯†è–„å¼±ç¯èŠ‚...' },
                { id: 'path_planning', name: 'å­¦ä¹ è·¯å¾„è§„åˆ’', message: 'æ­£åœ¨åˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’...' },
                { id: 'review_scheduling', name: 'å¤ä¹ è®¡åˆ’å®‰æ’', message: 'æ­£åœ¨ç”ŸæˆæŠ—é—å¿˜å¤ä¹ è®¡åˆ’...' }
            ];
            
            let currentStage = 0;
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            function updateProgress() {
                const stage = stages[currentStage];
                const progress = ((currentStage + 1) / stages.length) * 100;
                
                // æ›´æ–°UI
                const messageElement = document.getElementById('current-stage-message');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (messageElement) {
                    messageElement.textContent = stage.message;
                }
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (progressText) {
                    progressText.textContent = `${Math.round(progress)}% å®Œæˆ`;
                }
                
                // æ›´æ–°å…·ä½“çŠ¶æ€
                updateStageDetails(stage.id);
                
                console.log(`ğŸ”„ ${stage.name}: ${stage.message}`);
            }
            
            // æ›´æ–°é˜¶æ®µè¯¦æƒ…
            function updateStageDetails(stageId) {
                const statusMap = {
                    'data_loading': { element: 'ability-map-status', text: 'ç­‰å¾…ä¸­...' },
                    'score_calculation': { element: 'ability-map-status', text: 'å‡†å¤‡ä¸­...' },
                    'ability_mapping': { element: 'ability-map-status', text: 'ç”Ÿæˆä¸­...' },
                    'weakness_analysis': { element: 'weakpoints-status', text: 'åˆ†æä¸­...' },
                    'path_planning': { element: 'learning-path-status', text: 'è§„åˆ’ä¸­...' },
                    'review_scheduling': { element: 'learning-path-status', text: 'å®‰æ’ä¸­...' }
                };
                
                const config = statusMap[stageId];
                if (config) {
                    const element = document.getElementById(config.element);
                    if (element) {
                        element.textContent = config.text;
                        element.className = 'text-sm analysis-stage active';
                    }
                }
                
                // æ ‡è®°å·²å®Œæˆé˜¶æ®µ
                markCompletedStages(stageId);
            }
            
            // æ ‡è®°å·²å®Œæˆé˜¶æ®µ
            function markCompletedStages(currentStageId) {
                const stages = ['ability_mapping', 'weakness_analysis', 'path_planning'];
                let foundCurrent = false;
                
                stages.forEach(stage => {
                    const elementId = stage.replace('_', '-') + '-status';
                    const element = document.getElementById(elementId);
                    if (element) {
                        if (foundCurrent) {
                            element.className = 'text-sm analysis-stage pending';
                        } else if (stage === currentStageId) {
                            element.className = 'text-sm analysis-stage active';
                            foundCurrent = true;
                        } else {
                            element.className = 'text-sm analysis-stage completed';
                            element.textContent = 'å·²å®Œæˆ';
                        }
                    }
                });
            }
            
            // å®Œæˆåˆ†æ
            function completeAnalysis() {
                console.log('âœ… åˆ†ææµç¨‹å®Œæˆ');
                
                const statusElement = document.getElementById('analysis-status');
                const successElement = document.getElementById('success-message');
                
                if (statusElement) statusElement.classList.add('hidden');
                if (successElement) successElement.classList.remove('hidden');
                
                // æ ‡è®°æ‰€æœ‰é˜¶æ®µå®Œæˆ
                markAllStagesCompleted();
                
                // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
                showSuccessAnimation();
            }
            
            // æ ‡è®°æ‰€æœ‰é˜¶æ®µå®Œæˆ
            function markAllStagesCompleted() {
                const elements = [
                    'ability-map-status',
                    'weakpoints-status', 
                    'learning-path-status'
                ];
                
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = 'å·²å®Œæˆ';
                        element.className = 'text-sm analysis-stage completed';
                    }
                });
            }
            
            // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
            function showSuccessAnimation() {
                const successIcon = document.createElement('div');
                successIcon.className = 'fixed inset-0 flex items-center justify-center z-50 pointer-events-none';
                successIcon.innerHTML = `
                    <div class="animate-bounce-in">
                        <div class="w-32 h-32 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center shadow-2xl">
                            <i class="fas fa-check text-white text-4xl"></i>
                        </div>
                    </div>
                `;
                document.body.appendChild(successIcon);
                
                setTimeout(() => {
                    successIcon.remove();
                }, 2000);
            }
            
            // å¼€å§‹æ¨¡æ‹Ÿè¿›åº¦
            updateProgress();
            
            const interval = setInterval(() => {
                currentStage++;
                
                if (currentStage >= stages.length) {
                    clearInterval(interval);
                    completeAnalysis();
                } else {
                    updateProgress();
                }
            }, 800);
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function showAnalysisResults() {
            document.getElementById('analysis-progress').classList.add('hidden');
            document.getElementById('analysis-content').classList.remove('hidden');
            
            // æ¸²æŸ“åˆ†æç»“æœ
            setTimeout(() => {
                initCharts();
                renderAllComponents();
            }, 100);
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            if (!checkECharts()) {
                return;
            }
            
            try {
                initOverallScoreChart();
                initAbilityRadarChart();
                console.log('âœ… æ‰€æœ‰å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (window.uiManager) {
                    window.uiManager.showMessage('å›¾è¡¨æ¸²æŸ“å¤±è´¥ï¼Œæ­£åœ¨å°è¯•ä¿®å¤...', 'warning');
                }
                
                // å°è¯•é‡æ–°åˆå§‹åŒ–
                setTimeout(initCharts, 1000);
            }
        }

        // æ£€æŸ¥EChartsåº“åŠ è½½
        function checkECharts() {
            if (typeof echarts === 'undefined') {
                console.error('âŒ EChartsåº“æœªæ­£ç¡®åŠ è½½');
                // é‡æ–°åŠ è½½ECharts
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js';
                script.onload = function() {
                    console.log('âœ… EChartsåº“é‡æ–°åŠ è½½æˆåŠŸ');
                    initCharts();
                };
                document.head.appendChild(script);
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–æ€»ä½“åˆ†æ•°å›¾è¡¨
        function initOverallScoreChart() {
            const score = analysisData.assessment?.overallScore || 
                         analysisData.assessment?.overall_score || 
                         analysisData.abilityAnalysis?.overallScore || 75;
            
            console.log('ğŸ¯ æ€»ä½“åˆ†æ•°:', score);
            
            const ring = document.getElementById('overall-score-ring');
            const scoreElement = document.getElementById('overall-score');
            const levelElement = document.getElementById('cefr-level');
            
            if (ring) {
                const circumference = 2 * Math.PI * 16;
                const offset = circumference - (score / 100) * circumference;
                
                ring.style.strokeDasharray = `${circumference} ${circumference}`;
                ring.style.strokeDashoffset = offset;
                
                // è®¾ç½®é¢œè‰²åŸºäºåˆ†æ•°
                let color = '#2962FF';
                if (score >= 90) color = '#10B981';
                else if (score >= 80) color = '#3B82F6';
                else if (score >= 70) color = '#F59E0B';
                else if (score >= 60) color = '#EF4444';
                
                ring.style.stroke = color;
            }
            
            if (scoreElement) {
                scoreElement.textContent = score;
            }
            
            if (levelElement) {
                levelElement.textContent = analysisData.assessment?.level || 
                                         analysisData.abilityAnalysis?.level || 
                                         getCEFRLevel(score);
            }
        }

        // åˆå§‹åŒ–èƒ½åŠ›é›·è¾¾å›¾
        function initAbilityRadarChart() {
            const chartDom = document.getElementById('ability-radar-chart');
            if (!chartDom) {
                console.error('âŒ é›·è¾¾å›¾å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ç¡®ä¿å®¹å™¨æœ‰é«˜åº¦
            chartDom.style.height = '400px';
            
            const chart = echarts.init(chartDom);
            
            // å¤šé‡è·¯å¾„è·å–èƒ½åŠ›å›¾è°±æ•°æ®
            let abilityMap = analysisData.abilityAnalysis?.abilityMap || 
                            analysisData.assessment?.abilityMap ||
                            analysisData.abilityMap;

            console.log('ğŸ“Š èƒ½åŠ›å›¾è°±æ•°æ®æº:', {
                fromAbilityAnalysis: !!analysisData.abilityAnalysis?.abilityMap,
                fromAssessment: !!analysisData.assessment?.abilityMap,
                direct: !!analysisData.abilityMap,
                final: !!abilityMap
            });

            // å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ•°æ®
            if (!abilityMap) {
                console.warn('âš ï¸ èƒ½åŠ›å›¾è°±æ•°æ®ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ•°æ®');
                abilityMap = {
                    dataPoints: [
                        { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: 75, weight: 0.25 },
                        { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: 68, weight: 0.25 },
                        { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: 82, weight: 0.25 },
                        { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: 71, weight: 0.25 }
                    ]
                };
                
                // ä¿å­˜åˆ°åˆ†ææ•°æ®ä¸­ï¼Œé¿å…åç»­å†æ¬¡æ‰¾ä¸åˆ°
                if (!analysisData.abilityAnalysis) analysisData.abilityAnalysis = {};
                analysisData.abilityAnalysis.abilityMap = abilityMap;
            }

            // ç»Ÿä¸€æ•°æ®æ ¼å¼å¤„ç†
            let dataPoints = [];
            
            if (abilityMap.dataPoints && Array.isArray(abilityMap.dataPoints)) {
                dataPoints = abilityMap.dataPoints;
            } else if (abilityMap.data_points && Array.isArray(abilityMap.data_points)) {
                dataPoints = abilityMap.data_points;
            } else if (Array.isArray(abilityMap)) {
                dataPoints = abilityMap;
            } else {
                console.error('âŒ æ— æ³•è§£æèƒ½åŠ›å›¾è°±æ•°æ®æ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                dataPoints = [
                    { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: 75, weight: 0.25 },
                    { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: 68, weight: 0.25 },
                    { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: 82, weight: 0.25 },
                    { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: 71, weight: 0.25 }
                ];
            }

            console.log('ğŸ“ˆ å¤„ç†åçš„æ•°æ®ç‚¹:', dataPoints);

            // æ„å»ºé›·è¾¾å›¾æŒ‡æ ‡å’Œæ•°æ®
            const indicator = dataPoints.map(point => ({
                name: point.displayName || getDimensionDisplayName(point.dimension) || point.name || 'æœªçŸ¥ç»´åº¦',
                max: 100
            }));

            const values = dataPoints.map(point => {
                const score = point.score || point.value || point.percentage || 50;
                return Math.max(0, Math.min(100, score));
            });

            console.log('ğŸ¯ é›·è¾¾å›¾æ•°æ®:', { indicator, values });

            const option = {
                tooltip: {
                    trigger: 'item'
                },
                radar: {
                    indicator: indicator,
                    shape: 'circle',
                    splitNumber: 5,
                    radius: '65%'
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: values,
                        name: 'èƒ½åŠ›åˆ†å¸ƒ',
                        areaStyle: {
                            color: 'rgba(41, 98, 255, 0.4)'
                        },
                        lineStyle: {
                            color: '#2962FF',
                            width: 3
                        },
                        itemStyle: {
                            color: '#2962FF'
                        }
                    }]
                }]
            };

            chart.setOption(option);

            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', function() {
                chart.resize();
            });

            console.log('âœ… é›·è¾¾å›¾åˆå§‹åŒ–å®Œæˆ');
            
            return chart;
        }

        // ä¿®æ”¹æ¸²æŸ“é€»è¾‘ï¼Œå¢åŠ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        function renderAllComponents() {
            // å…ˆéªŒè¯å’Œä¿®å¤æ•°æ®
            if (!analysisData) {
                console.error('âŒ åˆ†ææ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ¸²æŸ“');
                showNoData();
                return;
            }
            
            if (!validateAndFixAnalysisData()) {
                console.error('âŒ æ•°æ®éªŒè¯å¤±è´¥ï¼Œæ— æ³•æ¸²æŸ“');
                showDataError();
                return;
            }
            
            // ç¡®ä¿å…³é”®æ•°æ®å­˜åœ¨
            ensureCriticalData();
            
            // æ¸²æŸ“å„ä¸ªç»„ä»¶
            renderAIAnalysisSource();
            renderRecommendations();
            renderWeakPoints();
            renderKnowledgeWeights();
            renderLearningPathOverview();
            renderLearningPathTimeline();
            renderReviewSchedule();
            renderLearningStats();
            updateAssessmentDate();
            
            console.log('ğŸ‰ æ‰€æœ‰ç»„ä»¶æ¸²æŸ“å®Œæˆ');
        }

        // æ–°å¢ï¼šç¡®ä¿å…³é”®æ•°æ®å­˜åœ¨
        function ensureCriticalData() {
            // ç¡®ä¿abilityMapå­˜åœ¨
            if (!analysisData.abilityMap && analysisData.abilityAnalysis?.abilityMap) {
                analysisData.abilityMap = analysisData.abilityAnalysis.abilityMap;
            }
            
            if (!analysisData.abilityMap) {
                console.warn('âš ï¸ è‡ªåŠ¨ç”ŸæˆabilityMapæ•°æ®');
                analysisData.abilityMap = {
                    dataPoints: [
                        { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: 75, weight: 0.25 },
                        { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: 68, weight: 0.25 },
                        { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: 82, weight: 0.25 },
                        { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: 71, weight: 0.25 }
                    ]
                };
            }
            
            // ç¡®ä¿weakPointså­˜åœ¨
            if (!analysisData.weakPoints && analysisData.abilityAnalysis?.weakPoints) {
                analysisData.weakPoints = analysisData.abilityAnalysis.weakPoints;
            }
            
            if (!analysisData.weakPoints) {
                analysisData.weakPoints = [];
            }
            
            // ç¡®ä¿learningPathå­˜åœ¨
            if (!analysisData.learningPath) {
                analysisData.learningPath = {
                    duration: "4å‘¨",
                    focusAreas: ['ç»¼åˆèƒ½åŠ›æå‡'],
                    expectedImprovement: "+15-20åˆ†",
                    description: "åŸºäºæ‚¨çš„èƒ½åŠ›è¯„ä¼°ç»“æœï¼Œæ™ºæ™®AIä¸ºæ‚¨ç”Ÿæˆäº†ä¸ªæ€§åŒ–çš„å­¦ä¹ è·¯å¾„"
                };
            }
        }

        // æ•°æ®éªŒè¯å’Œä¿®å¤å‡½æ•°
        function validateAndFixAnalysisData() {
            console.log('ğŸ” éªŒè¯åˆ†ææ•°æ®...', analysisData);
            
            if (!analysisData) {
                console.error('âŒ åˆ†ææ•°æ®ä¸ºç©º');
                return false;
            }
            
            // ç¡®ä¿å¿…è¦çš„æ•°æ®ç»“æ„å­˜åœ¨
            if (!analysisData.assessment) {
                analysisData.assessment = {
                    overallScore: 75,
                    level: 'B1',
                    examType: 'CET4',
                    testDate: new Date().toISOString()
                };
            }
            
            if (!analysisData.abilityAnalysis) {
                analysisData.abilityAnalysis = {
                    overallScore: analysisData.assessment.overallScore || 75,
                    level: analysisData.assessment.level || 'B1'
                };
            }
            
            // ç¡®ä¿èƒ½åŠ›å›¾è°±æ•°æ®å­˜åœ¨
            if (!analysisData.abilityMap && !analysisData.assessment.abilityMap) {
                analysisData.abilityMap = {
                    dataPoints: [
                        { dimension: 'vocabulary', displayName: 'è¯æ±‡èƒ½åŠ›', score: 75, weight: 0.25 },
                        { dimension: 'grammar', displayName: 'è¯­æ³•èƒ½åŠ›', score: 68, weight: 0.25 },
                        { dimension: 'reading', displayName: 'é˜…è¯»ç†è§£', score: 82, weight: 0.25 },
                        { dimension: 'translation', displayName: 'ç¿»è¯‘èƒ½åŠ›', score: 71, weight: 0.25 }
                    ]
                };
            }
            
            // ç¡®ä¿è–„å¼±ç‚¹æ•°æ®å­˜åœ¨
            if (!analysisData.weakPoints && !analysisData.abilityAnalysis.weakPoints) {
                analysisData.weakPoints = [];
            }
            
            // ç¡®ä¿å­¦ä¹ è·¯å¾„æ•°æ®å­˜åœ¨
            if (!analysisData.learningPath) {
                analysisData.learningPath = {
                    duration: "4å‘¨",
                    focusAreas: ['è¯­æ³•', 'è¯æ±‡'],
                    expectedImprovement: "+15-20åˆ†",
                    weeklyPlans: [
                        {
                            week: 1,
                            focus: 'åŸºç¡€å·©å›º',
                            focusAreas: ['è¯­æ³•', 'è¯æ±‡'],
                            dailyTasks: Array.from({ length: 7 }, (_, i) => ({
                                day: i + 1,
                                tasks: [
                                    { type: 'grammar', duration: 30, content: 'è¯­æ³•ä¸“é¡¹ç»ƒä¹ ' },
                                    { type: 'vocabulary', duration: 25, content: 'è¯æ±‡è®°å¿†è®­ç»ƒ' }
                                ]
                            })),
                            weeklyGoals: ['æŒæ¡åŸºç¡€è¯­æ³•', 'ç§¯ç´¯æ ¸å¿ƒè¯æ±‡']
                        }
                    ]
                };
            }
            
            console.log('âœ… æ•°æ®éªŒè¯å®Œæˆ');
            return true;
        }

        // æ¸²æŸ“AIåˆ†ææ¥æº
        function renderAIAnalysisSource() {
            const abilitySource = document.getElementById('ability-map-source');
            const weakPointsSource = document.getElementById('weak-points-source');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºAIå¢å¼ºåˆ†æ
            const isAIEnhanced = analysisData.metadata?.aiEnhanced || 
                                analysisData.abilityAnalysis?.analysisSource?.abilityMap === 'zhipu_ai';
            
            if (isAIEnhanced) {
                if (abilitySource) {
                    abilitySource.innerHTML = `
                        <span class="flex items-center">
                            <i class="fas fa-robot mr-1"></i>
                            æ™ºæ™®AI
                        </span>
                    `;
                    abilitySource.className = 'px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded text-xs font-medium';
                }
                
                if (weakPointsSource) {
                    weakPointsSource.innerHTML = `
                        <span class="flex items-center">
                            <i class="fas fa-robot mr-1"></i>
                            æ™ºæ™®AI
                        </span>
                    `;
                    weakPointsSource.className = 'px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded text-xs font-medium';
                }
                
                // åœ¨åˆ†æé¡µé¢é¡¶éƒ¨æ·»åŠ AIåˆ†æè¯´æ˜
                addAIAnalysisDescription();
            } else {
                // åŸæœ‰é€»è¾‘
                if (abilitySource) {
                    abilitySource.textContent = 'æ™ºæ™®AI';
                    abilitySource.className = 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium';
                }
                if (weakPointsSource) {
                    weakPointsSource.textContent = 'æ™ºæ™®AI';
                    weakPointsSource.className = 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium';
                }
            }
        }

        // æ·»åŠ AIåˆ†æè¯´æ˜
        function addAIAnalysisDescription() {
            const overviewSection = document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-12.gap-6.mb-8');
            if (!overviewSection) return;
            
            const aiDescription = document.createElement('div');
            aiDescription.className = 'ability-card rounded-lg p-6 lg:col-span-12 mt-4';
            aiDescription.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-4">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">æ™ºæ™®AIæ·±åº¦åˆ†ææŠ¥å‘Š</h3>
                            <p class="text-gray-600">åŸºäºGLM-4å¤§æ¨¡å‹çš„ä¸“ä¸šèƒ½åŠ›è¯„ä¼°</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">åˆ†ææ—¶é—´</div>
                        <div class="text-sm font-semibold text-gray-900">${new Date().toLocaleString()}</div>
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="font-semibold text-blue-700">åˆ†ææ¨¡å‹</div>
                        <div>GLM-4</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="font-semibold text-green-700">åˆ†æç»´åº¦</div>
                        <div>4ç»´èƒ½åŠ›</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="font-semibold text-purple-700">ç½®ä¿¡åº¦</div>
                        <div>85%</div>
                    </div>
                    <div class="text-center p-3 bg-orange-50 rounded-lg">
                        <div class="font-semibold text-orange-700">ä¸ªæ€§åŒ–</div>
                        <div>é«˜åº¦å®šåˆ¶</div>
                    </div>
                </div>
            `;
            
            overviewSection.parentNode.insertBefore(aiDescription, overviewSection.nextSibling);
        }

        // æ¸²æŸ“å»ºè®®
        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');
            if (!container) return;
            
            const recommendations = analysisData.recommendations || [];
            
            console.log('ğŸ’¡ æ¸²æŸ“å»ºè®®:', recommendations);

            if (recommendations.length === 0) {
                // å¦‚æœæ²¡æœ‰å»ºè®®ï¼Œç”Ÿæˆé»˜è®¤å»ºè®®
                const defaultRecommendations = [
                    {
                        message: 'åšæŒæ¯æ—¥å­¦ä¹ ï¼Œå»ºç«‹è‰¯å¥½çš„å­¦ä¹ ä¹ æƒ¯',
                        actions: ['æ¯æ—¥æ‰“å¡', 'å®šæ—¶å¤ä¹ ']
                    },
                    {
                        message: 'é‡ç‚¹å…³æ³¨è–„å¼±ç¯èŠ‚ï¼Œè¿›è¡Œä¸“é¡¹ç»ƒä¹ ',
                        actions: ['é”™é¢˜æ•´ç†', 'ä¸“é¡¹è®­ç»ƒ']
                    }
                ];
                
                renderRecommendationsList(defaultRecommendations, container);
                return;
            }

            renderRecommendationsList(recommendations, container);
        }

        // æ¸²æŸ“å»ºè®®åˆ—è¡¨
        function renderRecommendationsList(recommendations, container) {
            let html = '';
            recommendations.forEach((rec, index) => {
                // æ”¯æŒå¤šç§æ•°æ®æ ¼å¼
                const message = rec.message || rec.title || rec.description || 'å­¦ä¹ å»ºè®®';
                const actions = rec.actions || rec.recommendedActions || [];
                
                html += `
                    <div class="p-3 border border-gray-200 rounded-lg ability-card fade-in">
                        <div class="flex items-start">
                            <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm mr-3 flex-shrink-0">
                                ${index + 1}
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">${message}</p>
                                ${actions.length > 0 ? `
                                    <div class="mt-2 flex flex-wrap gap-1">
                                        ${actions.map(action => `
                                            <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${action}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ¸²æŸ“è–„å¼±ç‚¹
        function renderWeakPoints() {
            const container = document.getElementById('weak-points-analysis');
            const countElement = document.getElementById('weakness-count');
            
            if (!container) return;
            
            const weakPoints = analysisData.weakPoints || 
                              analysisData.abilityAnalysis?.weakPoints || [];
            
            console.log('ğŸ”´ è–„å¼±ç‚¹æ•°æ®:', weakPoints);

            if (countElement) {
                countElement.textContent = `${weakPoints.length}ä¸ªè–„å¼±ç‚¹`;
            }

            if (weakPoints.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-3xl text-green-500 mb-3"></i>
                        <p class="text-gray-600">æ­å–œï¼æœªå‘ç°æ˜æ˜¾è–„å¼±ç¯èŠ‚</p>
                    </div>
                `;
                return;
            }

            let html = '';
            weakPoints.forEach(point => {
                const priorityColors = {
                    high: 'bg-red-100 text-red-800 border-red-200',
                    medium: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    low: 'bg-blue-100 text-blue-800 border-blue-200'
                };

                // æ”¯æŒå¤šç§æ•°æ®æ ¼å¼
                const dimension = point.dimension || 'general';
                const displayName = point.displayName || getDimensionDisplayName(dimension);
                const score = point.score || point.percentage || 60;
                const priority = point.priority || 'medium';
                const recommendedActions = point.recommendedActions || point.actions || [];

                html += `
                    <div class="p-4 border rounded-lg ${priorityColors[priority]} weakness-tag fade-in">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold">${displayName}</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                priority === 'high' ? 'bg-red-200 text-red-900' :
                                priority === 'medium' ? 'bg-yellow-200 text-yellow-900' :
                                'bg-blue-200 text-blue-900'
                            }">
                                ${priority === 'high' ? 'é«˜ä¼˜å…ˆçº§' : priority === 'medium' ? 'ä¸­ä¼˜å…ˆçº§' : 'ä½ä¼˜å…ˆçº§'}
                            </span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm">èƒ½åŠ›å¾—åˆ†</span>
                            <span class="font-bold">${score}/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${
                                priority === 'high' ? 'bg-red-500' :
                                priority === 'medium' ? 'bg-yellow-500' :
                                'bg-blue-500'
                            }" style="width: ${score}%"></div>
                        </div>
                        ${recommendedActions.length > 0 ? `
                            <div class="mt-3">
                                <p class="text-sm font-medium mb-1">å»ºè®®è¡ŒåŠ¨:</p>
                                <div class="flex flex-wrap gap-1">
                                    ${recommendedActions.map(action => `
                                        <span class="px-2 py-1 bg-white bg-opacity-50 rounded text-xs">${action}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ¸²æŸ“çŸ¥è¯†ç‚¹æƒé‡
        function renderKnowledgeWeights() {
            const container = document.getElementById('knowledge-weights');
            const abilityMap = analysisData.abilityMap || analysisData.assessment.ability_map;
            
            if (!abilityMap) return;

            let html = '';
            abilityMap.dataPoints.forEach(point => {
                const weightPercent = Math.round((point.weight || 0.1) * 100);
                html += `
                    <div class="text-center p-3 bg-white rounded-lg border fade-in">
                        <div class="text-sm font-medium text-gray-700 mb-1">${getDimensionDisplayName(point.dimension)}</div>
                        <div class="text-lg font-bold text-primary">${weightPercent}%</div>
                        <div class="text-xs text-gray-500">è€ƒè¯•æƒé‡</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ¸²æŸ“å­¦ä¹ è·¯å¾„æ¦‚è§ˆ
        function renderLearningPathOverview() {
            if (!learningPath) {
                learningPath = analysisData.learningPath || 
                              analysisData.abilityAnalysis?.learningPath;
            }
            
            if (!learningPath) return;

            console.log('ğŸ›£ï¸ å­¦ä¹ è·¯å¾„æ•°æ®:', learningPath);

            document.getElementById('path-duration').textContent = learningPath.duration || '4å‘¨';
            
            const focusAreas = learningPath.focusAreas || 
                              (learningPath.weeklyPlans && learningPath.weeklyPlans[0]?.focusAreas) || 
                              ['ç»¼åˆèƒ½åŠ›'];
            document.getElementById('focus-areas').textContent = Array.isArray(focusAreas) ? 
                focusAreas.join('ã€') : focusAreas;

            document.getElementById('expected-improvement').textContent = '+15-20åˆ†';

            if (learningPath.description) {
                document.getElementById('path-description').textContent = learningPath.description;
            }
        }

        // æ–°å¢ï¼šæ¸²æŸ“å­¦ä¹ ç»Ÿè®¡
        function renderLearningStats() {
            const detailedPlan = analysisData.detailedLearningPlan;
            const reviewPlan = analysisData.reviewPlan;
            
            if (detailedPlan) {
                document.getElementById('total-tasks').textContent = detailedPlan.totalTasks || 0;
                document.getElementById('completed-tasks').textContent = detailedPlan.completedTasks || 0;
                document.getElementById('plan-duration').textContent = detailedPlan.duration || '4å‘¨';
                
                // è®¡ç®—å®Œæˆåº¦
                const completion = detailedPlan.totalTasks > 0 ? 
                    Math.round((detailedPlan.completedTasks / detailedPlan.totalTasks) * 100) : 0;
                document.getElementById('plan-completion').textContent = completion + '%';
                document.getElementById('completion-progress').style.width = completion + '%';
            }
            
            if (reviewPlan) {
                const pendingReviews = reviewPlan.schedule ? 
                    reviewPlan.schedule.filter(item => item.status === 'pending').length : 0;
                document.getElementById('pending-reviews').textContent = pendingReviews + 'ä¸ª';
                document.getElementById('review-count').textContent = reviewPlan.totalReviews + 'ä¸ªå¤ä¹ ';
            }
            
            // è®¡ç®—å­¦ä¹ ç»Ÿè®¡
            const totalStudyTime = calculateTotalStudyTime();
            document.getElementById('total-study-time').textContent = totalStudyTime + 'åˆ†é’Ÿ';
            document.getElementById('study-days').textContent = '28'; // 4å‘¨
            document.getElementById('efficiency-score').textContent = '85'; // æ¨¡æ‹Ÿæ•ˆç‡è¯„åˆ†
        }

        // æ–°å¢ï¼šè®¡ç®—æ€»å­¦ä¹ æ—¶é—´
        function calculateTotalStudyTime() {
            const detailedPlan = analysisData.detailedLearningPlan;
            let totalTime = 0;
            
            if (detailedPlan && detailedPlan.weeklyPlans) {
                detailedPlan.weeklyPlans.forEach(week => {
                    week.dailyTasks.forEach(day => {
                        day.tasks.forEach(task => {
                            totalTime += task.duration || 0;
                        });
                    });
                });
            }
            
            return totalTime;
        }

        // ä¿®æ”¹ï¼šå¢å¼ºçš„ renderLearningPathTimeline å‡½æ•°
        function renderLearningPathTimeline() {
            const container = document.getElementById('learning-path-timeline');
            
            const detailedPlan = analysisData.detailedLearningPlan;
            
            if (!detailedPlan || !detailedPlan.weeklyPlans) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-plus text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">æš‚æ— è¯¦ç»†å­¦ä¹ è®¡åˆ’</p>
                        <button onclick="generateLearningPlan()" class="mt-3 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors text-sm">
                            ç”Ÿæˆå­¦ä¹ è®¡åˆ’
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            detailedPlan.weeklyPlans.forEach(week => {
                const completedDays = week.dailyTasks.filter(day => day.completed).length;
                const progressPercent = Math.round((completedDays / 7) * 100);
                
                html += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-900">ç¬¬${week.week}å‘¨ Â· ${week.focus}</h4>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                                ${progressPercent}% å®Œæˆ
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>æœ¬å‘¨è¿›åº¦</span>
                                <span>${completedDays}/7 å¤©</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <p class="text-sm text-gray-600 mb-2">
                                <i class="fas fa-bullseye mr-1 text-primary"></i>
                                é‡ç‚¹: ${week.focusAreas.join(', ')}
                            </p>
                        </div>
                        
                        <div class="flex gap-2 mb-3">
                            ${week.dailyTasks.slice(0, 3).map(day => `
                                <div class="flex-1 text-center p-2 bg-gray-50 rounded border cursor-pointer hover:bg-blue-50 transition-colors ${day.completed ? 'bg-green-50 border-green-200' : ''}"
                                     onclick="showDayDetails(${week.week}, ${day.day})">
                                    <div class="text-sm font-medium ${day.completed ? 'text-green-700' : 'text-gray-900'}">ç¬¬${day.day}å¤©</div>
                                    <div class="text-xs text-gray-500">${calculateDailyTime(day.tasks)}åˆ†é’Ÿ</div>
                                    ${day.completed ? '<i class="fas fa-check text-green-500 text-xs mt-1"></i>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        ${week.dailyTasks.length > 3 ? `
                            <button onclick="expandWeek(${week.week})" class="w-full py-2 text-sm text-gray-600 hover:text-primary transition-colors border-t border-gray-100">
                                <i class="fas fa-chevron-down mr-1"></i>
                                æŸ¥çœ‹å‰©ä½™${week.dailyTasks.length - 3}å¤©
                            </button>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ–°å¢ï¼šè®¡ç®—æ¯æ—¥å­¦ä¹ æ—¶é—´
        function calculateDailyTime(tasks) {
            return tasks.reduce((total, task) => total + (task.duration || 0), 0);
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºæ¯æ—¥è¯¦æƒ…
        function showDayDetails(week, day) {
            const detailedPlan = analysisData.detailedLearningPlan;
            const weekPlan = detailedPlan.weeklyPlans.find(w => w.week === week);
            const dayPlan = weekPlan.dailyTasks.find(d => d.day === day);
            
            if (dayPlan && window.uiManager) {
                const taskList = dayPlan.tasks.map(task => 
                    `â€¢ ${task.content} (${task.duration}åˆ†é’Ÿ)`
                ).join('\n');
                
                const message = `ç¬¬${week}å‘¨ ç¬¬${day}å¤©å­¦ä¹ è®¡åˆ’:\n\n${taskList}\n\næ€»æ—¶é•¿: ${calculateDailyTime(dayPlan.tasks)}åˆ†é’Ÿ`;
                
                window.uiManager.showLearningConfirmation(
                    message,
                    'å¼€å§‹å­¦ä¹ ',
                    'ç¨åå†è¯´'
                ).then((confirmed) => {
                    if (confirmed) {
                        // æ ‡è®°ä¸ºå·²å®Œæˆ
                        dayPlan.completed = true;
                        // æ›´æ–°å®Œæˆç»Ÿè®¡
                        analysisData.detailedLearningPlan.completedTasks++;
                        // é‡æ–°æ¸²æŸ“
                        renderLearningPathTimeline();
                        renderLearningStats();
                        
                        window.uiManager.showMessage('å­¦ä¹ ä»»åŠ¡å·²å®Œæˆï¼', 'success');
                    }
                });
            }
        }

        // ä¿®æ”¹ï¼šå¢å¼ºçš„ renderReviewSchedule å‡½æ•°
        function renderReviewSchedule() {
            const container = document.getElementById('review-schedule');
            const reviewPlan = analysisData.reviewPlan;
            
            if (!reviewPlan || !reviewPlan.schedule) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-brain text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">æš‚æ— å¤ä¹ è®¡åˆ’</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedSchedule = [...reviewPlan.schedule].sort((a, b) => 
                new Date(a.dueDate) - new Date(b.dueDate)
            );

            let html = '';
            sortedSchedule.forEach((review, index) => {
                if (index >= 10) return; // åªæ˜¾ç¤ºå‰10ä¸ª
                
                const dueDate = new Date(review.dueDate);
                const today = new Date();
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let statusConfig = {
                    color: 'bg-gray-100 text-gray-800',
                    text: 'å¾…å¤ä¹ ',
                    icon: 'clock'
                };
                
                if (review.status === 'completed') {
                    statusConfig = {
                        color: 'bg-green-100 text-green-800',
                        text: 'å·²å®Œæˆ',
                        icon: 'check'
                    };
                } else if (daysUntilDue <= 0) {
                    statusConfig = {
                        color: 'bg-red-100 text-red-800',
                        text: 'é€¾æœŸ',
                        icon: 'exclamation-triangle'
                    };
                } else if (daysUntilDue <= 2) {
                    statusConfig = {
                        color: 'bg-orange-100 text-orange-800',
                        text: 'å³å°†åˆ°æœŸ',
                        icon: 'exclamation-circle'
                    };
                }
                
                html += `
                    <div class="p-3 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors cursor-pointer"
                         onclick="startReview('${review.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900 text-sm">${review.knowledgePoint}</h4>
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusConfig.color}">
                                <i class="fas fa-${statusConfig.icon} mr-1"></i>
                                ${statusConfig.text}
                            </span>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs text-gray-600 mb-2">
                            <span>å¤ä¹ ç±»å‹: ${review.reviewType}</span>
                            <span>${review.estimatedTime}åˆ†é’Ÿ</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs ${daysUntilDue <= 0 ? 'text-red-600' : daysUntilDue <= 2 ? 'text-orange-600' : 'text-gray-500'}">
                                <i class="far fa-calendar mr-1"></i>
                                ${dueDate.toLocaleDateString()}
                                ${daysUntilDue > 0 ? `(${daysUntilDue}å¤©å)` : '(å·²é€¾æœŸ)'}
                            </span>
                            <div class="flex gap-1">
                                ${review.materials.slice(0, 2).map(material => `
                                    <span class="px-1 py-0.5 bg-blue-50 text-blue-700 rounded text-xs">${material}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ–°å¢ï¼šå¼€å§‹å¤ä¹ 
        function startReview(reviewId) {
            const reviewPlan = analysisData.reviewPlan;
            const review = reviewPlan.schedule.find(r => r.id === reviewId);
            
            if (review && window.uiManager) {
                const materials = review.materials.join('ã€');
                const message = `å¼€å§‹å¤ä¹ : ${review.knowledgePoint}\n\nå¤ä¹ å†…å®¹: ${materials}\né¢„è®¡æ—¶é—´: ${review.estimatedTime}åˆ†é’Ÿ`;
                
                window.uiManager.showLearningConfirmation(
                    message,
                    'å¼€å§‹å¤ä¹ ',
                    'ç¨åå¤ä¹ '
                ).then((confirmed) => {
                    if (confirmed) {
                        // æ ‡è®°ä¸ºå·²å®Œæˆ
                        review.status = 'completed';
                        // æ›´æ–°å®Œæˆç»Ÿè®¡
                        analysisData.reviewPlan.completedReviews++;
                        // é‡æ–°æ¸²æŸ“
                        renderReviewSchedule();
                        renderLearningStats();
                        
                        window.uiManager.showMessage('å¤ä¹ ä»»åŠ¡å·²å®Œæˆï¼', 'success');
                    }
                });
            }
        }

        // æ›´æ–°è¯„ä¼°æ—¥æœŸ
        function updateAssessmentDate() {
            const lastAssessment = localStorage.getItem('last_assessment_data');
            if (lastAssessment) {
                const data = JSON.parse(lastAssessment);
                const date = new Date(data.timestamp);
                document.getElementById('assessment-date').textContent = 
                    `è¯„ä¼°æ—¥æœŸ: ${date.toLocaleDateString()}`;
            }
        }

        // è°ƒæ•´å­¦ä¹ è·¯å¾„
        function adjustLearningPath() {
            if (window.uiManager) {
                window.uiManager.showLearningConfirmation(
                    'ç¡®å®šè¦è°ƒæ•´å­¦ä¹ è·¯å¾„å—ï¼Ÿç³»ç»Ÿå°†åŸºäºæ‚¨çš„æœ€æ–°è¿›åº¦é‡æ–°è§„åˆ’å­¦ä¹ å†…å®¹ã€‚',
                    'é‡æ–°è§„åˆ’',
                    'å–æ¶ˆ'
                ).then((confirmed) => {
                    if (confirmed) {
                        // è°ƒç”¨APIé‡æ–°ç”Ÿæˆå­¦ä¹ è·¯å¾„
                        regenerateLearningPath();
                    }
                });
            }
        }

        // é‡æ–°ç”Ÿæˆå­¦ä¹ è·¯å¾„
        async function regenerateLearningPath() {
            if (window.uiManager) {
                window.uiManager.showLearningProgress('æ­£åœ¨é‡æ–°è§„åˆ’å­¦ä¹ è·¯å¾„...');
            }

            try {
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                setTimeout(() => {
                    if (window.uiManager) {
                        window.uiManager.hideLearningProgress();
                        window.uiManager.showMessage('å­¦ä¹ è·¯å¾„å·²æ›´æ–°', 'success');
                    }
                    
                    // é‡æ–°æ¸²æŸ“å­¦ä¹ è·¯å¾„
                    renderLearningPathOverview();
                    renderLearningPathTimeline();
                }, 2000);
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå­¦ä¹ è·¯å¾„å¤±è´¥:', error);
                if (window.uiManager) {
                    window.uiManager.hideLearningProgress();
                    window.uiManager.showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        // æ–°å¢ï¼šå¼€å§‹å­¦ä¹ å‡½æ•°
        function startLearning() {
            if (window.uiManager) {
                window.uiManager.showLearningConfirmation(
                    'å‡†å¤‡å¥½å¼€å§‹æ‚¨çš„ä¸ªæ€§åŒ–å­¦ä¹ ä¹‹æ—…äº†å—ï¼Ÿ\n\nç³»ç»Ÿå°†æ ¹æ®æ‚¨çš„å­¦ä¹ è®¡åˆ’å¼•å¯¼æ‚¨å®Œæˆæ¯æ—¥ä»»åŠ¡ã€‚',
                    'å¼€å§‹å­¦ä¹ ',
                    'ç¨åå¼€å§‹'
                ).then((confirmed) => {
                    if (confirmed) {
                        window.location.href = 'äº‘æ¢¦æ™ºé—´å­¦ä¹ .html';
                    }
                });
            }
        }

        // æ–°å¢ï¼šæ•°æ®æ˜¾ç¤ºé”™è¯¯
        function showDataError() {
            const container = document.querySelector('.max-w-7xl');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-12 text-center max-w-2xl mx-auto">
                    <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 text-3xl mx-auto mb-6">
                        <i class="fas fa-database"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">æ•°æ®åŠ è½½å¼‚å¸¸</h2>
                    <p class="text-gray-600 mb-6">åˆ†ææ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œæ­£åœ¨å°è¯•ä¿®å¤...</p>
                    <div class="flex gap-4 justify-center">
                        <button onclick="location.reload()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            é‡æ–°åŠ è½½
                        </button>
                        <button onclick="useFallbackData()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            ä½¿ç”¨ç¤ºä¾‹æ•°æ®
                        </button>
                    </div>
                </div>
            `;
        }

        // æ–°å¢ï¼šä½¿ç”¨å¤‡ç”¨æ•°æ®
        function useFallbackData() {
            analysisData = generateFallbackData();
            document.getElementById('analysis-progress').classList.add('hidden');
            document.getElementById('analysis-content').classList.remove('hidden');
            renderAllComponents();
        }

        // å·¥å…·å‡½æ•°
        function getCEFRLevel(score) {
            if (score >= 90) return 'C2';
            if (score >= 80) return 'C1';
            if (score >= 70) return 'B2';
            if (score >= 60) return 'B1';
            if (score >= 50) return 'A2';
            return 'A1';
        }

        function getDimensionDisplayName(dimension) {
            const names = {
                vocabulary: 'è¯æ±‡èƒ½åŠ›',
                grammar: 'è¯­æ³•èƒ½åŠ›', 
                reading: 'é˜…è¯»ç†è§£',
                listening: 'å¬åŠ›ç†è§£',
                speaking: 'å£è¯­è¡¨è¾¾',
                writing: 'å†™ä½œèƒ½åŠ›',
                pronunciation: 'å‘éŸ³å‡†ç¡®',
                comprehension: 'ç»¼åˆç†è§£',
                fluency: 'è¯­è¨€æµåˆ©'
            };
            return names[dimension] || dimension;
        }

        // åˆ‡æ¢é›·è¾¾å›¾è§†å›¾
        function toggleRadarView() {
            currentRadarView = currentRadarView === 'standard' ? 'weighted' : 'standard';
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸åŒè§†å›¾çš„é€»è¾‘
            if (window.uiManager) {
                window.uiManager.showMessage(`å·²åˆ‡æ¢åˆ°${currentRadarView === 'standard' ? 'æ ‡å‡†' : 'åŠ æƒ'}è§†å›¾`, 'info');
            }
        }

        // æ˜¾ç¤ºæ— æ•°æ®
        function showNoData() {
            const container = document.querySelector('.max-w-7xl');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-12 text-center max-w-2xl mx-auto">
                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-3xl mx-auto mb-6">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">æš‚æ— å­¦ä¹ æ•°æ®</h2>
                    <p class="text-gray-600 mb-6">å®Œæˆèƒ½åŠ›è¯„ä¼°æµ‹è¯•åï¼Œå³å¯æŸ¥çœ‹è¯¦ç»†çš„å­¦ä¹ åˆ†ææŠ¥å‘Š</p>
                    <div class="flex gap-4 justify-center">
                        <a href="äº‘æ¢¦æ™ºé—´æµ‹è¯•.html" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            å¼€å§‹èƒ½åŠ›è¯„ä¼°
                        </a>
                        <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            è¿”å›é¦–é¡µ
                        </a>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showErrorState(error) {
            const container = document.querySelector('.max-w-7xl');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-12 text-center max-w-2xl mx-auto">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center text-red-600 text-3xl mx-auto mb-6">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">åŠ è½½å¤±è´¥</h2>
                    <p class="text-gray-600 mb-4">æŠ±æ­‰ï¼ŒåŠ è½½åˆ†ææ•°æ®æ—¶é‡åˆ°é—®é¢˜</p>
                    <p class="text-sm text-gray-500 mb-6">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    <div class="flex gap-4 justify-center">
                        <button onclick="location.reload()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            é‡è¯•
                        </button>
                        <a href="äº‘æ¢¦æ™ºé—´é¦–é¡µ.html" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            è¿”å›é¦–é¡µ
                        </a>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>